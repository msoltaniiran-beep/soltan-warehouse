<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù† - Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Vazir', 'IRANSans', Tahoma, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    body { background: #f9fafb; padding: 12px; }
    .card { background: white; border-radius: 12px; padding: 16px; margin: 12px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    input, select, textarea, button {
      width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ccc;
      border-radius: 8px; font-size: 16px; text-align: right;
    }
    input[readonly] { background-color: #f5f5f5; }
    input[type="number"] { direction: ltr; text-align: right; }
    button { background: #2e7d32; color: white; border: none; font-weight: bold; cursor: pointer; }
    button.scan { background: #1976d2; }
    button.secondary { background: #757575; }
    button.danger { background: #c62828; }
    button:disabled { background: #cccccc; cursor: not-allowed; }
    .hidden { display: none; }
    .loading { opacity: 0.7; pointer-events: none; }
    .table-container {
      overflow-x: auto;
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: right; }
    .table th { background: #e8f5e9; position: sticky; top: 0; }
    .table thead tr:nth-child(2) th { background: #f1f8e9; padding: 4px; }
    .discrepancy { font-weight: bold; color: #c62828; }
    .duplicate { background-color: #ffebee !important; }
    .actions { text-align: center; white-space: nowrap; }
    .btn-icon { width: auto; padding: 5px 10px; font-size: 14px; margin: 2px; }
    h2, h3 { text-align: center; color: #2e7d32; margin-bottom: 12px; }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; }
    .toolbar > * { flex: 1; min-width: 160px; }
    .tabs { display: flex; gap: 6px; margin-bottom: 16px; }
    .tab-btn {
      flex: 1;
      padding: 10px 8px;
      background: #e9ecef;
      border: none;
      border-radius: 8px 8px 0 0;
      font-weight: bold;
      cursor: pointer;
      font-size: 15px;
    }
    .tab-btn.active { background: #2e7d32; color: white; }
    .tab-content { display: none; padding-top: 16px; border-top: 2px solid #2e7d32; }
    .tab-content.active { display: block; }
    .modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 95%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .modal.hidden { display: none; }
    .filter-input { width: 100% !important; font-size: 12px !important; padding: 4px 6px !important; }
    .custom-select-container {
      position: relative;
      width: 100%;
    }
    .custom-select-container input {
      padding-right: 36px;
    }
    .select-arrow {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: auto;
      cursor: pointer;
      color: #757575;
      font-size: 14px;
    }
    .custom-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #aaa;
      border-top: none;
      border-radius: 0 0 8px 8px;
      z-index: 10;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .custom-select-dropdown.hidden { display: none; }
    .custom-select-option {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }
    .custom-select-option:hover { background: #f0f8f0; }
    .custom-select-option:last-child { border-bottom: none; }
    #cameraVideo {
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      background: #000;
      display: block;
    }
    .scanner-frame {
      position: absolute;
      top: 25%;
      left: 10%;
      width: 80%;
      height: 50%;
      border: 3px solid #2196f3;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.6);
      pointer-events: none;
      border-radius: 4px;
    }
    .scan-hint {
      position: absolute;
      top: 8%;
      left: 0;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 16px;
      text-shadow: 0 1px 4px #000;
      padding: 0 20px;
      pointer-events: none;
    }
    .zoom-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 100;
    }
    .zoom-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255,255,255,0.85);
      border: none;
      font-size: 24px;
      font-weight: bold;
      color: #1976d2;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
      cursor: pointer;
    }
    .calc-btn { 
      background: #e0e0e0; 
      color: #333; 
      padding: 16px 0;
      margin: 4px;
      font-size: 22px;
      font-weight: bold;
      border-radius: 12px;
      border: 1px solid #bbb;
      width: 22%;
      height: 56px;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    .calc-display {
      width: 100%;
      padding: 16px;
      margin: 8px 0;
      text-align: left;
      direction: ltr;
      font-size: 22px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .calc-apply {
      background: #2e7d32 !important;
      width: 100% !important;
      padding: 18px !important;
      margin-top: 14px;
      font-size: 20px;
      border-radius: 10px;
    }
    .report-card { background: #fff8e1; border-left: 4px solid #ffa000; }
    .report-card h4 { color: #e65100; margin-bottom: 10px; }
    .location-display {
      width: 100%; padding: 12px; background: #f5f5f5; border-radius: 8px;
      font-weight: bold; color: #2e7d32; text-align: center; border: 1px solid #ddd;
    }
    .sync-status {
      position: fixed;
      top: 10px;
      left: 10px;
      background: #1976d2;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .sync-status.error { background: #c62828; }
    .sync-status.success { background: #2e7d32; }
  </style>
</head>
<body>
  <!-- ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ -->
  <div id="syncStatus" class="sync-status hidden">ğŸ”„</div>
  
  <div class="card">
    <h2>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù† - Ø¢Ù†Ù„Ø§ÛŒÙ†</h2>
    <div class="tabs" id="tabsContainer">
      <button class="tab-btn active" data-tab="main">Ø¹Ù…Ù„ÛŒØ§Øª</button>
      <button class="tab-btn" data-tab="reports">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´Ø§Øª</button>
      <button class="tab-btn" data-tab="settings">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </div>
    <div class="tab-content active" id="tab-main">
      <div id="scanButtonContainer" class="toolbar">
        <button onclick="startScan()" class="scan">ğŸ“¸ Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯</button>
        <div>
          <label>ğŸ“ Ù…Ø­Ù„:</label>
          <div class="location-display" id="globalLocationDisplay">Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ</div>
        </div>
        <button onclick="loadDataFromSheets()" class="secondary">ğŸ”„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯</button>
      </div>
      <input type="text" id="searchInput" placeholder="Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" autofocus />
      <button onclick="searchOrAdd()" id="searchBtn">ğŸ” Ø¬Ø³ØªØ¬Ùˆ / Ø§ÙØ²ÙˆØ¯Ù†</button>
    </div>
    <div class="tab-content" id="tab-reports">
      <h3>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§</h3>
      <div class="report-card">
        <h4>ğŸ”´ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´ Û± (ØºÛŒØ±ØµÙØ±)</h4>
        <div id="discrepancy1List" style="max-height:200px; overflow-y:auto;">
          <p style="text-align:center; color:#666;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
        </div>
      </div>
      <div class="report-card" style="margin-top:16px;">
        <h4>ğŸŸ  Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´ Û² (ØºÛŒØ±ØµÙØ±)</h4>
        <div id="discrepancy2List" style="max-height:200px; overflow-y:auto;">
          <p style="text-align:center; color:#666;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
        </div>
      </div>
      <button onclick="exportDiscrepancies()" style="width:100%; margin-top:16px; background:#d32f2f;">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ (Ø§Ú©Ø³Ù„)</button>
    </div>
    <div class="tab-content" id="tab-settings">
      <h3>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</h3>
      <label>ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±:</label>
      <input type="text" id="settingUserName" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§" />
      <label>ğŸ‘¥ Ù†Ø§Ù… ØªÛŒÙ… (Ù¾ÛŒØ´â€ŒÙØ±Ø¶):</label>
      <input type="text" id="settingTeamName" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÛŒÙ… Ø§Ù„Ù" />
      <label>ğŸ“ Ù…Ø­Ù„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª):</label>
      <div class="custom-select-container">
        <input type="text" id="settingDefaultLocation" placeholder="Ù…Ø­Ù„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" autocomplete="off" />
        <div class="custom-select-dropdown hidden" id="settingsLocationDropdown"></div>
        <span class="select-arrow" onclick="toggleLocationDropdown('settings')">â–¼</span>
      </div>
      <label>ğŸ”¢ Ø­Ø¯Ø§Ù‚Ù„ Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="number" id="settingMinLength" min="4" max="50" value="14" />
      <label>ğŸ”¢ Ø­Ø¯Ø§Ú©Ø«Ø± Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="number" id="settingMaxLength" min="4" max="50" value="20" />
      <label class="secondary" style="margin-top:16px;">
        <input type="checkbox" id="searchByTag" /> 
        ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÚ¯ (Ø¨Ù‡â€ŒØ¬Ø§ÛŒ Ø¨Ø§Ø±Ú©Ø¯)
      </label>
      <p style="font-size:13px; color:#555; margin-top:4px;">
        Ø¯Ø± Ø§ÛŒÙ† Ø­Ø§Ù„ØªØŒ ÙÛŒÙ„Ø¯ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ù‡ Â«ØªÚ¯Â» ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø¯Ú©Ù…Ù‡ Ø§Ø³Ú©Ù† Ù¾Ù†Ù‡Ø§Ù† Ù…ÛŒâ€ŒØ´ÙˆØ¯.
      </p>
      
      <h4 style="margin:20px 0 8px;">ğŸŒ Ø§ØªØµØ§Ù„ Google Sheets</h4>
      <label>ğŸ”— URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª:</label>
      <input type="text" id="apiUrl" placeholder="https://script.google.com/..." />
      <label>ğŸ—ƒï¸ ID ØµÙØ­Ù‡ Ú¯Ø³ØªØ±Ø¯Ù‡:</label>
      <input type="text" id="sheetId" placeholder="1A2B3C4D..." />
      <button onclick="testConnection()" style="width:100%; margin:8px 0; background:#1976d2;">ğŸ”— ØªØ³Øª Ø§ØªØµØ§Ù„</button>
      
      <h4 style="margin:20px 0 8px;">ğŸ—ƒï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡</h4>
      <input type="file" id="excelFile" accept=".xlsx,.xls" style="width:100%; margin:6px 0;" />
      <button onclick="importExcel()" style="width:100%; margin:6px 0;">ğŸ“¥ import Ø§Ú©Ø³Ù„</button>
      <button onclick="exportExcel()" style="width:100%; margin:6px 0; background:#1976d2;">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
      <button onclick="clearAll()" class="danger" style="width:100%; margin:6px 0;">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
      <button onclick="saveSettings()" style="margin-top:20px; width:100%;">âœ… Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </div>
  </div>
  
  <div class="card" id="mainTableCard">
    <h3>Ù„ÛŒØ³Øª Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (<span id="totalCount">0</span> Ù…ÙˆØ±Ø¯) <span id="loadingIndicator" class="hidden">ğŸ”„</span></h3>
    <input type="text" id="globalSearch" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù‡Ù…Ù‡ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§..." oninput="applyFilters()" style="margin-bottom:12px;" />
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Ø¨Ø§Ø±Ú©Ø¯</th>
            <th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th>
            <th>Ø´Ù…Ø§Ø±Ø´Û±</th>
            <th>Ù…ØºØ§ÛŒØ±ØªÛ±</th>
            <th>Ø´Ù…Ø§Ø±Ø´Û²</th>
            <th>Ù…ØºØ§ÛŒØ±ØªÛ²</th>
            <th>ØªÚ¯</th>
            <th>ØªÛŒÙ…</th>
            <th>Ù…Ø­Ù„</th>
            <th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th>
            <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
            <th>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</th>
            <th>Ú©Ø§Ø±Ø¨Ø±</th>
            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
          </tr>
          <tr id="filterRow"></tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="14" style="text-align:center;">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) -->
  <div id="cameraModal" class="modal hidden">
    <div style="position:relative; width:100vw; height:100vh;">
      <video id="cameraVideo" playsinline></video>
      <div class="scanner-frame"></div>
      <div class="scan-hint" id="scanHint">
        ğŸ” Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¯Ø± Ú†Ù‡Ø§Ø±Ú†ÙˆØ¨ Ø¢Ø¨ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.<br>
        <span id="hintZoom">ğŸ” Ø²ÙˆÙ…: Ã—1.0</span>
      </div>
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomOut()">â€“</button>
        <button class="zoom-btn" onclick="resetZoom()">â†º</button>
        <button class="zoom-btn" onclick="zoomIn()">+</button>
      </div>
    </div>
    <div style="padding:16px; text-align:center;">
      <button onclick="stopCamera()" class="danger" style="width:auto; padding:12px 24px; font-size:16px;">â¹ï¸ ØªÙˆÙ‚Ù Ø§Ø³Ú©Ù†</button>
    </div>
  </div>
  
  <div id="addModal" class="modal hidden">
    <div class="modal-content">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
      <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="text" id="addBarcode" readonly />
      <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
      <input type="text" id="addName" />
      <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
      <input type="number" id="addStock" step="0.01" readonly />
      <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
      <input type="number" id="addCount1" step="0.01" inputmode="numeric" pattern="[0-9.]*" oninput="updateDiscrepancyAdd()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="addDisc1" class="discrepancy">â€”</span></div>
      <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
      <input type="number" id="addCount2" step="0.01" inputmode="numeric" pattern="[0-9.]*" oninput="updateDiscrepancyAdd()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="addDisc2" class="discrepancy">â€”</span></div>
      <label>ØªÚ¯:</label>
      <input type="text" id="addTag" />
      <label>ØªÛŒÙ…:</label>
      <input type="text" id="addTeam" readonly />
      <label>Ù…Ø­Ù„:</label>
      <div class="custom-select-container">
        <input type="text" id="addLocation" autocomplete="off" />
        <div class="custom-select-dropdown hidden" id="addLocationDropdown"></div>
        <span class="select-arrow" onclick="toggleLocationDropdown('add')">â–¼</span>
      </div>
      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea id="addNotes" rows="2"></textarea>
      <div style="display:flex; gap:8px; margin-top:16px;">
        <button onclick="saveAdd()" style="flex:1;">âœ… Ø§ÙØ²ÙˆØ¯Ù†</button>
        <button onclick="closeAddModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
      </div>
    </div>
  </div>
  
  <div id="editModal" class="modal hidden">
    <div class="modal-content">
      <h3>ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù„Ø§</h3>
      <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="text" id="editBarcode" readonly />
      <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
      <input type="text" id="editName" />
      <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
      <input type="number" id="editStock" step="0.01" readonly />
      <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
      <input type="number" id="editCount1" step="0.01" inputmode="numeric" pattern="[0-9.]*" oninput="updateDiscrepancyEdit()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="editDisc1" class="discrepancy">â€”</span></div>
      <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
      <input type="number" id="editCount2" step="0.01" inputmode="numeric" pattern="[0-9.]*" oninput="updateDiscrepancyEdit()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="editDisc2" class="discrepancy">â€”</span></div>
      <label>ØªÚ¯:</label>
      <input type="text" id="editTag" />
      <label>ØªÛŒÙ…:</label>
      <input type="text" id="editTeam" readonly />
      <label>Ù…Ø­Ù„:</label>
      <div class="custom-select-container">
        <input type="text" id="editLocation" autocomplete="off" />
        <div class="custom-select-dropdown hidden" id="editLocationDropdown"></div>
        <span class="select-arrow" onclick="toggleLocationDropdown('edit')">â–¼</span>
      </div>
      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea id="editNotes" rows="2"></textarea>
      <div style="display:flex; gap:8px; margin-top:16px;">
        <button onclick="saveEdit()" style="flex:1;">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
        <button onclick="closeEditModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
      </div>
    </div>
  </div>
  
  <div id="calcModal" class="modal hidden">
    <div class="modal-content">
      <h3>Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨</h3>
      <input type="text" id="calcDisplay" class="calc-display" inputmode="numeric" pattern="[0-9+\-*/().]*" 
             placeholder="12+5*(3-1)" />
      <div style="display:grid; grid-template-columns: repeat(4,1fr); gap:6px; margin-top:10px;">
        <button class="calc-btn" onclick="calcAppend('7')">7</button>
        <button class="calc-btn" onclick="calcAppend('8')">8</button>
        <button class="calc-btn" onclick="calcAppend('9')">9</button>
        <button class="calc-btn" onclick="calcAppend('/')">Ã·</button>
        <button class="calc-btn" onclick="calcAppend('4')">4</button>
        <button class="calc-btn" onclick="calcAppend('5')">5</button>
        <button class="calc-btn" onclick="calcAppend('6')">6</button>
        <button class="calc-btn" onclick="calcAppend('*')">Ã—</button>
        <button class="calc-btn" onclick="calcAppend('1')">1</button>
        <button class="calc-btn" onclick="calcAppend('2')">2</button>
        <button class="calc-btn" onclick="calcAppend('3')">3</button>
        <button class="calc-btn" onclick="calcAppend('-')">âˆ’</button>
        <button class="calc-btn" onclick="calcAppend('0')">0</button>
        <button class="calc-btn" onclick="calcAppend('(')">(</button>
        <button class="calc-btn" onclick="calcAppend(')')">)</button>
        <button class="calc-btn" onclick="calcAppend('+')">+</button>
        <button class="calc-btn" onclick="calcAppend('.')">.</button>
        <button class="calc-btn" style="background:#ffc107;color:#000;" onclick="calcClear()">C</button>
        <button class="calc-btn" style="background:#2196f3;color:white;" onclick="calcApply()">=</button>
        <button class="calc-btn" onclick="calcBackspace()">âŒ«</button>
      </div>
      <button class="calc-btn calc-apply" onclick="calcApply()">âœ… Ø§Ø¹Ù…Ø§Ù„ Ù†ØªÛŒØ¬Ù‡</button>
      <button class="secondary" style="width:100%; margin-top:10px; padding:14px; font-size:18px;" 
              onclick="closeCalcModal()">âŒ Ù„ØºÙˆ</button>
    </div>
  </div>

  <script>
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
    let settings = JSON.parse(localStorage.getItem('appSettings')) || {
      userName: 'Ú©Ø§Ø±Ø¨Ø±',
      teamName: '',
      defaultLocation: 'Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ',
      minLength: 14,
      maxLength: 20,
      searchByTag: false,
      apiUrl: '',
      sheetId: ''
    };
    
    let items = [];
    let filters = {};
    let currentEditIndex = -1;
    let currentDropdown = null;
    let LAST_SCAN_METHOD = localStorage.getItem('scanner') || 'camera';
    let barcodeDetector = null;
    let videoStream = null;
    let scanInterval = null;
    let lastScannedValue = '';
    let stableScanCount = 0;
    let zoomLevel = 1.0;
    let CURRENT_CALC_TARGET = null;
    
    // ============ ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ============
    
    async function loadDataFromSheets() {
      showSyncStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...');
      try {
        const apiUrl = settings.apiUrl || localStorage.getItem('apiUrl');
        if (!apiUrl) {
          showSyncStatus('âŒ URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡', 'error');
          return;
        }
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
        
        const data = await response.json();
        
        if (data.error) {
          showSyncStatus(`âŒ ${data.error}`, 'error');
          return;
        }
        
        items = data;
        showSyncStatus(`âœ… ${items.length} Ù…ÙˆØ±Ø¯ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`, 'success');
        setTimeout(() => hideSyncStatus(), 2000);
        
        renderTable();
        renderDiscrepancyReports();
        return items;
        
      } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ:', error);
        showSyncStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
        setTimeout(() => hideSyncStatus(), 3000);
        return [];
      }
    }
    
    async function saveAllToSheets() {
      showSyncStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...');
      try {
        const apiUrl = settings.apiUrl || localStorage.getItem('apiUrl');
        if (!apiUrl) {
          showSyncStatus('âŒ URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡', 'error');
          return false;
        }
        
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: items })
        });
        
        if (!response.ok) throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
        
        const result = await response.json();
        
        if (result.error) {
          showSyncStatus(`âŒ ${result.error}`, 'error');
          return false;
        }
        
        showSyncStatus(`âœ… ${result.count || items.length} Ù…ÙˆØ±Ø¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`, 'success');
        setTimeout(() => hideSyncStatus(), 2000);
        return true;
        
      } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡:', error);
        showSyncStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
        setTimeout(() => hideSyncStatus(), 3000);
        return false;
      }
    }
    
    async function saveSingleItem(itemData, isNew = false) {
      showSyncStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡ Ø¢ÛŒØªÙ…...');
      try {
        const apiUrl = settings.apiUrl || localStorage.getItem('apiUrl');
        if (!apiUrl) {
          showSyncStatus('âŒ URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡', 'error');
          return false;
        }
        
        // Ø§Ø¨ØªØ¯Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª Ø¯Ø± localStorage
        if (isNew) {
          items.push([
            itemData.barcode,
            itemData.name,
            itemData.count1,
            itemData.discrepancy1,
            itemData.count2,
            itemData.discrepancy2,
            itemData.tag,
            itemData.team,
            itemData.location,
            itemData.stock,
            itemData.notes,
            itemData.lastUpdate,
            itemData.user
          ]);
        } else {
          // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¢ÛŒØªÙ… Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª
          const index = items.findIndex(i => i[0] === itemData.barcode && i[8] === itemData.location);
          if (index !== -1) {
            items[index] = [
              itemData.barcode,
              itemData.name,
              itemData.count1,
              itemData.discrepancy1,
              itemData.count2,
              itemData.discrepancy2,
              itemData.tag,
              itemData.team,
              itemData.location,
              itemData.stock,
              itemData.notes,
              itemData.lastUpdate,
              itemData.user
            ];
          }
        }
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets
        const success = await saveAllToSheets();
        if (success) {
          renderTable();
          renderDiscrepancyReports();
        }
        return success;
        
      } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¢ÛŒØªÙ…:', error);
        showSyncStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
        setTimeout(() => hideSyncStatus(), 3000);
        return false;
      }
    }
    
    async function deleteItem(index) {
      if (!confirm('Ø§ÛŒÙ† Ø±Ø¯ÛŒÙ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
      
      showSyncStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø°Ù...');
      try {
        // Ø­Ø°Ù Ù…ÙˆÙ‚Øª Ø§Ø² Ø¢Ø±Ø§ÛŒÙ‡
        const deletedItem = items.splice(index, 1)[0];
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets
        const success = await saveAllToSheets();
        if (success) {
          renderTable();
          renderDiscrepancyReports();
          showSyncStatus('âœ… Ø¢ÛŒØªÙ… Ø­Ø°Ù Ø´Ø¯', 'success');
          setTimeout(() => hideSyncStatus(), 2000);
        }
        
      } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù:', error);
        showSyncStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
        setTimeout(() => hideSyncStatus(), 3000);
      }
    }
    
    // ============ ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ============
    
    function showSyncStatus(message, type = 'info') {
      const el = document.getElementById('syncStatus');
      el.textContent = message;
      el.classList.remove('hidden', 'error', 'success');
      el.classList.add(type);
    }
    
    function hideSyncStatus() {
      document.getElementById('syncStatus').classList.add('hidden');
    }
    
    function testConnection() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      const sheetId = document.getElementById('sheetId').value.trim();
      
      if (!apiUrl || !sheetId) {
        alert('Ù„Ø·ÙØ§Ù‹ URL Ùˆ ID Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
      }
      
      // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª
      settings.apiUrl = apiUrl;
      settings.sheetId = sheetId;
      localStorage.setItem('appSettings', JSON.stringify(settings));
      localStorage.setItem('apiUrl', apiUrl);
      
      // ØªØ³Øª Ø§ØªØµØ§Ù„
      showSyncStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§ØªØµØ§Ù„...');
      fetch(apiUrl)
        .then(response => {
          if (response.ok) {
            showSyncStatus('âœ… Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚', 'success');
            setTimeout(() => hideSyncStatus(), 2000);
            loadDataFromSheets();
          } else {
            throw new Error(`Ø®Ø·Ø§ÛŒ ${response.status}`);
          }
        })
        .catch(error => {
          showSyncStatus(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: ${error.message}`, 'error');
          setTimeout(() => hideSyncStatus(), 3000);
        });
    }
    
    // ============ ØªÙˆØ§Ø¨Ø¹ Ù…ÙˆØ¬ÙˆØ¯ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ============
    
    function renderTable() {
      document.getElementById('totalCount').textContent = items.length;
      applyFilters();
    }
    
    function applyFilters() {
      const global = document.getElementById('globalSearch').value.toLowerCase();
      const colFilters = Array.from(document.querySelectorAll('.filter-input')).map(el => el.value.toLowerCase());
      
      const filtered = items.filter(row => {
        const matchesGlobal = !global || row.some(cell => String(cell).toLowerCase().includes(global));
        const matchesCols = colFilters.every((f, i) => {
          if (!f) return true;
          const cell = row[i] != null ? String(row[i]).toLowerCase() : '';
          return cell.includes(f);
        });
        return matchesGlobal && matchesCols;
      });
      
      renderTableBody(filtered);
    }
    
    function renderTableBody(data) {
      const t = document.getElementById('tableBody');
      if (data.length === 0) {
        t.innerHTML = '<tr><td colspan="14" style="text-align:center;">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>';
        return;
      }
      
      t.innerHTML = data.map((r, i) => {
        return `<tr>
          <td>${r[0]}</td>
          <td>${r[1]}</td>
          <td>${r[2]}</td>
          <td class="discrepancy">${r[3]}</td>
          <td>${r[4]}</td>
          <td class="discrepancy">${r[5]}</td>
          <td>${r[6]}</td>
          <td>${r[7]}</td>
          <td>${r[8]}</td>
          <td>${parseFloat(r[9]).toLocaleString('fa-IR')}</td>
          <td>${r[10]}</td>
          <td>${r[11]}</td>
          <td>${r[12]}</td>
          <td class="actions">
            <button class="btn-icon" style="background:#1976d2;" onclick="openEditModal(${i})">âœï¸</button>
            <button class="btn-icon danger" onclick="deleteItem(${i})">ğŸ—‘ï¸</button>
          </td>
        </tr>`;
      }).join('');
    }
    
    function renderFilterRow() {
      const headers = Array(13).fill('').map((
