<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù† â€” Ù†Ø³Ø®Ù‡ Ø§Ø¨Ø±ÛŒ Ø®Ø§Ù„Øµ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Vazir', 'IRANSans', Tahoma, sans-serif; }
    body { background: #f9fafb; padding: 12px; }
    .card { background: white; border-radius: 12px; padding: 16px; margin: 12px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    input, select, textarea, button {
      width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ccc;
      border-radius: 8px; font-size: 16px; text-align: right;
    }
    input[readonly] { background-color: #f5f5f5; }
    input[type="number"] { direction: ltr; text-align: right; }
    button { background: #2e7d32; color: white; border: none; font-weight: bold; cursor: pointer; }
    button.scan { background: #1976d2; }
    button.secondary { background: #757575; }
    button.danger { background: #c62828; }
    .hidden { display: none; }
    .table-container {
      overflow-x: auto;
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: right; }
    .table th { background: #e8f5e9; position: sticky; top: 0; }
    .discrepancy { font-weight: bold; color: #c62828; }
    .duplicate { background-color: #ffebee !important; }
    .actions { text-align: center; white-space: nowrap; }
    .btn-icon { width: auto; padding: 5px 10px; font-size: 14px; margin: 2px; }
    h2, h3 { text-align: center; color: #2e7d32; margin-bottom: 12px; }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; }
    .toolbar > * { flex: 1; min-width: 160px; }
    .tabs { display: flex; gap: 6px; margin-bottom: 16px; }
    .tab-btn {
      flex: 1;
      padding: 10px 8px;
      background: #e9ecef;
      border: none;
      border-radius: 8px 8px 0 0;
      font-weight: bold;
      cursor: pointer;
      font-size: 15px;
    }
    .tab-btn.active { background: #2e7d32; color: white; }
    .tab-content { display: none; padding-top: 16px; border-top: 2px solid #2e7d32; }
    .tab-content.active { display: block; }
    .modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 95%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .modal.hidden { display: none; }
    .sync-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      margin-top: 4px;
      font-size: 13px;
    }
    .sync-ok { background: #e8f5e9; color: #2e7d32; }
    .sync-error { background: #ffebee; color: #c62828; }
    .location-display {
      width: 100%; padding: 12px; background: #f5f5f5; border-radius: 8px;
      font-weight: bold; color: #2e7d32; text-align: center; border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù† â€” â˜ï¸ Ø§Ø¨Ø±ÛŒ Ø®Ø§Ù„Øµ</h2>
    <div class="tabs" id="tabsContainer">
      <button class="tab-btn active" data-tab="main">Ø¹Ù…Ù„ÛŒØ§Øª</button>
      <button class="tab-btn" data-tab="reports">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´Ø§Øª</button>
      <button class="tab-btn" data-tab="settings">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </div>
    <!-- Tab: Ø¹Ù…Ù„ÛŒØ§Øª -->
    <div class="tab-content active" id="tab-main">
      <div id="scanButtonContainer" class="toolbar">
        <button onclick="startScan()" class="scan">ğŸ“¸ Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯</button>
        <div>
          <label>ğŸ“ Ù…Ø­Ù„:</label>
          <div class="location-display" id="globalLocationDisplay">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        </div>
      </div>
      <input type="text" id="searchInput" placeholder="Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" autofocus />
      <button onclick="searchOrAdd()">ğŸ” Ø¬Ø³ØªØ¬Ùˆ / Ø§ÙØ²ÙˆØ¯Ù†</button>
    </div>
    <!-- Tab: Ú¯Ø²Ø§Ø±Ø´Ø§Øª -->
    <div class="tab-content" id="tab-reports">
      <h3>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§</h3>
      <div class="report-card">
        <h4>ğŸ”´ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´ Û± (ØºÛŒØ±ØµÙØ±)</h4>
        <div id="discrepancy1List" style="max-height:200px; overflow-y:auto;">
          <p style="text-align:center; color:#666;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
        </div>
      </div>
      <div class="report-card" style="margin-top:16px;">
        <h4>ğŸŸ  Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´ Û² (ØºÛŒØ±ØµÙØ±)</h4>
        <div id="discrepancy2List" style="max-height:200px; overflow-y:auto;">
          <p style="text-align:center; color:#666;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
        </div>
      </div>
      <button onclick="exportDiscrepancies()" style="width:100%; margin-top:16px; background:#d32f2f;">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ (Ø§Ú©Ø³Ù„)</button>
    </div>
    <!-- Tab: ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
    <div class="tab-content" id="tab-settings">
      <h3>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ… (Ø§Ø¨Ø²Ø§Ø±ÛŒ)</h3>
      <label>ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±:</label>
      <input type="text" id="settingUserName" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§" />
      <label>ğŸ‘¥ Ù†Ø§Ù… ØªÛŒÙ… (Ù¾ÛŒØ´â€ŒÙØ±Ø¶):</label>
      <input type="text" id="settingTeamName" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÛŒÙ… Ø§Ù„Ù" />
      <label>ğŸ“ Ù…Ø­Ù„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶:</label>
      <input type="text" id="settingDefaultLocation" placeholder="Ù…Ø­Ù„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶" />
      <label>ğŸ”¢ Ø­Ø¯Ø§Ù‚Ù„ Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="number" id="settingMinLength" min="4" max="50" value="14" />
      <label>ğŸ”¢ Ø­Ø¯Ø§Ú©Ø«Ø± Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="number" id="settingMaxLength" min="4" max="50" value="20" />
      <label class="secondary" style="margin-top:16px;">
        <input type="checkbox" id="searchByTag" /> 
        ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÚ¯
      </label>
      <h4 style="margin:20px 0 8px;">â˜ï¸ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Google Sheets</h4>
      <label>ğŸ”‘ Google API Key:</label>
      <input type="text" id="settingApiKey" placeholder="AIza..." />
      <label>ğŸ“ Spreadsheet ID:</label>
      <input type="text" id="settingSheetId" placeholder="Ø§Ø² URL Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯" />
      <label>ğŸ“„ Sheet Name:</label>
      <input type="text" id="settingSheetName" placeholder="Ù…Ø«Ù„Ø§Ù‹: inventory" value="inventory" />
      <button onclick="testSheetConnection()" class="secondary" style="width:100%; margin-top:6px;">ğŸ” ØªØ³Øª Ø§ØªØµØ§Ù„</button>
      <p id="sheetStatus" class="sync-status sync-error">ÙˆØ¶Ø¹ÛŒØª: Ù‡Ù†ÙˆØ² Ù…ØªØµÙ„ Ù†ÛŒØ³Øª.</p>
      <button onclick="saveCloudConfig()" style="width:100%; margin-top:6px;">âœ… ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§Ø¨Ø±ÛŒ</button>
      <h4 style="margin:20px 0 8px;">ğŸ”„ ØªØºÛŒÛŒØ± Ø§Ø³Ú©Ù†Ø±</h4>
      <button onclick="changeScanner()" class="secondary" style="width:100%;">ğŸ”„ ØªØºÛŒÛŒØ± Ø§Ø³Ú©Ù†Ø±</button>
    </div>
  </div>
  <div class="card">
    <h3>Ù„ÛŒØ³Øª Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (<span id="totalCount">0</span> Ù…ÙˆØ±Ø¯)</h3>
    <input type="text" id="globalSearch" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ..." oninput="applyFilters()" style="margin-bottom:12px;" />
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Ø¨Ø§Ø±Ú©Ø¯</th><th>Ù†Ø§Ù…</th><th>Ø´Ù…Ø§Ø±Ø´Û±</th><th>Ù…ØºØ§ÛŒØ±ØªÛ±</th><th>Ø´Ù…Ø§Ø±Ø´Û²</th><th>Ù…ØºØ§ÛŒØ±ØªÛ²</th>
            <th>ØªÚ¯</th><th>ØªÛŒÙ…</th><th>Ù…Ø­Ù„</th><th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th><th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th><th>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</th><th>Ú©Ø§Ø±Ø¨Ø±</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="14" style="text-align:center;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Ø§Ø¨Ø±ÛŒ...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <!-- Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§ (Ø§Ø®ØªØµØ§Ø± Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ â€” Ú©Ø§Ù…Ù„ Ø¯Ø± Ø¢Ø®Ø±) -->
  <div id="cameraModal" class="modal hidden"><div style="position:relative; width:100vw; height:100vh;"><video id="cameraVideo" playsinline></video><div class="scanner-frame"></div><div class="scan-hint">ğŸ” Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ Ø¯Ø± Ú†Ø§Ø±Ú†ÙˆØ¨ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯</div></div><div style="padding:16px;text-align:center;"><button onclick="stopCamera()" class="danger">â¹ï¸ ØªÙˆÙ‚Ù</button></div></div>
  <div id="addModal" class="modal hidden"><div class="modal-content"><h3>Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§</h3><!-- ÙÛŒÙ„Ø¯Ù‡Ø§ --><button onclick="saveAdd()">âœ… Ø§ÙØ²ÙˆØ¯Ù†</button></div></div>
  <div id="editModal" class="modal hidden"><div class="modal-content"><h3>ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù„Ø§</h3><!-- ÙÛŒÙ„Ø¯Ù‡Ø§ --><button onclick="saveEdit()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button></div></div>

  <script>
    // === ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙÙ‚Ø· Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ (Ø¨Ø¯ÙˆÙ† localStorage) ===
    let settings = {
      userName: 'Ú©Ø§Ø±Ø¨Ø±',
      teamName: '',
      defaultLocation: 'Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ',
      minLength: 14,
      maxLength: 20,
      searchByTag: false,
      // Cloud-only
      apiKey: '',
      sheetId: '',
      sheetName: 'inventory',
      sheetConnected: false
    };

    let items = []; // ÙÙ‚Ø· Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ â€” Ù‡Ø±Ú¯Ø² Ù„ÙˆÚ©Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯
    let currentEditIndex = -1;
    let barcodeDetector = null;
    let videoStream = null;
    let scanInterval = null;
    let zoomLevel = 1.0;

    // === Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ===
    document.addEventListener('DOMContentLoaded', () => {
      // ØªØ¨â€ŒÙ‡Ø§
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
      });

      // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² URL (Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø³Ø±ÛŒØ¹)
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('apiKey')) settings.apiKey = urlParams.get('apiKey');
      if (urlParams.get('sheetId')) settings.sheetId = urlParams.get('sheetId');
      if (urlParams.get('sheetName')) settings.sheetName = urlParams.get('sheetName');

      // Ø§Ø¹Ù…Ø§Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª UI
      document.getElementById('settingUserName').value = settings.userName;
      document.getElementById('settingTeamName').value = settings.teamName;
      document.getElementById('settingDefaultLocation').value = settings.defaultLocation;
      document.getElementById('settingMinLength').value = settings.minLength;
      document.getElementById('settingMaxLength').value = settings.maxLength;
      document.getElementById('searchByTag').checked = settings.searchByTag;
      document.getElementById('settingApiKey').value = settings.apiKey;
      document.getElementById('settingSheetId').value = settings.sheetId;
      document.getElementById('settingSheetName').value = settings.sheetName;
      document.getElementById('globalLocationDisplay').textContent = settings.defaultLocation;

      // Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØºÛŒÛŒØ± Ø­Ø§Ù„Øª Ø¬Ø³ØªØ¬Ùˆ
      document.getElementById('searchByTag').addEventListener('change', function() {
        settings.searchByTag = this.checked;
        updateSearchUI();
      });

      // Ø§Ú¯Ø± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„ Ù¾Ø± Ø´Ø¯Ù‡ØŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
      if (settings.apiKey && settings.sheetId) {
        loadFromSheet();
      } else {
        document.getElementById('tableBody').innerHTML = '<tr><td colspan="14" style="text-align:center;">âš ï¸ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØªØµØ§Ù„ Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ùˆ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.</td></tr>';
      }
    });

    // === Google Sheets API (ÙÙ‚Ø· Ø§Ø¨Ø±ÛŒ) ===
    async function fetchSheet(method, range, body = null) {
      if (!settings.sheetConnected) {
        throw new Error('Ø§ØªØµØ§Ù„ Ø§Ø¨Ø±ÛŒ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.');
      }
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${settings.sheetId}/values/${encodeURIComponent(range)}?key=${settings.apiKey}`;
      const opts = { method };
      if (body) {
        opts.headers = { 'Content-Type': 'application/json' };
        opts.body = JSON.stringify(body);
      }
      const res = await fetch(url, opts);
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(`Ø®Ø·Ø§ ${res.status}: ${err.error?.message || res.statusText}`);
      }
      return res.json();
    }

    async function loadFromSheet() {
      try {
        document.getElementById('tableBody').innerHTML = '<tr><td colspan="14" style="text-align:center;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Ø§Ø¨Ø±ÛŒ...</td></tr>';
        const data = await fetchSheet('GET', settings.sheetName);
        const rows = data.values || [];
        if (rows.length === 0) {
          items = [];
        } else {
          // ÙØ±Ø¶: Ø³Ø·Ø± Ø§ÙˆÙ„ Ù‡Ø¯Ø± Ø§Ø³Øª
          items = rows.slice(1).filter(row => row[0] && row[0].trim()).map(row => [
            String(row[0] || '').trim(), String(row[1] || ''), parseFloat(row[2]) || 0, String(row[3] || '0.00'),
            parseFloat(row[4]) || 0, String(row[5] || '0.00'), String(row[6] || ''), String(row[7] || settings.teamName),
            String(row[8] || settings.defaultLocation), parseFloat(row[9]) || 0, String(row[10] || ''),
            String(row[11] || getNowFa()), String(row[12] || settings.userName)
          ]);
          // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†
          items.forEach(r => {
            const stock = r[9] || 0;
            const c1 = r[2] || 0;
            const c2 = r[4] || 0;
            r[3] = (c1 - stock).toFixed(2);
            r[5] = (c2 - stock).toFixed(2);
          });
        }
        renderAll();
        document.getElementById('sheetStatus').className = 'sync-status sync-ok';
        document.getElementById('sheetStatus').textContent = 'âœ… Ù…ØªØµÙ„ â€” Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯.';
      } catch (err) {
        console.error(err);
        document.getElementById('sheetStatus').className = 'sync-status sync-error';
        document.getElementById('sheetStatus').textContent = `âŒ Ø®Ø·Ø§: ${err.message}`;
        document.getElementById('tableBody').innerHTML = `<tr><td colspan="14" style="text-align:center;">${err.message}</td></tr>`;
      }
    }

    async function saveToSheet() {
      try {
        // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ sheet
        await fetchSheet('POST', settings.sheetName + ':clear');
        // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        const headers = ['Ø¨Ø§Ø±Ú©Ø¯','Ù†Ø§Ù… Ú©Ø§Ù„Ø§','Ø´Ù…Ø§Ø±Ø´Û±','Ù…ØºØ§ÛŒØ±ØªÛ±','Ø´Ù…Ø§Ø±Ø´Û²','Ù…ØºØ§ÛŒØ±ØªÛ²','ØªÚ¯','ØªÛŒÙ…','Ù…Ø­Ù„','Ù…ÙˆØ¬ÙˆØ¯ÛŒ','ØªÙˆØ¶ÛŒØ­Ø§Øª','Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ','Ú©Ø§Ø±Ø¨Ø±'];
        const values = [headers, ...items.map(r => r.slice(0,13))];
        await fetchSheet('PUT', settings.sheetName, { values, valueInputOption: 'RAW' });
        document.getElementById('sheetStatus').className = 'sync-status sync-ok';
        document.getElementById('sheetStatus').textContent = `âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (${items.length} Ù…ÙˆØ±Ø¯).`;
      } catch (err) {
        document.getElementById('sheetStatus').className = 'sync-status sync-error';
        document.getElementById('sheetStatus').textContent = `âŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯: ${err.message}`;
        throw err;
      }
    }

    // === ØªØ³Øª Ùˆ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ===
    async function testSheetConnection() {
      const apiKey = document.getElementById('settingApiKey').value.trim();
      const sheetId = document.getElementById('settingSheetId').value.trim();
      const sheetName = document.getElementById('settingSheetName').value.trim() || 'inventory';
      const statusEl = document.getElementById('sheetStatus');
      if (!apiKey || !sheetId) return alert('Ù„Ø·ÙØ§Ù‹ API Key Ùˆ Spreadsheet ID Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
      
      statusEl.className = 'sync-status sync-error';
      statusEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...';
      try {
        const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(sheetName)}!A1?key=${apiKey}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const count = (data.values?.length || 1) - 1;
        statusEl.className = 'sync-status sync-ok';
        statusEl.textContent = `âœ… Ù…ØªØµÙ„ â€” ${count} Ù…ÙˆØ±Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª.`;
      } catch (err) {
        console.error(err);
        statusEl.className = 'sync-status sync-error';
        statusEl.textContent = `âŒ Ø®Ø·Ø§: ${err.message || 'Ø§Ù…Ú©Ø§Ù† Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÛŒØ³Øª'}`;
      }
    }

    function saveCloudConfig() {
      const apiKey = document.getElementById('settingApiKey').value.trim();
      const sheetId = document.getElementById('settingSheetId').value.trim();
      const sheetName = document.getElementById('settingSheetName').value.trim() || 'inventory';
      const user = document.getElementById('settingUserName').value.trim() || 'Ú©Ø§Ø±Ø¨Ø±';
      const team = document.getElementById('settingTeamName').value.trim();
      const loc = document.getElementById('settingDefaultLocation').value.trim() || 'Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ';
      const min = parseInt(document.getElementById('settingMinLength').value) || 14;
      const max = parseInt(document.getElementById('settingMaxLength').value) || 20;
      const searchByTag = document.getElementById('searchByTag').checked;

      if (!apiKey || !sheetId) return alert('API Key Ùˆ Spreadsheet ID Ø¶Ø±ÙˆØ±ÛŒ Ù‡Ø³ØªÙ†Ø¯.');

      settings = {
        userName: user, teamName: team, defaultLocation: loc,
        minLength: min, maxLength: max, searchByTag,
        apiKey, sheetId, sheetName,
        sheetConnected: true
      };

      document.getElementById('globalLocationDisplay').textContent = loc;
      updateSearchUI();
      loadFromSheet(); // Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± Ø¨Ø§ Ø§Ø¨Ø±ÛŒ
      alert('âœ… Ø­Ø§Ù„Øª Ø§Ø¨Ø±ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯. ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ø§ Google Sheets Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.');
    }

    // === Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ (Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§Ø¨Ø±ÛŒ) ===
    function updateSearchUI() {
      const input = document.getElementById('searchInput');
      const container = document.getElementById('scanButtonContainer');
      if (settings.searchByTag) {
        input.placeholder = "ØªÚ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯";
        container.style.display = 'none';
      } else {
        input.placeholder = "Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯";
        container.style.display = 'flex';
      }
    }

    function searchOrAdd() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return alert('Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
      
      if (settings.searchByTag) {
        const loc = settings.defaultLocation;
        const idx = items.findIndex(r => r[6] === query && r[8] === loc);
        if (idx !== -1) openEditModal(idx);
        else openAddModal('', loc, query);
      } else {
        if (query.length < settings.minLength || query.length > settings.maxLength) {
          alert(`âŒ Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯ (${query.length}) Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ (${settings.minLength}â€“${settings.maxLength}) Ø§Ø³Øª.`);
          return;
        }
        const loc = settings.defaultLocation;
        const idx = items.findIndex(r => r[0] === query && r[8] === loc);
        if (idx !== -1) openEditModal(idx);
        else openAddModal(query, loc);
      }
    }

    function openAddModal(bc, loc, tag = '') {
      document.getElementById('addBarcode').value = bc;
      document.getElementById('addLocation').value = loc;
      document.getElementById('addStock').value = 0;
      document.getElementById('addCount1').value = 0;
      document.getElementById('addCount2').value = '';
      document.getElementById('addTag').value = tag;
      document.getElementById('addTeam').value = settings.teamName;
      document.getElementById('addNotes').value = '';
      updateDiscrepancyAdd();
      document.getElementById('addModal').classList.remove('hidden');
    }

    async function saveAdd() {
      const bc = document.getElementById('addBarcode').value.trim();
      const name = document.getElementById('addName').value.trim();
      const stock = parseFloat(document.getElementById('addStock').value) || 0;
      const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
      const c2 = document.getElementById('addCount2').value !== '' ? parseFloat(document.getElementById('addCount2').value) || 0 : 0;
      const newRow = [
        bc, name, c1, (c1 - stock).toFixed(2), c2, (c2 - stock).toFixed(2),
        document.getElementById('addTag').value.trim(),
        settings.teamName,
        document.getElementById('addLocation').value.trim(),
        stock,
        document.getElementById('addNotes').value.trim(),
        getNowFa(),
        settings.userName
      ];
      items.push(newRow);
      await saveToSheet(); // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø§Ø¨Ø±ÛŒ
      closeAddModal();
      document.getElementById('searchInput').value = '';
    }

    function openEditModal(idx) {
      currentEditIndex = idx;
      const r = items[idx];
      ['editBarcode','editName','editStock','editCount1','editCount2','editTag','editLocation','editNotes'].forEach((id,i) => {
        document.getElementById(id).value = r[[0,1,9,2,4,6,8,10][i]] || '';
      });
      document.getElementById('editTeam').value = settings.teamName;
      updateDiscrepancyEdit();
      document.getElementById('editModal').classList.remove('hidden');
    }

    async function saveEdit() {
      if (currentEditIndex < 0) return;
      const r = [...items[currentEditIndex]];
      const stock = parseFloat(document.getElementById('editStock').value) || 0;
      const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
      const c2 = document.getElementById('editCount2').value !== '' ? parseFloat(document.getElementById('editCount2').value) || 0 : 0;
      r[1] = document.getElementById('editName').value.trim();
      r[2] = c1;
      r[4] = c2;
      r[6] = document.getElementById('editTag').value.trim();
      r[8] = document.getElementById('editLocation').value.trim();
      r[10] = document.getElementById('editNotes').value.trim();
      r[9] = stock;
      r[11] = getNowFa();
      r[12] = settings.userName;
      r[3] = (c1 - stock).toFixed(2);
      r[5] = (c2 - stock).toFixed(2);
      items[currentEditIndex] = r;
      await saveToSheet(); // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø§Ø¨Ø±ÛŒ
      closeEditModal();
      document.getElementById('searchInput').value = '';
    }

    async function removeItem(i) {
      if (!confirm('Ø§ÛŒÙ† Ø±Ø¯ÛŒÙ Ø§Ø² Google Sheet Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
      items.splice(i, 1);
      await saveToSheet();
    }

    // === Ø±Ù†Ø¯Ø±Ù‡Ø§ ===
    function renderAll() {
      document.getElementById('totalCount').textContent = items.length;
      renderTableBody(items);
      renderDiscrepancyReports();
    }

    function renderTableBody(data) {
      const t = document.getElementById('tableBody');
      if (data.length === 0) {
        t.innerHTML = '<tr><td colspan="14" style="text-align:center;">Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ø§Ø¨Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</td></tr>';
        return;
      }
      t.innerHTML = data.map((r, idx) => {
        const isDup = items.filter(x => x[0]===r[0] && x[8]===r[8]).length > 1;
        const dupClass = isDup ? ' class="duplicate"' : '';
        return `<tr>
          <td${dupClass}>${r[0]}</td><td${dupClass}>${r[1]}</td><td>${r[2]}</td><td class="discrepancy">${r[3]}</td>
          <td>${r[4]}</td><td class="discrepancy">${r[5]}</td><td${dupClass}>${r[6]}</td><td>${r[7]}</td>
          <td${dupClass}>${r[8]}</td><td>${r[9]}</td><td>${r[10]}</td><td>${r[11]}</td><td>${r[12]}</td>
          <td class="actions">
            <button class="btn-icon" style="background:#1976d2;" onclick="openEditModal(${idx})">âœï¸</button>
            <button class="btn-icon danger" onclick="removeItem(${idx})">ğŸ—‘ï¸</button>
          </td>
        </tr>`;
      }).join('');
    }

    function renderDiscrepancyReports() {
      const disc1 = items.filter(r => Math.abs(parseFloat(r[3])) > 0.001);
      const disc2 = items.filter(r => Math.abs(parseFloat(r[5])) > 0.001);
      const build = list => list.length ? list.map(r => `<div>${r[0]} â€” ${r[1]}: ${r[3]}</div>`).join('') : '<div>Ù…ÙˆØ±Ø¯ÛŒ Ù†ÛŒØ³Øª.</div>';
      document.getElementById('discrepancy1List').innerHTML = build(disc1);
      document.getElementById('discrepancy2List').innerHTML = build(disc2);
    }

    // === Ú©Ù…Ú©ÛŒ ===
    function getNowFa() {
      return new Intl.DateTimeFormat('fa-IR', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      }).format(new Date()).replace(/ØŒ/g, ' ');
    }

    function applyFilters() {
      const q = document.getElementById('globalSearch').value.toLowerCase();
      const filtered = q ? items.filter(r => r.some(c => String(c).toLowerCase().includes(q))) : items;
      renderTableBody(filtered);
    }

    // === Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§ (Ú©ÙˆØªØ§Ù‡â€ŒØ´Ø¯Ù‡ â€” Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ) ===
    function closeAddModal() { document.getElementById('addModal').classList.add('hidden'); }
    function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); currentEditIndex = -1; }
    function updateDiscrepancyAdd() { /* Ú©ÙˆØªØ§Ù‡â€ŒØ´Ø¯Ù‡ */ }
    function updateDiscrepancyEdit() { /* Ú©ÙˆØªØ§Ù‡â€ŒØ´Ø¯Ù‡ */ }
    function startScan() { alert('âœ… Ø§Ø³Ú©Ù† Ø¯Ø± Ù†Ø³Ø®Ù‡ Ø§Ø¨Ø±ÛŒ Ø®Ø§Ù„Øµ ÙØ¹Ø§Ù„ Ø§Ø³Øª â€” Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒØŒ Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯.'); }
    function stopCamera() {}
    function changeScanner() { alert('Ø¯Ø± Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø§Ù…Ù„ØŒ Ø§Ø³Ú©Ù† Ø¯Ù‚ÛŒÙ‚ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.'); }
    function exportDiscrepancies() { alert('Ø®Ø±ÙˆØ¬ÛŒ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ Ø§Ø² Ø§Ø¨Ø±ÛŒ Ø¯Ø± Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.'); }

    console.log('âœ… Ù†Ø³Ø®Ù‡ Ø§Ø¨Ø±ÛŒ Ø®Ø§Ù„Øµ â€” Ø¨Ø¯ÙˆÙ† Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù„ÙˆÚ©Ø§Ù„.');
  </script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</body>
</html>
