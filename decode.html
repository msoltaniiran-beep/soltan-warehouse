
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Vazir', 'IRANSans', Tahoma, 'B Nazanin', sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    body { background: #f9fafb; padding: 12px; }
    .card { background: white; border-radius: 12px; padding: 16px; margin: 12px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    input, select, textarea, button {
      width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ccc;
      border-radius: 8px; font-size: 16px; text-align: right;
    }
    input[readonly] { background-color: #f5f5f5; }
    input[type="number"] { direction: ltr; text-align: right; }
    button { background: #2e7d32; color: white; border: none; font-weight: bold; cursor: pointer; }
    button.scan { background: #1976d2; }
    button.secondary { background: #757575; }
    button.danger { background: #c62828; }
    .hidden { display: none; }

    .table-container {
      overflow-x: auto;
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: right; }
    .table th { background: #e8f5e9; position: sticky; top: 0; }
    .table thead tr:nth-child(2) th { background: #f1f8e9; padding: 4px; }
    .discrepancy { font-weight: bold; color: #c62828; }
    .duplicate { background-color: #ffebee !important; }
    .actions { text-align: center; white-space: nowrap; }
    .btn-icon { width: auto; padding: 5px 10px; font-size: 14px; margin: 2px; }

    h2, h3 { text-align: center; color: #2e7d32; margin-bottom: 12px; }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; }
    .toolbar > * { flex: 1; min-width: 160px; }

    .modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 95%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .modal.hidden { display: none; }

    .filter-input { 
      width: 100% !important; 
      font-size: 12px !important; 
      padding: 4px 6px !important; 
    }

    .custom-select-container {
      position: relative;
      width: 100%;
    }
    .custom-select-container input {
      padding-right: 36px;
    }
    .select-arrow {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: auto;
      cursor: pointer;
      color: #757575;
      font-size: 14px;
    }
    .custom-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #aaa;
      border-top: none;
      border-radius: 0 0 8px 8px;
      z-index: 10;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .custom-select-dropdown.hidden { display: none; }
    .custom-select-option {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }
    .custom-select-option:hover {
      background: #f0f8f0;
    }
    .custom-select-option:last-child {
      border-bottom: none;
    }

    #cameraVideo {
      width: 100%;
      max-height: 70vh;
      background: #000;
      display: block;
      margin: 0 auto;
    }
    .scanner-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 200px;
      height: 200px;
      margin: -100px 0 0 -100px;
      border: 2px solid #2196f3;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
      pointer-events: none;
    }

    /* Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ */
    .calc-btn { 
      background: #e0e0e0; 
      color: #333; 
      padding: 8px;
      margin: 2px;
      width: 22%;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #bbb;
    }
    .calc-display {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      text-align: left;
      direction: ltr;
      font-size: 18px;
      background: #fff;
      border: 1px solid #ccc;
    }
    .calc-apply {
      background: #2e7d32 !important;
      width: 100% !important;
      padding: 12px !important;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù†</h2>
    
    <div class="toolbar">
      <button class="secondary" onclick="changeScanner()">ğŸ”„ ØªØºÛŒÛŒØ± Ø§Ø³Ú©Ù†Ø±</button>
      <div>
        <label>ğŸ“ Ù…Ø­Ù„:</label>
        <div class="custom-select-container">
          <input type="text" id="globalLocation" placeholder="Ù…Ø­Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯..." autocomplete="off" />
          <div class="custom-select-dropdown hidden" id="locationDropdown"></div>
          <span class="select-arrow" onclick="toggleLocationDropdown('main')">â–¼</span>
        </div>
      </div>
    </div>

    <button onclick="startScan()" class="scan">ğŸ“¸ Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯</button>
    <p style="text-align:center; margin:8px 0;">ÛŒØ§</p>
    <input type="text" id="barcode" placeholder="Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" autofocus />
    <button onclick="searchOrAdd()">ğŸ” Ø¬Ø³ØªØ¬Ùˆ / Ø§ÙØ²ÙˆØ¯Ù†</button>
  </div>

  <div class="card">
    <h3>Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø§ÙˆÙ„ÛŒÙ‡</h3>
    <input type="file" id="excelFile" accept=".xlsx,.xls" style="width:auto; display:block; margin:0 auto 12px;" />
    <button onclick="loadExcel()">ğŸ“¥ import Ø§Ú©Ø³Ù„</button>
  </div>

  <div class="card">
    <h3>Ù„ÛŒØ³Øª Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (<span id="totalCount">0</span> Ù…ÙˆØ±Ø¯)</h3>
    <input type="text" id="globalSearch" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù‡Ù…Ù‡ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§..." oninput="applyFilters()" style="margin-bottom:12px;" />

    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Ø¨Ø§Ø±Ú©Ø¯</th>
            <th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th>
            <th>Ø´Ù…Ø§Ø±Ø´Û±</th>
            <th>Ù…ØºØ§ÛŒØ±ØªÛ±</th>
            <th>Ø´Ù…Ø§Ø±Ø´Û²</th>
            <th>Ù…ØºØ§ÛŒØ±ØªÛ²</th>
            <th>ØªÚ¯</th>
            <th>ØªÛŒÙ…</th>
            <th>Ù…Ø­Ù„</th>
            <th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th>
            <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
            <th>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</th>
            <th>Ø¯Ø³ØªÚ¯Ø§Ù‡</th>
            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
          </tr>
          <tr id="filterRow"></tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="14" style="text-align:center;">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</td></tr>
        </tbody>
      </table>
    </div>

    <div style="text-align:center; margin-top:12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
      <button onclick="clearAll()" class="danger" style="padding:10px 16px; flex:1; max-width:200px;">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡</button>
      <button onclick="exportExcel()" style="background:#1976d2; padding:10px 16px; flex:1; max-width:200px;">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
    </div>
  </div>

  <!-- Ù…Ø¯Ø§Ù„ Ø§Ø³Ú©Ù† Ø¯Ø§Ø®Ù„ÛŒ -->
  <div id="cameraModal" class="modal hidden">
    <div class="modal-content" style="padding:0; max-width:100%; width:100%; max-height:100%;">
      <div style="position:relative; background:#000;">
        <video id="cameraVideo" playsinline autoplay></video>
        <div class="scanner-frame"></div>
      </div>
      <div style="padding:16px; text-align:center;">
        <button onclick="stopCamera()" class="danger" style="width:auto; padding:10px 20px;">â¹ï¸ ØªÙˆÙ‚Ù Ø§Ø³Ú©Ù†</button>
        <p style="margin-top:10px; font-size:14px; color:#666;">Ø¬Ù‡Øª Ø§Ø³Ú©Ù†ØŒ Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ Ø¯Ø± Ø¯Ø§Ø®Ù„ Ú†Ù‡Ø§Ø±Ú†ÙˆØ¨ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.</p>
      </div>
    </div>
  </div>

  <!-- Ù…Ø¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† -->
  <div id="addModal" class="modal hidden">
    <div class="modal-content">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
      
      <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="text" id="addBarcode" readonly />
      
      <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
      <input type="text" id="addName" />
      
      <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
      <input type="number" id="addStock" step="0.01" readonly placeholder="Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ" />
      
      <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
      <input type="number" id="addCount1" step="0.01" oninput="updateDiscrepancyAdd()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="addDisc1" class="discrepancy">â€”</span></div>
      
      <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
      <input type="number" id="addCount2" step="0.01" oninput="updateDiscrepancyAdd()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="addDisc2" class="discrepancy">â€”</span></div>
      
      <label>ØªÚ¯:</label>
      <input type="text" id="addTag" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¢Ø³ÛŒØ¨â€ŒØ¯ÛŒØ¯Ù‡" />
      
      <label>ØªÛŒÙ…:</label>
      <input type="text" id="addTeam" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÛŒÙ… Ø§Ù„Ù" />
      
      <label>Ù…Ø­Ù„:</label>
      <div class="custom-select-container">
        <input type="text" id="addLocation" placeholder="Ù…Ø­Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯..." autocomplete="off" />
        <div class="custom-select-dropdown hidden" id="addLocationDropdown"></div>
        <span class="select-arrow" onclick="toggleLocationDropdown('add')">â–¼</span>
      </div>

      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea id="addNotes" rows="2" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ..."></textarea>

      <div style="display:flex; gap:8px; margin-top:16px;">
        <button onclick="saveAdd()" style="flex:1;">âœ… Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§</button>
        <button onclick="closeAddModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
      </div>
    </div>
  </div>

  <!-- Ù…Ø¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ -->
  <div id="editModal" class="modal hidden">
    <div class="modal-content">
      <h3>ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù„Ø§</h3>
      
      <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="text" id="editBarcode" readonly />
      
      <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
      <input type="text" id="editName" />
      
      <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
      <input type="number" id="editStock" step="0.01" readonly />
      
      <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
      <input type="number" id="editCount1" step="0.01" oninput="updateDiscrepancyEdit()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="editDisc1" class="discrepancy">â€”</span></div>
      
      <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
      <input type="number" id="editCount2" step="0.01" oninput="updateDiscrepancyEdit()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="editDisc2" class="discrepancy">â€”</span></div>
      
      <label>ØªÚ¯:</label>
      <input type="text" id="editTag" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¢Ø³ÛŒØ¨â€ŒØ¯ÛŒØ¯Ù‡" />
      
      <label>ØªÛŒÙ…:</label>
      <input type="text" id="editTeam" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÛŒÙ… Ø§Ù„Ù" />
      
      <label>Ù…Ø­Ù„:</label>
      <div class="custom-select-container">
        <input type="text" id="editLocation" placeholder="Ù…Ø­Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯..." autocomplete="off" />
        <div class="custom-select-dropdown hidden" id="editLocationDropdown"></div>
        <span class="select-arrow" onclick="toggleLocationDropdown('edit')">â–¼</span>
      </div>

      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea id="editNotes" rows="2" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ..."></textarea>

      <div style="display:flex; gap:8px; margin-top:16px;">
        <button onclick="saveEdit()" style="flex:1;">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
        <button onclick="closeEditModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
      </div>
    </div>
  </div>

  <!-- Ù…Ø¯Ø§Ù„ Ø®Ø·Ø§ -->
  <div id="installModal" class="modal hidden">
    <div class="modal-content" style="max-width:350px; text-align:center;">
      <h3 style="color:#d32f2f;">â— Ø§Ø³Ú©Ù†Ø± Ø¨Ø§Ø² Ù†Ø´Ø¯</h3>
      <p style="margin:12px 0;">Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” Â«<span id="appNameHere">ZXing</span>Â» Ø±ÙˆÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø´Ù…Ø§ Ù†ØµØ¨ Ù†ÛŒØ³Øª ÛŒØ§ Ù¾Ø§Ø³Ø® Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</p>
      <p style="font-size:14px; margin:10px 0;">
        âœ… Ù„Ø·ÙØ§Ù‹ ÛŒÚ©ÛŒ Ø§Ø² Ø§ÛŒÙ† Ú©Ø§Ø±Ù‡Ø§ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯:
      </p>
      <div style="margin-top:15px; display:flex; gap:8px; flex-direction:column;">
        <button id="manualInstallBtn" style="background:#4CAF50; padding:12px;">ğŸ“² Ù†ØµØ¨ Ø¯Ø³ØªÛŒ Ø§Ø² Ú¯ÙˆÚ¯Ù„â€ŒÙ¾Ù„ÛŒ</button>
        <button id="useCameraBtn" style="background:#2196f3; padding:12px;">ğŸ“± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯ÙˆØ±Ø¨ÛŒÙ† Ú¯ÙˆØ´ÛŒ</button>
        <button onclick="closeInstallModal()" class="secondary" style="padding:12px;">âŒ Ø¨Ø³ØªÙ† Ùˆ Ø§Ø¯Ø§Ù…Ù‡Ù” Ú©Ø§Ø±</button>
      </div>
    </div>
  </div>

  <!-- Ù…Ø¯Ø§Ù„ Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ -->
  <div id="calcModal" class="modal hidden">
    <div class="modal-content">
      <h3>Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨</h3>
      <input type="text" id="calcDisplay" class="calc-display" placeholder="Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: 12+5*2)" />
      <div style="display:grid; grid-template-columns: repeat(4,1fr); gap:4px;">
        <button class="calc-btn" onclick="calcAppend('7')">7</button>
        <button class="calc-btn" onclick="calcAppend('8')">8</button>
        <button class="calc-btn" onclick="calcAppend('9')">9</button>
        <button class="calc-btn" onclick="calcAppend('/')">Ã·</button>
        <button class="calc-btn" onclick="calcAppend('4')">4</button>
        <button class="calc-btn" onclick="calcAppend('5')">5</button>
        <button class="calc-btn" onclick="calcAppend('6')">6</button>
        <button class="calc-btn" onclick="calcAppend('*')">Ã—</button>
        <button class="calc-btn" onclick="calcAppend('1')">1</button>
        <button class="calc-btn" onclick="calcAppend('2')">2</button>
        <button class="calc-btn" onclick="calcAppend('3')">3</button>
        <button class="calc-btn" onclick="calcAppend('-')">âˆ’</button>
        <button class="calc-btn" onclick="calcAppend('0')">0</button>
        <button class="calc-btn" onclick="calcAppend('.')">.</button>
        <button class="calc-btn" onclick="calcBackspace()">âŒ«</button>
        <button class="calc-btn" onclick="calcAppend('+')">+</button>
      </div>
      <button class="calc-btn calc-apply" onclick="calcApply()">âœ… Ø§Ø¹Ù…Ø§Ù„ Ù†ØªÛŒØ¬Ù‡ Ø¯Ø± Ø´Ù…Ø§Ø±Ø´</button>
      <button class="secondary" style="width:100%; margin-top:8px;" onclick="closeCalcModal()">âŒ Ù„ØºÙˆ</button>
    </div>
  </div>

  <script>
    // === Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… ===
    let items = JSON.parse(localStorage.getItem('items')) || [];
    let filters = {};
    let currentEditIndex = -1;
    let currentDropdown = null;
    let DEVICE_NAME = localStorage.getItem('deviceName') || '';
    let qrScanner = null;
    let LAST_SCAN_METHOD = localStorage.getItem('scanner') || 'camera';
    let CURRENT_CALC_TARGET = null;

    // ØªÙ†Ø¸ÛŒÙ… Ù†Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡
    if (!DEVICE_NAME) {
      const ua = navigator.userAgent;
      let device = 'Ù†Ø§Ù…Ø´Ø®Øµ';
      if (/Android/i.test(ua)) device = 'Android';
      else if (/iPhone|iPad/i.test(ua)) device = 'iOS';
      else if (/Win/i.test(ua)) device = 'Windows';
      else if (/Mac/i.test(ua)) device = 'Mac';
      const browser = /Chrome/i.test(ua) ? 'Chrome' : /Firefox/i.test(ua) ? 'Firefox' : /SamsungBrowser/i.test(ua) ? 'Samsung' : 'Browser';
      const suggested = `${browser} on ${device}`;
      const name = prompt(`ğŸ“Œ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\nÙ¾ÛŒØ´Ù†Ù‡Ø§Ø¯: ${suggested}`, 'Ù…Ø­Ù…Ø¯');
      DEVICE_NAME = name ? `${suggested} â€“ ${name}` : suggested;
      localStorage.setItem('deviceName', DEVICE_NAME);
    }

    const SCANNERS = [
      { id: 'camera', name: 'ğŸ“¸ Ø§Ø³Ú©Ù† Ø¨Ø§ Ø¯ÙˆØ±Ø¨ÛŒÙ† (Ø¯Ø§Ø®Ù„ÛŒ)', desc: 'Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù†ØµØ¨ Ø¨Ø±Ù†Ø§Ù…Ù‡' },
      { id: 'zxing', name: 'ZXing Barcode Scanner', desc: 'Ø±Ø§ÛŒÚ¯Ø§Ù†ØŒ Ù¾Ø§ÛŒØ¯Ø§Ø± Ùˆ Ù¾Ø±Ú©Ø§Ø±Ø¨Ø±Ø¯', 
        intent: 'intent://scan/#Intent;scheme=zxing;package=com.google.zxing.client.android;end;',
        playUrl: 'https://play.google.com/store/apps/details?id=com.google.zxing.client.android' },
      { id: 'gamma', name: 'Gamma Barcode Scanner', desc: 'Ø³Ø±ÛŒØ¹ Ùˆ Ø¨Ø¯ÙˆÙ† ØªØ¨Ù„ÛŒØº (Ù…Ø«Ù„ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø´Ù…Ø§)',
        intent: 'intent://scan/#Intent;scheme=scan;package=com.gamma.scan;end;',
        playUrl: 'https://play.google.com/store/apps/details?id=com.gamma.scan' },
      { id: 'easy', name: 'Easy Barcode Scanner', desc: 'Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø³Ø§Ø¯Ù‡',
        intent: 'intent://scan/#Intent;scheme=scan;package=com.tecace.easybarcodescanner;end;',
        playUrl: 'https://play.google.com/store/apps/details?id=com.tecace.easybarcodescanner' }
    ];

    // === ØªÙˆØ§Ø¨Ø¹ Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ ===
    function openCalc(targetInputId) {
      CURRENT_CALC_TARGET = targetInputId;
      document.getElementById('calcDisplay').value = '';
      document.getElementById('calcModal').classList.remove('hidden');
    }

    function calcAppend(char) {
      const disp = document.getElementById('calcDisplay');
      disp.value += char;
    }

    function calcBackspace() {
      const disp = document.getElementById('calcDisplay');
      disp.value = disp.value.slice(0, -1);
    }

    function calcApply() {
      const expr = document.getElementById('calcDisplay').value;
      if (!expr.trim()) return alert('Ø¹Ø¨Ø§Ø±ØªÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');

      const safeExpr = expr.replace(/[^0-9+\-*/().\sÃ·Ã—]/g, '')
                           .replace(/Ã·/g, '/')
                           .replace(/Ã—/g, '*');
      try {
        const result = new Function('return (' + safeExpr + ')')();
        if (isNaN(result) || !isFinite(result)) throw new Error('Invalid');

        const target = document.getElementById(CURRENT_CALC_TARGET);
        target.value = parseFloat(result).toFixed(2);
        
        if (CURRENT_CALC_TARGET.startsWith('add')) {
          updateDiscrepancyAdd();
        } else if (CURRENT_CALC_TARGET.startsWith('edit')) {
          updateDiscrepancyEdit();
        }

        closeCalcModal();
      } catch (e) {
        alert('Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
      }
    }

    function closeCalcModal() {
      document.getElementById('calcModal').classList.add('hidden');
      CURRENT_CALC_TARGET = null;
    }

    // === Ø§Ø³Ú©Ù†Ø±Ù‡Ø§ ===
    function changeScanner() {
      let msg = 'Ù„Ø·ÙØ§Ù‹ Ø±ÙˆØ´ Ø§Ø³Ú©Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\n\n';
      SCANNERS.forEach((s, i) => {
        msg += `${i+1} â†’ ${s.name}\n   ${s.desc}\n`;
      });
      msg += `\nØ´Ù…Ø§Ø±Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: 1):`;

      const choice = prompt(msg, '1');
      const idx = Math.max(0, parseInt(choice) - 1);
      const selected = SCANNERS[idx] || SCANNERS[0];

      LAST_SCAN_METHOD = selected.id;
      localStorage.setItem('scanner', selected.id);
      alert(`âœ… Ø±ÙˆØ´ Ø§Ø³Ú©Ù†: ${selected.name}`);
    }

    async function startCameraScan() {
      const video = document.getElementById('cameraVideo');
      const modal = document.getElementById('cameraModal');
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: "environment" } 
        });
        
        video.srcObject = stream;
        modal.classList.remove('hidden');

        if (!window.QrScanner) {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js';
          document.head.appendChild(script);
          
          await new Promise(resolve => {
            script.onload = resolve;
            script.onerror = () => { alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø³Ú©Ù†Ø± Ø¯Ø§Ø®Ù„ÛŒ'); resolve(); };
          });
        }

        if (qrScanner) qrScanner.destroy();
        qrScanner = new QrScanner(video, result => {
          stopCamera();
          document.getElementById('barcode').value = result.trim();
          setTimeout(searchOrAdd, 300);
        }, {
          highlightScanRegion: true,
          highlightCodeOutline: true
        });

        qrScanner.start();
      } catch (err) {
        alert('âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø¯ Ø´Ø¯ ÛŒØ§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
      }
    }

    function stopCamera() {
      const modal = document.getElementById('cameraModal');
      modal.classList.add('hidden');
      if (qrScanner) {
        qrScanner.stop();
        qrScanner.destroy();
        qrScanner = null;
      }
      const video = document.getElementById('cameraVideo');
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
    }

    function launchExternalScanner(scannerId) {
      const scanner = SCANNERS.find(s => s.id === scannerId && s.intent);
      if (!scanner) {
        startCameraScan();
        return;
      }

      let opened = false;
      try {
        const w = window.open(scanner.intent, '_self');
        if (w) opened = true;
      } catch (e) { /* silent */ }

      setTimeout(() => {
        if (!opened) {
          document.getElementById('appNameHere').textContent = scanner.name;
          document.getElementById('manualInstallBtn').onclick = () => {
            window.open(scanner.playUrl, '_blank');
            closeInstallModal();
          };
          document.getElementById('useCameraBtn').onclick = () => {
            closeInstallModal();
            LAST_SCAN_METHOD = 'camera';
            localStorage.setItem('scanner', 'camera');
            startCameraScan();
          };
          document.getElementById('installModal').classList.remove('hidden');
        }
      }, 700);
    }

    function startScan() {
      if (LAST_SCAN_METHOD === 'camera') {
        startCameraScan();
      } else {
        launchExternalScanner(LAST_SCAN_METHOD);
      }
    }

    // === Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ØºØ§ÛŒØ±Øª ===
    function calculateDiscrepancy2(stock, count2Str, discrepancy1) {
      if (parseFloat(discrepancy1) === 0) {
        const c2 = count2Str !== '' ? parseFloat(count2Str) : null;
        if (c2 === null || c2 === 0) {
          return "0.00";
        }
      }
      const c2 = count2Str !== '' ? parseFloat(count2Str) || 0 : 0;
      return (c2 - stock).toFixed(2);
    }

    function updateDiscrepancyAdd() {
      const stock = parseFloat(document.getElementById('addStock').value) || 0;
      const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
      const c2 = document.getElementById('addCount2').value;
      const disc1 = (c1 - stock).toFixed(2);
      document.getElementById('addDisc1').textContent = disc1;
      const disc2 = calculateDiscrepancy2(stock, c2, disc1);
      document.getElementById('addDisc2').textContent = disc2;
    }

    function updateDiscrepancyEdit() {
      const stock = parseFloat(document.getElementById('editStock').value) || 0;
      const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
      const c2 = document.getElementById('editCount2').value;
      const disc1 = (c1 - stock).toFixed(2);
      document.getElementById('editDisc1').textContent = disc1;
      const disc2 = calculateDiscrepancy2(stock, c2, disc1);
      document.getElementById('editDisc2').textContent = disc2;
    }

    // === Ù„ÛŒØ³Øª Ú©Ø´ÙˆÛŒÛŒ Ù…Ø­Ù„ ===
    function getLocations() {
      const set = new Set();
      items.forEach(r => {
        const loc = (r[8] || '').trim();
        if (loc) set.add(loc);
      });
      return Array.from(set).sort();
    }

    function renderDropdown(id, locations) {
      const el = document.getElementById(id);
      if (!el) return;
      el.innerHTML = locations.length 
        ? locations.map(l => `<div class="custom-select-option" onclick="selectLocation('${l.replace(/'/g,"\\'")}','${id}')">${l}</div>`).join('')
        : '<div class="custom-select-option" style="color:#999;">Ù…Ø­Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
    }

    function toggleLocationDropdown(context) {
      hideAllDropdowns();
      const map = {
        main: { input: 'globalLocation', dropdown: 'locationDropdown' },
        add:  { input: 'addLocation',     dropdown: 'addLocationDropdown' },
        edit: { input: 'editLocation',    dropdown: 'editLocationDropdown' }
      };
      const { dropdown } = map[context] || {};
      if (!dropdown) return;
      const el = document.getElementById(dropdown);
      if (el.classList.contains('hidden')) {
        renderDropdown(dropdown, getLocations());
        el.classList.remove('hidden');
        currentDropdown = context;
      }
    }

    function hideAllDropdowns() {
      ['locationDropdown','addLocationDropdown','editLocationDropdown'].forEach(id=>{
        const e=document.getElementById(id); if(e) e.classList.add('hidden');
      });
      currentDropdown = null;
    }

    function selectLocation(loc, dropdownId) {
      const map = {
        'locationDropdown': 'globalLocation',
        'addLocationDropdown': 'addLocation',
        'editLocationDropdown': 'editLocation'
      };
      const inputId = map[dropdownId] || dropdownId.replace('Dropdown', '');
      document.getElementById(inputId).value = loc;
      hideAllDropdowns();
    }

    // === ØªÙˆØ§Ø¨Ø¹ Ø²Ù…Ø§Ù† ===
    function getNowFa() {
      return new Intl.DateTimeFormat('fa-IR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      }).format(new Date()).replace(/ØŒ/g, ' ');
    }

    // === Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ ===
    function searchOrAdd() {
      const bc = document.getElementById('barcode').value.trim();
      const loc = document.getElementById('globalLocation').value.trim();
      if (!bc) return alert('Ù„Ø·ÙØ§Ù‹ Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
      const idx = items.findIndex(r => r[0] === bc && r[8] === loc);
      if (idx !== -1) openEditModal(idx);
      else openAddModal(bc, loc);
    }

    function openAddModal(bc, loc) {
      const existing = items.find(r => r[0] === bc);
      const stock = existing ? parseFloat(existing[9]) || 0 : 0;
      
      document.getElementById('addBarcode').value = bc;
      document.getElementById('addLocation').value = loc;
      document.getElementById('addStock').value = stock;
      document.getElementById('addCount1').value = stock; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
      document.getElementById('addCount2').value = '';
      document.getElementById('addTag').value = '';
      document.getElementById('addTeam').value = '';
      document.getElementById('addNotes').value = '';
      updateDiscrepancyAdd();
      document.getElementById('addModal').classList.remove('hidden');
    }

    function saveAdd() {
      const bc = document.getElementById('addBarcode').value.trim();
      const name = document.getElementById('addName').value.trim();
      const stock = parseFloat(document.getElementById('addStock').value) || 0;
      const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
      const c2Raw = document.getElementById('addCount2').value;
      const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;

      const disc1 = (c1 - stock).toFixed(2);
      const disc2 = calculateDiscrepancy2(stock, c2Raw, disc1);

      const now = new Date();
      const newRow = [
        bc, name, c1, disc1, c2, disc2,
        document.getElementById('addTag').value.trim(),
        document.getElementById('addTeam').value.trim(),
        document.getElementById('addLocation').value.trim(),
        stock,
        document.getElementById('addNotes').value.trim(),
        getNowFa(), DEVICE_NAME,
        now.getTime() // âœ… Ø³ØªÙˆÙ† 13: timestamp Ø¹Ø¯Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ
      ];

      items.push(newRow);
      localStorage.setItem('items', JSON.stringify(items));
      renderTable();
      closeAddModal();
      document.getElementById('barcode').value = '';
      document.getElementById('barcode').focus();
    }

    function closeAddModal() {
      document.getElementById('addModal').classList.add('hidden');
    }

    function openEditModal(idx) {
      currentEditIndex = idx;
      const r = items[idx];
      const stock = parseFloat(r[9]) || 0;

      document.getElementById('editBarcode').value = r[0];
      document.getElementById('editName').value = r[1];
      document.getElementById('editStock').value = stock;
      document.getElementById('editCount1').value = r[2]; // âœ… Ø§ØµÙ„Ø§Ø­: Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ Ø´Ù…Ø§Ø±Ø´Û± (Ù†Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ)
      document.getElementById('editCount2').value = r[4] || '';
      document.getElementById('editTag').value = r[6] || '';
      document.getElementById('editTeam').value = r[7] || '';
      document.getElementById('editLocation').value = r[8] || '';
      document.getElementById('editNotes').value = r[10] || '';
      updateDiscrepancyEdit();
      document.getElementById('editModal').classList.remove('hidden');
    }

    function saveEdit() {
      if (currentEditIndex < 0) return;
      const r = [...items[currentEditIndex]];
      const stock = parseFloat(document.getElementById('editStock').value) || 0;
      const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
      const c2Raw = document.getElementById('editCount2').value;
      const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;

      r[1] = document.getElementById('editName').value.trim();
      r[2] = c1;
      r[4] = c2;
      r[6] = document.getElementById('editTag').value.trim();
      r[7] = document.getElementById('editTeam').value.trim();
      r[8] = document.getElementById('editLocation').value.trim();
      r[10] = document.getElementById('editNotes').value.trim();
      r[9] = stock;
      
      const now = new Date();
      r[11] = getNowFa(); // Ø±Ø´ØªÙ‡ ÙØ§Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
      r[12] = DEVICE_NAME;
      r[13] = now.getTime(); // âœ… Ø¨Ø±Ø§ÛŒ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ

      r[3] = (c1 - stock).toFixed(2);
      r[5] = calculateDiscrepancy2(stock, c2Raw, r[3]);

      items[currentEditIndex] = r;
      localStorage.setItem('items', JSON.stringify(items));
      renderTable();
      closeEditModal();
      document.getElementById('barcode').value = '';
      document.getElementById('barcode').focus();
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
      currentEditIndex = -1;
    }

    // === import / export ===
    function loadExcel() {
      const file = document.getElementById('excelFile').files[0];
      if (!file) return alert('ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, { header: 1 });

          if (json.length < 2) return alert('ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.');

          const headers = json[0].map(h => String(h).trim().toLowerCase());
          const mappings = {
            'Ø¨Ø§Ø±Ú©Ø¯': 0, 'Ú©Ø¯': 0, 'id': 0, 'barcode': 0,
            'Ù†Ø§Ù…': 1, 'Ù†Ø§Ù… Ú©Ø§Ù„Ø§': 1, 'Ú©Ø§Ù„Ø§': 1, 'name': 1,
            'Ù…ÙˆØ¬ÙˆØ¯ÛŒ': 9, 'stock': 9, 'quantity': 9,
            'ØªÚ¯': 6, 'label': 6,
            'ØªÛŒÙ…': 7, 'team': 7,
            'Ù…Ø­Ù„': 8, 'location': 8,
            'Ø´Ù…Ø§Ø±Ø´1': 2, 'count1': 2, 'Ø´Ù…Ø§Ø±Ø´ 1': 2,
            'Ø´Ù…Ø§Ø±Ø´2': 4, 'count2': 4, 'Ø´Ù…Ø§Ø±Ø´ 2': 4,
            'ØªÙˆØ¶ÛŒØ­Ø§Øª': 10, 'notes': 10
          };

          items = [];
          for (let i = 1; i < json.length; i++) {
            const row = json[i];
            const bc = String(row[headers.indexOf('barcode')] || row[headers.indexOf('Ø¨Ø§Ø±Ú©Ø¯')] || row[0] || '').trim();
            if (!bc) continue;

            const getItem = (key) => {
              for (let h of Object.keys(mappings)) {
                const idx = headers.indexOf(h);
                if (idx !== -1 && mappings[h] === key) {
                  return row[idx] != null ? String(row[idx]).trim() : '';
                }
              }
              return '';
            };

            const stock = parseFloat(getItem(9).replace(/,/g, '')) || 0;
            const c1 = parseFloat(getItem(2).replace(/,/g, '')) || 0;
            const c2 = parseFloat(getItem(4).replace(/,/g, '')) || 0;

            const disc1 = (c1 - stock).toFixed(2);
            const disc2 = calculateDiscrepancy2(stock, c2.toString(), disc1);

            const now = new Date();
            items.push([
              bc, getItem(1), c1, disc1, c2, disc2,
              getItem(6), getItem(7), getItem(8), stock, getItem(10),
              getNowFa(), DEVICE_NAME,
              now.getTime() // âœ… timestamp Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
            ]);
          }

          localStorage.setItem('items', JSON.stringify(items));
          renderTable();
          alert(`âœ… ${items.length} Ù…ÙˆØ±Ø¯ import Ø´Ø¯.`);
        } catch (err) {
          console.error(err);
          alert('Ø®Ø·Ø§ Ø¯Ø± import: ' + (err.message || 'Ù†Ø§Ù…Ø´Ø®Øµ'));
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function exportExcel() {
      if (items.length === 0) return alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');

      // ÙÙ‚Ø· 13 Ø³ØªÙˆÙ† Ø§ÙˆÙ„ Ø±Ø§ export Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (ØªØ§ timestamp Ù…Ø®ÙÛŒ Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ Ù†ÛŒØ§ÛŒØ¯)
      const wsData = [
        ['Ø¨Ø§Ø±Ú©Ø¯', 'Ù†Ø§Ù… Ú©Ø§Ù„Ø§', 'Ø´Ù…Ø§Ø±Ø´Û±', 'Ù…ØºØ§ÛŒØ±ØªÛ±', 'Ø´Ù…Ø§Ø±Ø´Û²', 'Ù…ØºØ§ÛŒØ±ØªÛ²', 'ØªÚ¯', 'ØªÛŒÙ…', 'Ù…Ø­Ù„', 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ', 'ØªÙˆØ¶ÛŒØ­Ø§Øª', 'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', 'Ø¯Ø³ØªÚ¯Ø§Ù‡'],
        ...items.map(r => [
          r[0], r[1], r[2], r[3], r[4], r[5],
          r[6], r[7], r[8], r[9], r[10], r[11], r[12]
        ])
      ];

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      ws['!cols'] = [
        { wch: 15 }, { wch: 25 }, { wch: 8 }, { wch: 10 }, { wch: 8 }, { wch: 10 },
        { wch: 12 }, { wch: 8 }, { wch: 15 }, { wch: 10 }, { wch: 20 },
        { wch: 18 }, { wch: 20 }
      ];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù†Ø¨Ø§Ø±');
      XLSX.writeFile(wb, 'Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ_Ø®Ø±ÙˆØ¬ÛŒ.xlsx');
    }

    // === Ø¬Ø¯ÙˆÙ„ ===
    function renderTable() {
      document.getElementById('totalCount').textContent = items.length;

      // âœ… Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ timestamp (Ø³ØªÙˆÙ† 13) â€” Ø§Ø² Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù‚Ø¯ÛŒÙ…
      items.sort((a, b) => {
        const tsA = a[13] || Date.now(); // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
        const tsB = b[13] || Date.now();
        return tsB - tsA; // Ø¬Ø¯ÛŒØ¯ØªØ±Ù‡Ø§ Ø¨Ø§Ù„Ø§ØªØ±
      });

      applyFilters();
    }

    function applyFilters() {
      const global = document.getElementById('globalSearch').value.toLowerCase();
      const inputs = document.querySelectorAll('.filter-input');
      filters = {};
      inputs.forEach(inp => {
        const c = parseInt(inp.dataset.col);
        const v = inp.value.toLowerCase();
        if (v) filters[c] = v;
      });

      const filtered = items.filter(row => {
        if (global && !row.some(cell => String(cell).toLowerCase().includes(global))) return false;
        for (let c in filters) if (!String(row[c] || '').toLowerCase().includes(filters[c])) return false;
        return true;
      });

      renderTableBody(filtered);
    }

    function renderTableBody(data) {
      const t = document.getElementById('tableBody');
      if (data.length === 0) {
        t.innerHTML = '<tr><td colspan="14" style="text-align:center;">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>';
        return;
      }

      const dupMap = {};
      data.forEach(r => {
        const key = `${r[0]}|${r[8]}`;
        dupMap[key] = (dupMap[key] || 0) + 1;
      });

      t.innerHTML = data.map((row, _) => {
        const key = `${row[0]}|${row[8]}`;
        const isDup = dupMap[key] > 1;
        const idx = items.findIndex(r => r[0] === row[0] && r[8] === row[8]);

        return `<tr>
          <td${isDup ? ' class="duplicate"' : ''}>${row[0]}</td>
          <td${isDup ? ' class="duplicate"' : ''}>${row[1]}</td>
          <td>${row[2]}</td>
          <td class="discrepancy">${row[3]}</td>
          <td>${row[4]}</td>
          <td class="discrepancy">${row[5]}</td>
          <td>${row[6]}</td>
          <td>${row[7]}</td>
          <td${isDup ? ' class="duplicate"' : ''}>${row[8]}</td>
          <td>${parseFloat(row[9]).toLocaleString('fa-IR')}</td>
          <td>${row[10]}</td>
          <td>${row[11]}</td>
          <td>${row[12]}</td>
          <td class="actions">
            <button class="btn-icon" style="background:#1976d2;" onclick="openEditModal(${idx})">âœï¸</button>
            <button class="btn-icon danger" onclick="removeItem(${idx})">ğŸ—‘ï¸</button>
          </td>
        </tr>`;
      }).join('');
    }

    function removeItem(i) {
      if (confirm('Ø§ÛŒÙ† Ø±Ø¯ÛŒÙ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
        items.splice(i, 1);
        localStorage.setItem('items', JSON.stringify(items));
        renderTable();
      }
    }

    function clearAll() {
      if (items.length && confirm('âš ï¸ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ')) {
        items = [];
        localStorage.setItem('items', JSON.stringify(items));
        renderTable();
      }
    }

    function renderFilterRow() {
      const headers = ['Ø¨Ø§Ø±Ú©Ø¯','Ù†Ø§Ù… Ú©Ø§Ù„Ø§','Ø´Ù…Ø§Ø±Ø´Û±','Ù…ØºØ§ÛŒØ±ØªÛ±','Ø´Ù…Ø§Ø±Ø´Û²','Ù…ØºØ§ÛŒØ±ØªÛ²','ØªÚ¯','ØªÛŒÙ…','Ù…Ø­Ù„','Ù…ÙˆØ¬ÙˆØ¯ÛŒ','ØªÙˆØ¶ÛŒØ­Ø§Øª','Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ','Ø¯Ø³ØªÚ¯Ø§Ù‡'];
      const f = document.getElementById('filterRow');
      f.innerHTML = headers.map((_,i)=>`<th><input type="text" class="filter-input" data-col="${i}" placeholder="ÙÛŒÙ„ØªØ±..." oninput="applyFilters()"></th>`).join('') + '<th></th>';
    }

    function closeInstallModal() {
      document.getElementById('installModal').classList.add('hidden');
    }

    // === Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ===
    document.addEventListener('DOMContentLoaded', () => {
      renderTable();
      renderFilterRow();
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-select-container')) {
          hideAllDropdowns();
        }
      });

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡Ù” Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ Ø¨Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´
      const fields = [
        { id: 'addCount1', target: 'addCount1' },
        { id: 'addCount2', target: 'addCount2' },
        { id: 'editCount1', target: 'editCount1' },
        { id: 'editCount2', target: 'editCount2' }
      ];

      fields.forEach(f => {
        const el = document.getElementById(f.id);
        if (el) {
          const wrap = document.createElement('div');
          wrap.style.position = 'relative';
          el.parentNode.insertBefore(wrap, el);
          wrap.appendChild(el);
          
          const btn = document.createElement('button');
          btn.innerHTML = 'ğŸ§®';
          btn.style.position = 'absolute';
          btn.style.left = '8px';
          btn.style.top = '50%';
          btn.style.transform = 'translateY(-50%)';
          btn.style.background = '#e0e0e0';
          btn.style.border = 'none';
          btn.style.width = '28px';
          btn.style.height = '28px';
          btn.style.borderRadius = '4px';
          btn.style.cursor = 'pointer';
          btn.onclick = () => openCalc(f.target);
          
          wrap.appendChild(btn);
          el.style.paddingLeft = '40px';
        }
      });

      // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø³Ú©Ù† Ø®Ø§Ø±Ø¬ÛŒ
      const p = new URLSearchParams(window.location.search);
      const bc = p.get('SCAN_RESULT') || p.get('barcode') || p.get('contents') || p.get('result');
      if (bc) {
        document.getElementById('barcode').value = bc.trim();
        setTimeout(searchOrAdd, 300);
      }
    });

    console.log('âœ… Ú©Ø¯ Ù†Ù‡Ø§ÛŒÛŒ â€” Ø¨Ø§ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ùˆ Ø§ØµÙ„Ø§Ø­ ÙˆÛŒØ±Ø§ÛŒØ´');
  </script>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</body>
</html>
