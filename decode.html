<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù†</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Vazir', 'IRANSans', Tahoma, sans-serif; -webkit-font-smoothing: antialiased; }
    body { background: #f9fafb; padding: 12px; }
    .card { background: white; border-radius: 12px; padding: 16px; margin: 12px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    input, select, textarea, button {
      width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ccc;
      border-radius: 8px; font-size: 16px; text-align: right;
    }
    input[readonly] { background-color: #f5f5f5; }
    input[type="number"] { direction: ltr; text-align: right; }
    button { background: #2e7d32; color: white; border: none; font-weight: bold; cursor: pointer; }
    button.scan { background: #1976d2; }
    button.secondary { background: #757575; }
    button.danger { background: #c62828; }
    .hidden { display: none; }

    .table-container {
      overflow-x: auto;
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: right; }
    .table th { background: #e8f5e9; position: sticky; top: 0; }
    .table thead tr:nth-child(2) th { background: #f1f8e9; padding: 4px; }
    .discrepancy { font-weight: bold; color: #c62828; }
    .duplicate { background-color: #ffebee !important; }
    .tag-location-dup { background-color: #fce4ec !important; } /* ØµÙˆØ±ØªÛŒ Ø¨Ø±Ø§ÛŒ ØªÚ¯+Ù…Ø­Ù„ ØªÚ©Ø±Ø§Ø±ÛŒ */
    .actions { text-align: center; white-space: nowrap; }
    .btn-icon { width: auto; padding: 5px 10px; font-size: 14px; margin: 2px; }

    h2, h3 { text-align: center; color: #2e7d32; margin-bottom: 12px; }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; }
    .toolbar > * { flex: 1; min-width: 160px; }

    .tabs { display: flex; gap: 6px; margin-bottom: 16px; }
    .tab-btn {
      flex: 1;
      padding: 10px 8px;
      background: #e9ecef;
      border: none;
      border-radius: 8px 8px 0 0;
      font-weight: bold;
      cursor: pointer;
      font-size: 15px;
    }
    .tab-btn.active { background: #2e7d32; color: white; }
    .tab-content { display: none; padding-top: 16px; border-top: 2px solid #2e7d32; }
    .tab-content.active { display: block; }

    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; border-radius: 16px; padding: 20px; width: 95%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }

    .custom-select-container { position: relative; width: 100%; }
    .custom-select-container input { padding-right: 36px; }
    .select-arrow {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: auto;
      cursor: pointer;
      color: #757575;
      font-size: 14px;
    }
    .custom-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #aaa;
      border-top: none;
      border-radius: 0 0 8px 8px;
      z-index: 10;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .custom-select-dropdown.hidden { display: none; }
    .custom-select-option {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }
    .custom-select-option:hover { background: #f0f8f0; }
    .custom-select-option:last-child { border-bottom: none; }

    /* Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ â€” Ø¨Ø²Ø±Ú¯â€ŒØªØ± */
    .calc-btn { 
      background: #e0e0e0; color: #333; padding: 16px 0; margin: 4px;
      font-size: 22px; font-weight: bold; border-radius: 12px; border: 1px solid #bbb;
      width: 22%; height: 56px; display: flex; justify-content: center; align-items: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    .calc-display {
      width: 100%; padding: 16px; margin: 8px 0; text-align: left; direction: ltr;
      font-size: 22px; background: #fff; border: 1px solid #ccc; border-radius: 8px;
    }
    .calc-apply {
      background: #2e7d32 !important; width: 100% !important; padding: 18px !important;
      margin-top: 14px; font-size: 20px; border-radius: 10px;
    }

    .report-card { background: #fff8e1; border-left: 4px solid #ffa000; }
    .report-card h4 { color: #e65100; margin-bottom: 10px; }

    /* ÙÛŒÙ„ØªØ± Ú¯Ø²Ø§Ø±Ø´ */
    .report-filter { margin: 10px 0; display: flex; flex-wrap: wrap; gap:8px; }
    .report-filter select { flex: 1; min-width: 120px; font-size:14px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù†</h2>

    <div class="tabs" id="tabsContainer">
      <button class="tab-btn active" data-tab="main">Ø¹Ù…Ù„ÛŒØ§Øª</button>
      <button class="tab-btn" data-tab="reports">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´Ø§Øª</button>
      <button class="tab-btn" data-tab="settings">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </div>

    <!-- Tab: Ø¹Ù…Ù„ÛŒØ§Øª -->
    <div class="tab-content active" id="tab-main">
      <!-- âœ… ÙÙ‚Ø· Ù†Ù…Ø§ÛŒØ´ Ù…Ø­Ù„ â€” readonly -->
      <div style="margin-bottom:12px;">
        <label>ğŸ“ Ù…Ø­Ù„ ÙØ¹Ù„ÛŒ:</label>
        <input type="text" id="currentLocation" readonly />
      </div>

      <!-- Ú©Ù†ØªØ±Ù„ Ø´Ø±Ø·ÛŒ Ø§Ø³Ú©Ù† -->
      <div id="scanButtonContainer" class="toolbar">
        <button onclick="startScan()" class="scan">ğŸ“¸ Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯</button>
        <div style="flex:1;"></div> <!-- ÙØ¶Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ú†Ù¾â€ŒÚ†ÛŒÙ† -->
      </div>

      <!-- ÙÛŒÙ„Ø¯ Ø¬Ø³ØªØ¬Ùˆ + Ú©Ø´ÙˆÛŒ ØªÚ¯/Ù…Ø­Ù„ -->
      <input type="text" id="searchInput" placeholder="Ø¨Ø§Ø±Ú©Ø¯ ÛŒØ§ ØªÚ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" autofocus 
             onfocus="maybeShowLocationDropdown()" onblur="hideLocationDropdown()" />

      <!-- Ú©Ø´ÙˆÛŒ Ù…Ø­Ù„ (ÙÙ‚Ø· Ù‡Ù†Ú¯Ø§Ù… focus Ø±ÙˆÛŒ searchInput ÛŒØ§ addTag) -->
      <div class="custom-select-container" style="position:relative; margin-top:6px;">
        <div class="custom-select-dropdown hidden" id="searchLocationDropdown"></div>
      </div>

      <button onclick="searchOrAdd()">ğŸ” Ø¬Ø³ØªØ¬Ùˆ / Ø§ÙØ²ÙˆØ¯Ù†</button>
    </div>

    <!-- Tab: Ú¯Ø²Ø§Ø±Ø´Ø§Øª -->
    <div class="tab-content" id="tab-reports">
      <h3>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§</h3>

      <div class="report-filter">
        <input type="text" id="reportGlobalSearch" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§..." oninput="applyReportFilters()" />
        <select id="reportSearchColumn" onchange="applyReportFilters()">
          <option value="all">Ù‡Ù…Ù‡ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§</option>
          <option value="0">Ø¨Ø§Ø±Ú©Ø¯</option>
          <option value="1">Ù†Ø§Ù… Ú©Ø§Ù„Ø§</option>
          <option value="6">ØªÚ¯</option>
          <option value="7">ØªÛŒÙ…</option>
          <option value="8">Ù…Ø­Ù„</option>
          <option value="9">Ù…ÙˆØ¬ÙˆØ¯ÛŒ</option>
          <option value="10">ØªÙˆØ¶ÛŒØ­Ø§Øª</option>
        </select>
      </div>

      <div class="report-card">
        <h4>ğŸ”´ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´ Û± (ØºÛŒØ±ØµÙØ±)</h4>
        <div class="table-container">
          <table class="table" id="disc1Table">
            <thead><tr><th>Ø¨Ø§Ø±Ú©Ø¯</th><th>Ù†Ø§Ù…</th><th>ØªÚ¯</th><th>Ù…Ø­Ù„</th><th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th><th>Ø´Ù…Ø§Ø±Ø´Û±</th><th>Ù…ØºØ§ÛŒØ±Øª</th></tr></thead>
            <tbody><tr><td colspan="7" style="text-align:center;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="report-card" style="margin-top:16px;">
        <h4>ğŸŸ  Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´ Û² (ØºÛŒØ±ØµÙØ±)</h4>
        <div class="table-container">
          <table class="table" id="disc2Table">
            <thead><tr><th>Ø¨Ø§Ø±Ú©Ø¯</th><th>Ù†Ø§Ù…</th><th>ØªÚ¯</th><th>Ù…Ø­Ù„</th><th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th><th>Ø´Ù…Ø§Ø±Ø´Û²</th><th>Ù…ØºØ§ÛŒØ±Øª</th></tr></thead>
            <tbody><tr><td colspan="7" style="text-align:center;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr></tbody>
          </table>
        </div>
      </div>

      <button onclick="exportDiscrepancies()" style="width:100%; margin-top:16px; background:#d32f2f;">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ (Ø§Ú©Ø³Ù„)</button>
    </div>

    <!-- Tab: ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
    <div class="tab-content" id="tab-settings">
      <h3>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</h3>

      <label>ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±:</label>
      <input type="text" id="settingUserName" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§" />

      <label>ğŸ‘¥ Ù†Ø§Ù… ØªÛŒÙ… (Ù¾ÛŒØ´â€ŒÙØ±Ø¶):</label>
      <input type="text" id="settingTeamName" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÛŒÙ… Ø§Ù„Ù" />

      <label>ğŸ“ Ù…Ø­Ù„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶:</label>
      <div class="custom-select-container">
        <input type="text" id="settingLocation" placeholder="Ù…Ø­Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." autocomplete="off" />
        <div class="custom-select-dropdown hidden" id="settingLocationDropdown"></div>
        <span class="select-arrow" onclick="toggleLocationDropdown('settings')">â–¼</span>
      </div>

      <label>ğŸ”¢ Ø­Ø¯Ø§Ù‚Ù„ Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="number" id="settingMinLength" min="4" max="50" value="14" />

      <label>ğŸ”¢ Ø­Ø¯Ø§Ú©Ø«Ø± Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="number" id="settingMaxLength" min="4" max="50" value="20" />

      <label class="secondary" style="margin-top:16px;">
        <input type="checkbox" id="searchByTag" /> 
        ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÚ¯ (Ø¨Ù‡â€ŒØ¬Ø§ÛŒ Ø¨Ø§Ø±Ú©Ø¯)
      </label>
      <p style="font-size:13px; color:#555; margin-top:4px; background:#f1f8e9; padding:8px; border-radius:6px;">
        ğŸ·ï¸ Â«ØªÚ¯Â» = Ø´Ù…Ø§Ø±Ù‡ ØªÚ¯ Ú©Ø§ØºØ°ÛŒ Ù†ØµØ¨â€ŒØ´Ø¯Ù‡ Ø±ÙˆÛŒ Ù…Ø­Ù„ Ø¯Ù¾Ùˆ Ú©Ø§Ù„Ø§ (Ù…Ø«Ø§Ù„: T-105)
      </p>

      <h4 style="margin:20px 0 8px;">ğŸ”„ ØªØºÛŒÛŒØ± Ø±ÙˆØ´ Ø§Ø³Ú©Ù†</h4>
      <button onclick="changeScanner()" class="secondary" style="width:100%;">ğŸ”„ ØªØºÛŒÛŒØ± Ø§Ø³Ú©Ù†Ø±</button>
      <p style="font-size:13px; margin-top:6px; color:#555;">
        âœ… Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: <strong>Gamma Scanner</strong> â€” <strong>Ø³Ø±ÛŒØ¹â€ŒØªØ±ÛŒÙ† Ø§Ø³Ú©Ù†Ø±</strong>ØŒ Ø¨Ø¯ÙˆÙ† ØªØ¨Ù„ÛŒØºØŒ <strong>Batch Scan</strong>ØŒ ZoomØŒ FlashØŒ Export CSVØŒ Ù‚Ø§Ø¨Ù„ÛŒØª Ø§Ø³Ú©Ù† QR Ø±Ù…Ø² ÙˆØ§ÛŒâ€ŒÙØ§ÛŒ Ùˆ Ú©ÙˆÙ¾Ù† (Ø·Ø¨Ù‚ ØªÙˆØµÛŒÙ Ø±Ø³Ù…ÛŒ Ø¯Ø± Ú¯ÙˆÚ¯Ù„â€ŒÙ¾Ù„ÛŒ).
      </p>

      <h4 style="margin:20px 0 8px;">ğŸ—ƒï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡</h4>
      <input type="file" id="excelFile" accept=".xlsx,.xls" style="width:100%; margin:6px 0;" />
      <button onclick="loadExcel()" style="width:100%; margin:6px 0;">ğŸ“¥ import Ø§Ú©Ø³Ù„</button>
      <button onclick="exportExcel()" style="width:100%; margin:6px 0; background:#1976d2;">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
      <button onclick="clearAll()" class="danger" style="width:100%; margin:6px 0;">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>

      <button onclick="saveSettings()" style="margin-top:20px; width:100%;">âœ… Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§ØµÙ„ÛŒ -->
  <div class="card" id="mainTableCard">
    <h3>Ù„ÛŒØ³Øª Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (<span id="totalCount">0</span> Ù…ÙˆØ±Ø¯)</h3>
    <input type="text" id="globalSearch" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù‡Ù…Ù‡ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§..." oninput="applyFilters()" style="margin-bottom:12px;" />

    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Ø¨Ø§Ø±Ú©Ø¯</th>
            <th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th>
            <th>Ø´Ù…Ø§Ø±Ø´Û±</th>
            <th>Ù…ØºØ§ÛŒØ±ØªÛ±</th>
            <th>Ø´Ù…Ø§Ø±Ø´Û²</th>
            <th>Ù…ØºØ§ÛŒØ±ØªÛ²</th>
            <th>ØªÚ¯</th>
            <th>ØªÛŒÙ…</th>
            <th>Ù…Ø­Ù„</th>
            <th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th>
            <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
            <th>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</th>
            <th>Ú©Ø§Ø±Ø¨Ø±</th>
            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
          </tr>
          <tr id="filterRow"></tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="14" style="text-align:center;">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§ (Ú©ÙˆØªØ§Ù‡â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ÙØ¶Ø§ â€” Ú©Ø§Ù…Ù„ Ø¯Ø± Ù†Ø³Ø®Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ) -->
  <div id="cameraModal" class="modal hidden">
    <div style="position:relative; width:100vw; height:100vh;">
      <video id="cameraVideo" playsinline></video>
      <div class="scanner-frame" style="top:25%;left:10%;width:80%;height:50%;border:3px solid #2196f3;box-shadow:0 0 0 9999px rgba(0,0,0,0.6);pointer-events:none;"></div>
      <div class="scan-hint" id="scanHint" style="position:absolute;top:8%;left:0;width:100%;text-align:center;color:white;font-size:16px;text-shadow:0 1px 4px #000;">ğŸ” Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ Ø¯Ø± Ú†Ù‡Ø§Ø±Ú†ÙˆØ¨ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.</div>
    </div>
    <div style="padding:16px; text-align:center;">
      <button onclick="stopCamera()" class="danger" style="width:auto; padding:12px 24px; font-size:16px;">â¹ï¸ ØªÙˆÙ‚Ù</button>
    </div>
  </div>

  <div id="addModal" class="modal hidden">
    <div class="modal-content">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
      <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="text" id="addBarcode" readonly />
      <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
      <input type="text" id="addName" />
      <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
      <input type="number" id="addStock" step="0.01" readonly />
      <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
      <input type="number" id="addCount1" step="0.01" inputmode="numeric" oninput="updateDiscrepancyAdd()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="addDisc1" class="discrepancy">â€”</span></div>
      <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
      <input type="number" id="addCount2" step="0.01" inputmode="numeric" oninput="updateDiscrepancyAdd()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="addDisc2" class="discrepancy">â€”</span></div>
      <label>ğŸ·ï¸ ØªÚ¯ (Ø´Ù…Ø§Ø±Ù‡ ØªÚ¯ Ú©Ø§ØºØ°ÛŒ):</label>
      <input type="text" id="addTag" onfocus="maybeShowLocationDropdown()" onblur="hideLocationDropdown()" />
      <label>ØªÛŒÙ…:</label>
      <input type="text" id="addTeam" readonly />
      <label>ğŸ“ Ù…Ø­Ù„:</label>
      <input type="text" id="addLocation" readonly />
      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea id="addNotes" rows="2"></textarea>
      <div style="display:flex; gap:8px; margin-top:16px;">
        <button onclick="saveAdd()" style="flex:1;">âœ… Ø§ÙØ²ÙˆØ¯Ù†</button>
        <button onclick="closeAddModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
      </div>
    </div>
  </div>

  <div id="editModal" class="modal hidden">
    <div class="modal-content">
      <h3>ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù„Ø§</h3>
      <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="text" id="editBarcode" readonly />
      <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
      <input type="text" id="editName" />
      <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
      <input type="number" id="editStock" step="0.01" readonly />
      <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
      <input type="number" id="editCount1" step="0.01" inputmode="numeric" oninput="updateDiscrepancyEdit()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="editDisc1" class="discrepancy">â€”</span></div>
      <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
      <input type="number" id="editCount2" step="0.01" inputmode="numeric" oninput="updateDiscrepancyEdit()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="editDisc2" class="discrepancy">â€”</span></div>
      <label>ğŸ·ï¸ ØªÚ¯ (Ø´Ù…Ø§Ø±Ù‡ ØªÚ¯ Ú©Ø§ØºØ°ÛŒ):</label>
      <input type="text" id="editTag" />
      <label>ØªÛŒÙ…:</label>
      <input type="text" id="editTeam" readonly />
      <label>ğŸ“ Ù…Ø­Ù„:</label>
      <input type="text" id="editLocation" readonly />
      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea id="editNotes" rows="2"></textarea>
      <div style="display:flex; gap:8px; margin-top:16px;">
        <button onclick="saveEdit()" style="flex:1;">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
        <button onclick="closeEditModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
      </div>
    </div>
  </div>

  <div id="calcModal" class="modal hidden">
    <div class="modal-content">
      <h3>Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨</h3>
      <input type="text" id="calcDisplay" class="calc-display" inputmode="numeric" />
      <div style="display:grid; grid-template-columns: repeat(4,1fr); gap:6px; margin-top:10px;">
        <button class="calc-btn" onclick="calcAppend('7')">7</button>
        <button class="calc-btn" onclick="calcAppend('8')">8</button>
        <button class="calc-btn" onclick="calcAppend('9')">9</button>
        <button class="calc-btn" onclick="calcAppend('/')">Ã·</button>
        <button class="calc-btn" onclick="calcAppend('4')">4</button>
        <button class="calc-btn" onclick="calcAppend('5')">5</button>
        <button class="calc-btn" onclick="calcAppend('6')">6</button>
        <button class="calc-btn" onclick="calcAppend('*')">Ã—</button>
        <button class="calc-btn" onclick="calcAppend('1')">1</button>
        <button class="calc-btn" onclick="calcAppend('2')">2</button>
        <button class="calc-btn" onclick="calcAppend('3')">3</button>
        <button class="calc-btn" onclick="calcAppend('-')">âˆ’</button>
        <button class="calc-btn" onclick="calcAppend('0')">0</button>
        <button class="calc-btn" onclick="calcAppend('.')">.</button>
        <button class="calc-btn" onclick="calcBackspace()">âŒ«</button>
        <button class="calc-btn" onclick="calcAppend('+')">+</button>
      </div>
      <button class="calc-btn calc-apply" onclick="calcApply()">âœ… Ø§Ø¹Ù…Ø§Ù„</button>
      <button class="secondary" style="width:100%; margin-top:10px; padding:14px; font-size:18px;" 
              onclick="closeCalcModal()">âŒ Ù„ØºÙˆ</button>
    </div>
  </div>

  <script>
    // === ØªÙ†Ø¸ÛŒÙ…Ø§Øª ===
    let settings = JSON.parse(localStorage.getItem('appSettings')) || {
      userName: 'Ú©Ø§Ø±Ø¨Ø±',
      teamName: '',
      location: '',
      minLength: 14,
      maxLength: 20,
      searchByTag: false
    };

    let items = JSON.parse(localStorage.getItem('items')) || [];
    let currentEditIndex = -1;
    let currentDropdown = null;
    let LAST_SCAN_METHOD = localStorage.getItem('scanner') || 'camera';

    let barcodeDetector = null;
    let videoStream = null;
    let scanInterval = null;

    // === Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ===
    document.addEventListener('DOMContentLoaded', () => {
      // ØªØ¨â€ŒÙ‡Ø§
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
          if (btn.dataset.tab === 'reports') renderDiscrepancyReports();
        });
      });

      // UI ØªÙ†Ø¸ÛŒÙ…Ø§Øª
      document.getElementById('settingUserName').value = settings.userName;
      document.getElementById('settingTeamName').value = settings.teamName;
      document.getElementById('settingLocation').value = settings.location;
      document.getElementById('settingMinLength').value = settings.minLength;
      document.getElementById('settingMaxLength').value = settings.maxLength;
      document.getElementById('searchByTag').checked = settings.searchByTag;

      // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI Ø¬Ø³ØªØ¬Ùˆ
      updateSearchUI();
      updateCurrentLocation();
      renderTable();
      renderFilterRow();
      renderDiscrepancyReports();
    });

    // âœ… ÙÙ‚Ø· Ù†Ù…Ø§ÛŒØ´ Ù…Ø­Ù„ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª
    function updateCurrentLocation() {
      document.getElementById('currentLocation').value = settings.location || 'â€”';
    }

    function updateSearchUI() {
      const searchByTag = settings.searchByTag;
      const input = document.getElementById('searchInput');
      const scanContainer = document.getElementById('scanButtonContainer');

      if (searchByTag) {
        input.placeholder = "ØªÚ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: T-105)";
        scanContainer.classList.add('hidden');
      } else {
        input.placeholder = "Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯";
        scanContainer.classList.remove('hidden');
      }
    }

    // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
    function saveSettings() {
      const user = document.getElementById('settingUserName').value.trim() || 'Ú©Ø§Ø±Ø¨Ø±';
      const team = document.getElementById('settingTeamName').value.trim();
      const loc = document.getElementById('settingLocation').value.trim();
      const min = parseInt(document.getElementById('settingMinLength').value) || 14;
      const max = parseInt(document.getElementById('settingMaxLength').value) || 20;
      const searchByTag = document.getElementById('searchByTag').checked;

      if (min > max) return alert('âš ï¸ Ø­Ø¯Ø§Ù‚Ù„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø­Ø¯Ø§Ú©Ø«Ø± Ø¨Ø§Ø´Ø¯.');
      settings = { userName: user, teamName: team, location: loc, minLength: min, maxLength: max, searchByTag };
      localStorage.setItem('appSettings', JSON.stringify(settings));
      updateSearchUI();
      updateCurrentLocation();
      alert('âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
    }

    // --- Ù…Ø­Ù„â€ŒÙ‡Ø§ (ÙÙ‚Ø· Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª) ---
    function getLocations() {
      const set = new Set([settings.location]);
      items.forEach(r => { const loc = (r[8] || '').trim(); if (loc) set.add(loc); });
      return Array.from(set).filter(x => x).sort();
    }

    function renderDropdown(dropdownId, locations) {
      const el = document.getElementById(dropdownId);
      if (!el) return;
      el.innerHTML = locations.length 
        ? locations.map(l => `<div class="custom-select-option" onclick="selectLocation('${l.replace(/'/g,"\\'")}','${dropdownId}')">${l}</div>`).join('')
        : '<div class="custom-select-option" style="color:#999;">Ù…Ø­Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
    }

    function toggleLocationDropdown(context) {
      hideAllDropdowns();
      const id = context === 'settings' ? 'settingLocationDropdown' : 'searchLocationDropdown';
      const el = document.getElementById(id);
      if (el.classList.contains('hidden')) {
        renderDropdown(id, getLocations());
        el.classList.remove('hidden');
        currentDropdown = id;
      }
    }

    function maybeShowLocationDropdown() {
      // ÙÙ‚Ø· Ø§Ú¯Ø± ÙÛŒÙ„Ø¯ search ÛŒØ§ addTag focus Ø´Ø¯
      if (document.activeElement.id === 'searchInput' || document.activeElement.id === 'addTag') {
        const el = document.getElementById('searchLocationDropdown');
        renderDropdown('searchLocationDropdown', getLocations());
        el.classList.remove('hidden');
        currentDropdown = 'searchLocationDropdown';
      }
    }

    function hideLocationDropdown() {
      setTimeout(() => {
        if (document.activeElement.id !== 'searchInput' && document.activeElement.id !== 'addTag') {
          const el = document.getElementById('searchLocationDropdown');
          el.classList.add('hidden');
          currentDropdown = null;
        }
      }, 150);
    }

    function hideAllDropdowns() {
      ['settingLocationDropdown','searchLocationDropdown'].forEach(id=>{
        const e=document.getElementById(id); if(e) e.classList.add('hidden');
      });
      currentDropdown = null;
    }

    function selectLocation(loc, dropdownId) {
      if (dropdownId === 'settingLocationDropdown') {
        document.getElementById('settingLocation').value = loc;
      } else if (dropdownId === 'searchLocationDropdown') {
        // Ø¯Ø± Ø­Ø§Ù„Øª Ø¬Ø³ØªØ¬ÙˆÛŒ ØªÚ¯ØŒ Ù…Ø­Ù„ Ø±Ø§ Ø¯Ø± searchInput Ù†Ù…ÛŒâ€ŒØ°Ø§Ø±ÛŒÙ… â€” ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù†
        // ÙˆÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒÙ… Ø¯Ø± Ù…Ø¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø± Ú©Ù†ÛŒÙ…
      }
      hideAllDropdowns();
    }

    // --- ØªØ¨ Ú¯Ø²Ø§Ø±Ø´Ø§Øª â€” Ø¨Ø§ ÙÛŒÙ„ØªØ± Ø³ØªÙˆÙ†ÛŒ ---
    function applyReportFilters() {
      renderDiscrepancyReports();
    }

    function renderDiscrepancyReports() {
      const global = document.getElementById('reportGlobalSearch').value.toLowerCase();
      const colIndex = document.getElementById('reportSearchColumn').value;

      const disc1Items = items.filter(r => Math.abs(parseFloat(r[3])) > 0.001);
      const disc2Items = items.filter(r => Math.abs(parseFloat(r[5])) > 0.001);

      const filterItems = (list) => {
        return list.filter(row => {
          if (!global) return true;
          if (colIndex === 'all') {
            return row.some(cell => String(cell).toLowerCase().includes(global));
          } else {
            const idx = parseInt(colIndex);
            return String(row[idx] || '').toLowerCase().includes(global);
          }
        });
      };

      const d1 = filterItems(disc1Items);
      const d2 = filterItems(disc2Items);

      renderReportTable('disc1Table', d1, [0,1,6,8,9,2,3]);
      renderReportTable('disc2Table', d2, [0,1,6,8,9,4,5]);
    }

    function renderReportTable(tableId, data, cols) {
      const t = document.getElementById(tableId).querySelector('tbody');
      if (data.length === 0) {
        t.innerHTML = `<tr><td colspan="${cols.length}" style="text-align:center;">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>`;
        return;
      }

      // ØªØ´Ø®ÛŒØµ duplicate ØªÚ¯+Ù…Ø­Ù„
      const dupTagLoc = {};
      data.forEach(r => {
        const key = `${r[6]}|${r[8]}`;
        dupTagLoc[key] = (dupTagLoc[key] || 0) + 1;
      });

      t.innerHTML = data.map(r => {
        const key = `${r[6]}|${r[8]}`;
        const dupClass = dupTagLoc[key] > 1 ? ' class="tag-location-dup"' : '';
        return `<tr>
          <td${dupClass}>${r[cols[0]]}</td>
          <td>${r[cols[1]]}</td>
          <td${dupClass}>${r[cols[2]]}</td>
          <td${dupClass}>${r[cols[3]]}</td>
          <td>${r[cols[4]]}</td>
          <td>${r[cols[5]]}</td>
          <td class="discrepancy">${r[cols[6]]}</td>
        </tr>`;
      }).join('');
    }

    function exportDiscrepancies() {
      const disc1 = items.filter(r => Math.abs(parseFloat(r[3])) > 0.001);
      const disc2 = items.filter(r => Math.abs(parseFloat(r[5])) > 0.001);

      const wsData = [
        ['--- Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´ Û± ---'],
        ['Ø¨Ø§Ø±Ú©Ø¯','Ù†Ø§Ù… Ú©Ø§Ù„Ø§','ØªÚ¯','Ù…Ø­Ù„','Ù…ÙˆØ¬ÙˆØ¯ÛŒ','Ø´Ù…Ø§Ø±Ø´Û±','Ù…ØºØ§ÛŒØ±ØªÛ±'],
        ...disc1.map(r => [r[0], r[1], r[6], r[8], r[9], r[2], r[3]]),
        [],
        ['--- Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´ Û² ---'],
        ['Ø¨Ø§Ø±Ú©Ø¯','Ù†Ø§Ù… Ú©Ø§Ù„Ø§','ØªÚ¯','Ù…Ø­Ù„','Ù…ÙˆØ¬ÙˆØ¯ÛŒ','Ø´Ù…Ø§Ø±Ø´Û²','Ù…ØºØ§ÛŒØ±ØªÛ²'],
        ...disc2.map(r => [r[0], r[1], r[6], r[8], r[9], r[4], r[5]])
      ];

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§');
      XLSX.writeFile(wb, 'Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ÛŒ_Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ.xlsx');
    }

    // --- Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® ---
    function renderTable() {
      document.getElementById('totalCount').textContent = items.length;
      items.sort((a, b) => parseFaDateTime(b[11]) - parseFaDateTime(a[11]));
      applyFilters();
    }

    function parseFaDateTime(faStr) {
      if (!faStr) return 0;
      const time = faStr.split(' ').pop();
      const [h, m, s] = time.split(':').map(x => parseInt(x) || 0);
      const d = new Date();
      d.setHours(h, m, s, 0);
      return d.getTime();
    }

    // --- Ø§Ø³Ú©Ù†Ø±Ù‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ÛŒ ---
    const SCANNERS = [
      { id: 'camera', name: 'ğŸ“¸ Ø§Ø³Ú©Ù† Ø¨Ø§ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø§Ø®Ù„ÛŒ' },
      { id: 'gamma', name: 'Gamma Barcode Scanner', 
        intent: 'intent://scan/#Intent;scheme=scan;package=com.gamma.scan;end;' },
      { id: 'zxing', name: 'ZXing Barcode Scanner', 
        intent: 'intent://scan/#Intent;scheme=zxing;package=com.google.zxing.client.android;end;' },
      { id: 'easy', name: 'Easy Barcode Scanner',
        intent: 'intent://scan/#Intent;scheme=scan;package=com.tecace.easybarcodescanner;end;' }
    ];

    function changeScanner() {
      let msg = 'Ø±ÙˆØ´ Ø§Ø³Ú©Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\n\n';
      SCANNERS.forEach((s, i) => msg += `${i+1}. ${s.name}\n`);
      msg += '\nØ´Ù…Ø§Ø±Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: 1):';
      const choice = prompt(msg, '1');
      const idx = Math.max(0, parseInt(choice) - 1);
      const sel = SCANNERS[idx] || SCANNERS[0];
      LAST_SCAN_METHOD = sel.id;
      localStorage.setItem('scanner', sel.id);
      alert(`âœ… Ø§Ø³Ú©Ù†Ø±: ${sel.name}`);
    }

    function startScan() {
      if (settings.searchByTag) {
        alert('âš ï¸ Ø¯Ø± Ø­Ø§Ù„Øª Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÚ¯ØŒ Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª.');
        return;
      }
      if (LAST_SCAN_METHOD === 'camera') {
        startCameraScan();
      } else {
        const s = SCANNERS.find(x => x.id === LAST_SCAN_METHOD);
        if (s && s.intent) {
          const w = window.open(s.intent, '_self');
          if (!w) alert(`âŒ Â«${s.name}Â» Ù†ØµØ¨ Ù†ÛŒØ³Øª.`);
        }
      }
    }

    async function startCameraScan() {
      if (!("BarcodeDetector" in window)) {
        alert("âŒ Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Ø§Ø³Ú©Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } }
        });
        videoStream = stream;
        const video = document.getElementById('cameraVideo');
        video.srcObject = stream;
        barcodeDetector = new BarcodeDetector({ formats: ['qr_code','ean_13','code_128'] });
        document.getElementById('cameraModal').classList.remove('hidden');
        video.play();

        const interval = setInterval(async () => {
          if (!barcodeDetector || !video.srcObject || video.paused) return;
          try {
            const barcodes = await barcodeDetector.detect(video);
            if (barcodes.length === 0) return;
            const value = (barcodes[0].rawValue || '').trim();
            if (!value || value.length < settings.minLength || value.length > settings.maxLength) return;
            clearInterval(interval);
            stopCamera();
            document.getElementById('searchInput').value = value;
            setTimeout(searchOrAdd, 150);
          } catch (e) {}
        }, 350);
      } catch (err) { alert("âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø¯ Ø´Ø¯."); }
    }

    function stopCamera() {
      const modal = document.getElementById('cameraModal');
      modal.classList.add('hidden');
      if (videoStream) videoStream.getTracks().forEach(t => t.stop());
      videoStream = null;
      barcodeDetector = null;
    }

    // --- import/export ---
    function loadExcel() { /* ... */ }
    function exportExcel() { /* ... */ }
    function clearAll() { /* ... */ }

    // --- Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ Ø¬Ø³ØªØ¬Ùˆ ---
    function searchOrAdd() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return alert('Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');

      if (settings.searchByTag) {
        const matches = items.filter(r => r[6] === query && r[8] === settings.location);
        if (matches.length > 0) {
          const idx = items.findIndex(r => r[6] === query && r[8] === settings.location);
          openEditModal(idx);
        } else {
          openAddModal('', query);
        }
      } else {
        if (query.length < settings.minLength || query.length > settings.maxLength) {
          alert(`âŒ Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯ (${query.length}) Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ (${settings.minLength}â€“${settings.maxLength}) Ø§Ø³Øª.`);
          return;
        }
        const idx = items.findIndex(r => r[0] === query && r[8] === settings.location);
        if (idx !== -1) openEditModal(idx);
        else openAddModal(query);
      }
    }

    // --- Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ â€” Ø¨Ø§ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ù…ÛŒØ´Ú¯ÛŒ ØªÛŒÙ…/Ú©Ø§Ø±Ø¨Ø± Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
    function openAddModal(bc, tag = '') {
      document.getElementById('addBarcode').value = bc;
      document.getElementById('addTag').value = tag;
      document.getElementById('addTeam').value = settings.teamName;
      document.getElementById('addLocation').value = settings.location;
      document.getElementById('addStock').value = 0;
      document.getElementById('addCount1').value = 0;
      document.getElementById('addCount2').value = '';
      document.getElementById('addNotes').value = '';
      updateDiscrepancyAdd();
      document.getElementById('addModal').classList.remove('hidden');
    }

    function saveAdd() {
      const bc = document.getElementById('addBarcode').value.trim();
      const name = document.getElementById('addName').value.trim();
      const stock = parseFloat(document.getElementById('addStock').value) || 0;
      const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
      const c2Raw = document.getElementById('addCount2').value;
      const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;
      const disc1 = (c1 - stock).toFixed(2);
      const disc2 = (c2 - stock).toFixed(2);

      items.push([
        bc, name, c1, disc1, c2, disc2,
        document.getElementById('addTag').value.trim(),
        settings.teamName, // âœ… Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª
        settings.location, // âœ… Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª
        stock,
        document.getElementById('addNotes').value.trim(),
        getNowFa(),
        settings.userName // âœ… Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª
      ]);

      localStorage.setItem('items', JSON.stringify(items));
      renderTable();
      renderDiscrepancyReports();
      closeAddModal();
      document.getElementById('searchInput').value = '';
    }

    function openEditModal(idx) {
      currentEditIndex = idx;
      const r = items[idx];
      document.getElementById('editBarcode').value = r[0];
      document.getElementById('editName').value = r[1];
      document.getElementById('editStock').value = r[9];
      document.getElementById('editCount1').value = r[2];
      document.getElementById('editCount2').value = r[4] || '';
      document.getElementById('editTag').value = r[6];
      document.getElementById('editTeam').value = r[7]; // ÙÙ‚Ø· Ù†Ù…Ø§ÛŒØ´ â€” Ø¯Ø± saveEdit Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
      document.getElementById('editLocation').value = r[8];
      document.getElementById('editNotes').value = r[10];
      updateDiscrepancyEdit();
      document.getElementById('editModal').classList.remove('hidden');
    }

    function saveEdit() {
      if (currentEditIndex < 0) return;
      const r = [...items[currentEditIndex]];
      const stock = parseFloat(document.getElementById('editStock').value) || 0;
      const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
      const c2Raw = document.getElementById('editCount2').value;
      const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;

      r[1] = document.getElementById('editName').value.trim();
      r[2] = c1;
      r[4] = c2;
      r[6] = document.getElementById('editTag').value.trim();
      r[7] = settings.teamName; // âœ… Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª
      r[8] = settings.location; // âœ… Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª
      r[10] = document.getElementById('editNotes').value.trim();
      r[9] = stock;
      r[11] = getNowFa();       // âœ… Ù‡Ù…ÛŒØ´Ù‡ Ø¬Ø¯ÛŒØ¯
      r[12] = settings.userName; // âœ… Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª

      r[3] = (c1 - stock).toFixed(2);
      r[5] = (c2 - stock).toFixed(2);

      items[currentEditIndex] = r;
      localStorage.setItem('items', JSON.stringify(items));
      renderTable();
      renderDiscrepancyReports();
      closeEditModal();
      document.getElementById('searchInput').value = '';
    }

    // --- Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ (applyFilters, getNowFa, Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨, duplicate detection) ---
    function getNowFa() {
      return new Intl.DateTimeFormat('fa-IR', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      }).format(new Date()).replace(/ØŒ/g, ' ');
    }

    function applyFilters() {
      const global = document.getElementById('globalSearch').value.toLowerCase();
      const filtered = items.filter(row => 
        global ? row.some(cell => String(cell).toLowerCase().includes(global)) : true
      );
      renderTableBody(filtered);
    }

    function renderTableBody(data) {
      const t = document.getElementById('tableBody');
      if (data.length === 0) {
        t.innerHTML = '<tr><td colspan="14" style="text-align:center;">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>';
        return;
      }

      // duplicate: Ø¨Ø§Ø±Ú©Ø¯+Ù…Ø­Ù„ Ùˆ ØªÚ¯+Ù…Ø­Ù„
      const dupBC = {}, dupTagLoc = {};
      data.forEach(r => {
        const k1 = r[0] + '|' + r[8];
        const k2 = r[6] + '|' + r[8];
        dupBC[k1] = (dupBC[k1] || 0) + 1;
        dupTagLoc[k2] = (dupTagLoc[k2] || 0) + 1;
      });

      t.innerHTML = data.map((r, i) => {
        const k1 = r[0] + '|' + r[8];
        const k2 = r[6] + '|' + r[8];
        const dupClass = dupBC[k1] > 1 ? ' class="duplicate"' : '';
        const tagLocClass = dupTagLoc[k2] > 1 ? ' class="tag-location-dup"' : '';
        const idx = items.findIndex(x => x[0]===r[0] && x[8]===r[8]);
        return `<tr>
          <td${dupClass}>${r[0]}</td>
          <td${dupClass}>${r[1]}</td>
          <td>${r[2]}</td>
          <td class="discrepancy">${r[3]}</td>
          <td>${r[4]}</td>
          <td class="discrepancy">${r[5]}</td>
          <td${tagLocClass}>${r[6]}</td>
          <td>${r[7]}</td>
          <td${dupClass}${tagLocClass}>${r[8]}</td>
          <td>${parseFloat(r[9]).toLocaleString('fa-IR')}</td>
          <td>${r[10]}</td>
          <td>${r[11]}</td>
          <td>${r[12]}</td>
          <td class="actions">
            <button class="btn-icon" style="background:#1976d2;" onclick="openEditModal(${idx})">âœï¸</button>
            <button class="btn-icon danger" onclick="removeItem(${idx})">ğŸ—‘ï¸</button>
          </td>
        </tr>`;
      }).join('');
    }

    function renderFilterRow() { /* ... */ }
    function removeItem(i) { /* ... */ }

    // --- Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ ---
    let CURRENT_CALC_TARGET = null;
    function openCalc(id) { CURRENT_CALC_TARGET = id; document.getElementById('calcDisplay').value = ''; document.getElementById('calcModal').classList.remove('hidden'); }
    function calcAppend(c) { document.getElementById('calcDisplay').value += c; }
    function calcBackspace() { const e = document.getElementById('calcDisplay'); e.value = e.value.slice(0, -1); }
    function calcApply() {
      const expr = document.getElementById('calcDisplay').value;
      if (!expr.trim()) return alert('Ø¹Ø¨Ø§Ø±ØªÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
      const safe = expr.replace(/[^0-9+\-*/().\sÃ·Ã—]/g, '').replace(/Ã·/g, '/').replace(/Ã—/g, '*');
      try {
        const r = new Function('return (' + safe + ')')();
        if (isNaN(r) || !isFinite(r)) throw '';
        const t = document.getElementById(CURRENT_CALC_TARGET);
        t.value = parseFloat(r).toFixed(2);
        if (CURRENT_CALC_TARGET.startsWith('add')) updateDiscrepancyAdd();
        else if (CURRENT_CALC_TARGET.startsWith('edit')) updateDiscrepancyEdit();
        closeCalcModal();
      } catch (e) { alert('Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.'); }
    }
    function closeCalcModal() { 
      document.getElementById('calcModal').classList.add('hidden'); 
      CURRENT_CALC_TARGET = null; 
    }

    function updateDiscrepancyAdd() { /* ... */ }
    function updateDiscrepancyEdit() { /* ... */ }

    function closeAddModal() { document.getElementById('addModal').classList.add('hidden'); }
    function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); currentEditIndex = -1; }

    console.log('âœ… Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ v3 â€” Ø¨Ø§ Ù…Ø­Ù„ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§ØªØŒ Ú¯Ø²Ø§Ø±Ø´ ÙÛŒÙ„ØªØ±Ø´Ø¯Ù‡ØŒ ØªÚ¯=Ø´Ù…Ø§Ø±Ù‡ ØªÚ¯ Ú©Ø§ØºØ°ÛŒØŒ Ùˆ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ ØªÛŒÙ…/Ú©Ø§Ø±Ø¨Ø±.');
  </script>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</body>
</html>
