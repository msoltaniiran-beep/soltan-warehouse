let settings = JSON.parse(localStorage.getItem('appSettings')) || {
  userName: 'Ú©Ø§Ø±Ø¨Ø±',
  teamName: '',
  defaultLocation: '',
  minLength: 14,
  maxLength: 20,
  searchByTag: false
};

// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† URL ÙˆØ¨ Ø§Ù¾ Google Apps Script
const SHEETS_API_URL = 'YOUR_WEB_APP_URL_HERE'; // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ Ø¨Ø§ URL ÙˆØ§Ù‚Ø¹ÛŒ
let items = [];
let filters = {};
let currentEditIndex = -1;
let currentDropdown = null;
let LAST_SCAN_METHOD = localStorage.getItem('scanner') || 'camera';
let barcodeDetector = null;
let videoStream = null;
let scanInterval = null;
let lastScannedValue = '';
let stableScanCount = 0;
let zoomLevel = 1.0;

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Google Sheets
async function loadDataFromSheets() {
  try {
    const response = await fetch(SHEETS_API_URL);
    const data = await response.json();
    
    if (data.error) {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ:', data.error);
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Google Sheets');
      return [];
    }
    
    return data;
  } catch (error) {
    console.error('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡:', error);
    alert('Ø¹Ø¯Ù… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ Ø³Ø±ÙˆØ±');
    return [];
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Google Sheets
async function saveDataToSheets() {
  try {
    const response = await fetch(SHEETS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: items })
    });
    
    const result = await response.json();
    
    if (result.error) {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡:', result.error);
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Google Sheets');
      return false;
    }
    
    console.log('âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯:', result);
    return true;
  } catch (error) {
    console.error('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡:', error);
    alert('Ø¹Ø¯Ù… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ Ø³Ø±ÙˆØ±');
    return false;
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡/Ø¢Ù¾Ø¯ÛŒØª ÛŒÚ© Ø¢ÛŒØªÙ…
async function saveOrUpdateItem(itemData) {
  try {
    const response = await fetch(SHEETS_API_URL, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(itemData)
    });
    
    const result = await response.json();
    
    if (result.error) {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¢ÛŒØªÙ…:', result.error);
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¢ÛŒØªÙ…');
      return false;
    }
    
    console.log('âœ… Ø¢ÛŒØªÙ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯:', result);
    return result;
  } catch (error) {
    console.error('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡:', error);
    alert('Ø¹Ø¯Ù… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ Ø³Ø±ÙˆØ±');
    return false;
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÛŒÚ© Ø¢ÛŒØªÙ…
async function deleteItemFromSheets(barcode, location) {
  try {
    const response = await fetch(SHEETS_API_URL, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ barcode, location })
    });
    
    const result = await response.json();
    
    if (result.error) {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¢ÛŒØªÙ…:', result.error);
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¢ÛŒØªÙ…');
      return false;
    }
    
    console.log('âœ… Ø¢ÛŒØªÙ… Ø­Ø°Ù Ø´Ø¯:', result);
    return true;
  } catch (error) {
    console.error('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡:', error);
    alert('Ø¹Ø¯Ù… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ Ø³Ø±ÙˆØ±');
    return false;
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² localStorage
  document.getElementById('settingUserName').value = settings.userName;
  document.getElementById('settingTeamName').value = settings.teamName;
  document.getElementById('settingDefaultLocation').value = settings.defaultLocation;
  document.getElementById('settingMinLength').value = settings.minLength;
  document.getElementById('settingMaxLength').value = settings.maxLength;
  document.getElementById('searchByTag').checked = settings.searchByTag;
  
  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Google Sheets
  items = await loadDataFromSheets();
  
  // Ø§Ø¯Ø§Ù…Ù‡ Ú©Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯...
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      if (btn.dataset.tab === 'reports') renderDiscrepancyReports();
    });
  });

  if (!settings.defaultLocation) {
    settings.defaultLocation = 'Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ';
    localStorage.setItem('appSettings', JSON.stringify(settings));
  }

  document.getElementById('searchByTag').addEventListener('change', function() {
    settings.searchByTag = this.checked;
    updateSearchUI();
  });

  document.getElementById('globalLocationDisplay').textContent = settings.defaultLocation;
  updateSearchUI();
  renderTable();
  renderFilterRow();
  renderDiscrepancyReports();

  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø¨Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¹Ø¯Ø¯ÛŒ
  ['addCount1','addCount2','editCount1','editCount2'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      const wrap = document.createElement('div');
      wrap.style.position = 'relative';
      el.parentNode.insertBefore(wrap, el);
      wrap.appendChild(el);
      const btn = document.createElement('button');
      btn.innerHTML = 'ðŸ§®';
      btn.style.cssText = 
        'position:absolute;left:12px;top:50%;transform:translateY(-50%);' +
        'background:#e0e0e0;border:none;width:40px;height:40px;' +
        'border-radius:10px;cursor:pointer;font-size:20px;font-weight:bold;';
      btn.onclick = () => openCalc(id);
      wrap.appendChild(btn);
      el.style.paddingLeft = '60px';
    }
  });

  const params = new URLSearchParams(window.location.search);
  const bc = params.get('SCAN_RESULT')?.trim() || params.get('barcode')?.trim();
  if (bc && !settings.searchByTag) {
    document.getElementById('searchInput').value = bc;
    setTimeout(searchOrAdd, 150);
  }
});

// ØªØ§Ø¨Ø¹ saveAdd Ø¨Ø§ ØªØºÛŒÛŒØ± Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets
async function saveAdd() {
  const bc = document.getElementById('addBarcode').value.trim();
  const name = document.getElementById('addName').value.trim();
  const stock = parseFloat(document.getElementById('addStock').value) || 0;
  const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
  const c2Raw = document.getElementById('addCount2').value;
  const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;
  const disc1 = (c1 - stock).toFixed(2);
  const disc2 = calculateDiscrepancy2(stock, c2Raw, disc1);
  
  const itemData = {
    barcode: bc,
    name: name,
    count1: c1,
    discrepancy1: disc1,
    count2: c2,
    discrepancy2: disc2,
    tag: document.getElementById('addTag').value.trim(),
    team: settings.teamName,
    location: document.getElementById('addLocation').value.trim(),
    stock: stock,
    notes: document.getElementById('addNotes').value.trim(),
    lastUpdate: getNowFa(),
    user: settings.userName
  };
  
  const result = await saveOrUpdateItem(itemData);
  
  if (result) {
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±
    items = await loadDataFromSheets();
    renderTable();
    renderDiscrepancyReports();
    closeAddModal();
    document.getElementById('searchInput').value = '';
  }
}

// ØªØ§Ø¨Ø¹ saveEdit Ø¨Ø§ ØªØºÛŒÛŒØ± Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets
async function saveEdit() {
  if (currentEditIndex < 0) return;
  
  const r = items[currentEditIndex];
  const stock = parseFloat(document.getElementById('editStock').value) || 0;
  const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
  const c2Raw = document.getElementById('editCount2').value;
  const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;
  
  const itemData = {
    barcode: r[0],
    name: document.getElementById('editName').value.trim(),
    count1: c1,
    discrepancy1: (c1 - stock).toFixed(2),
    count2: c2,
    discrepancy2: calculateDiscrepancy2(stock, c2Raw, (c1 - stock).toFixed(2)),
    tag: document.getElementById('editTag').value.trim(),
    team: settings.teamName,
    location: document.getElementById('editLocation').value.trim(),
    stock: stock,
    notes: document.getElementById('editNotes').value.trim(),
    lastUpdate: getNowFa(),
    user: settings.userName
  };
  
  const result = await saveOrUpdateItem(itemData);
  
  if (result) {
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±
    items = await loadDataFromSheets();
    renderTable();
    renderDiscrepancyReports();
    closeEditModal();
    document.getElementById('searchInput').value = '';
  }
}

// ØªØ§Ø¨Ø¹ removeItem Ø¨Ø§ ØªØºÛŒÛŒØ± Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ø§Ø² Google Sheets
async function removeItem(i) {
  if (confirm('Ø§ÛŒÙ† Ø±Ø¯ÛŒÙ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
    const item = items[i];
    const success = await deleteItemFromSheets(item[0], item[8]);
    
    if (success) {
      // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±
      items = await loadDataFromSheets();
      renderTable();
      renderDiscrepancyReports();
    }
  }
}

// ØªØ§Ø¨Ø¹ clearAll Ø¨Ø§ ØªØºÛŒÛŒØ± Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ø§Ø² Google Sheets
async function clearAll() {
  if (confirm('âš ï¸ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ')) {
    // Ø°Ø®ÛŒØ±Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ Ø®Ø§Ù„ÛŒ Ø¯Ø± Google Sheets
    items = [];
    await saveDataToSheets();
    
    renderTable();
    renderDiscrepancyReports();
    alert('âœ… ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.');
  }
}

// ØªØ§Ø¨Ø¹ loadExcel Ø¨Ø§ ØªØºÛŒÛŒØ± Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets
async function loadExcel() {
  const file = document.getElementById('excelFile').files[0];
  if (!file) return alert('ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
      
      if (json.length < 2) return alert('ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.');
      
      items = [];
      for (let i = 1; i < json.length; i++) {
        const row = json[i];
        const bc = String(row[0] || '').trim();
        if (!bc) continue;
        
        const stock = parseFloat(row[9]) || 0;
        const c1 = parseFloat(row[2]) || 0;
        const c2 = parseFloat(row[4]) || 0;
        const disc1 = (c1 - stock).toFixed(2);
        const disc2 = (c2 - stock).toFixed(2);
        
        items.push([
          bc,
          row[1] || '',
          c1,
          disc1,
          c2,
          disc2,
          row[6] || '',
          row[7] || '',
          row[8] || '',
          stock,
          row[10] || '',
          getNowFa(),
          row[12] || ''
        ]);
      }
      
      // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets
      const success = await saveDataToSheets();
      
      if (success) {
        renderTable();
        renderDiscrepancyReports();
        alert(`âœ… ${items.length} Ù…ÙˆØ±Ø¯ import Ø´Ø¯.`);
      }
    } catch (err) {
      alert('Ø®Ø·Ø§ Ø¯Ø± import: ' + (err.message || 'Ù†Ø§Ù…Ø´Ø®Øµ'));
    }
  };
  reader.readAsArrayBuffer(file);
}

// ØªØºÛŒÛŒØ± ØªØ§Ø¨Ø¹ exportExcel Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ
function exportExcel() {
  if (items.length === 0) return alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
  const headers = ['Ø¨Ø§Ø±Ú©Ø¯','Ù†Ø§Ù… Ú©Ø§Ù„Ø§','Ø´Ù…Ø§Ø±Ø´Û±','Ù…ØºØ§ÛŒØ±ØªÛ±','Ø´Ù…Ø§Ø±Ø´Û²','Ù…ØºØ§ÛŒØ±ØªÛ²','ØªÚ¯','ØªÛŒÙ…','Ù…Ø­Ù„','Ù…ÙˆØ¬ÙˆØ¯ÛŒ','ØªÙˆØ¶ÛŒØ­Ø§Øª','Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ','Ú©Ø§Ø±Ø¨Ø±'];
  const wsData = [headers, ...items.map(r => r.slice(0,13))];
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù†Ø¨Ø§Ø±');
  XLSX.writeFile(wb, 'Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ_Ø®Ø±ÙˆØ¬ÛŒ.xlsx');
}

// Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯...
// [Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ Ù…Ø§Ù†Ù†Ø¯ renderTable, applyFilters, renderFilterRow Ùˆ ... Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±]let settings = JSON.parse(localStorage.getItem('appSettings')) || {
  userName: 'Ú©Ø§Ø±Ø¨Ø±',
  teamName: '',
  defaultLocation: '',
  minLength: 14,
  maxLength: 20,
  searchByTag: false
};

// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† URL ÙˆØ¨ Ø§Ù¾ Google Apps Script
const SHEETS_API_URL = 'YOUR_WEB_APP_URL_HERE'; // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ Ø¨Ø§ URL ÙˆØ§Ù‚Ø¹ÛŒ
let items = [];
let filters = {};
let currentEditIndex = -1;
let currentDropdown = null;
let LAST_SCAN_METHOD = localStorage.getItem('scanner') || 'camera';
let barcodeDetector = null;
let videoStream = null;
let scanInterval = null;
let lastScannedValue = '';
let stableScanCount = 0;
let zoomLevel = 1.0;

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Google Sheets
async function loadDataFromSheets() {
  try {
    const response = await fetch(SHEETS_API_URL);
    const data = await response.json();
    
    if (data.error) {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ:', data.error);
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Google Sheets');
      return [];
    }
    
    return data;
  } catch (error) {
    console.error('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡:', error);
    alert('Ø¹Ø¯Ù… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ Ø³Ø±ÙˆØ±');
    return [];
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Google Sheets
async function saveDataToSheets() {
  try {
    const response = await fetch(SHEETS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: items })
    });
    
    const result = await response.json();
    
    if (result.error) {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡:', result.error);
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Google Sheets');
      return false;
    }
    
    console.log('âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯:', result);
    return true;
  } catch (error) {
    console.error('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡:', error);
    alert('Ø¹Ø¯Ù… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ Ø³Ø±ÙˆØ±');
    return false;
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡/Ø¢Ù¾Ø¯ÛŒØª ÛŒÚ© Ø¢ÛŒØªÙ…
async function saveOrUpdateItem(itemData) {
  try {
    const response = await fetch(SHEETS_API_URL, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(itemData)
    });
    
    const result = await response.json();
    
    if (result.error) {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¢ÛŒØªÙ…:', result.error);
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¢ÛŒØªÙ…');
      return false;
    }
    
    console.log('âœ… Ø¢ÛŒØªÙ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯:', result);
    return result;
  } catch (error) {
    console.error('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡:', error);
    alert('Ø¹Ø¯Ù… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ Ø³Ø±ÙˆØ±');
    return false;
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÛŒÚ© Ø¢ÛŒØªÙ…
async function deleteItemFromSheets(barcode, location) {
  try {
    const response = await fetch(SHEETS_API_URL, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ barcode, location })
    });
    
    const result = await response.json();
    
    if (result.error) {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¢ÛŒØªÙ…:', result.error);
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¢ÛŒØªÙ…');
      return false;
    }
    
    console.log('âœ… Ø¢ÛŒØªÙ… Ø­Ø°Ù Ø´Ø¯:', result);
    return true;
  } catch (error) {
    console.error('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡:', error);
    alert('Ø¹Ø¯Ù… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ Ø³Ø±ÙˆØ±');
    return false;
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² localStorage
  document.getElementById('settingUserName').value = settings.userName;
  document.getElementById('settingTeamName').value = settings.teamName;
  document.getElementById('settingDefaultLocation').value = settings.defaultLocation;
  document.getElementById('settingMinLength').value = settings.minLength;
  document.getElementById('settingMaxLength').value = settings.maxLength;
  document.getElementById('searchByTag').checked = settings.searchByTag;
  
  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Google Sheets
  items = await loadDataFromSheets();
  
  // Ø§Ø¯Ø§Ù…Ù‡ Ú©Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯...
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      if (btn.dataset.tab === 'reports') renderDiscrepancyReports();
    });
  });

  if (!settings.defaultLocation) {
    settings.defaultLocation = 'Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ';
    localStorage.setItem('appSettings', JSON.stringify(settings));
  }

  document.getElementById('searchByTag').addEventListener('change', function() {
    settings.searchByTag = this.checked;
    updateSearchUI();
  });

  document.getElementById('globalLocationDisplay').textContent = settings.defaultLocation;
  updateSearchUI();
  renderTable();
  renderFilterRow();
  renderDiscrepancyReports();

  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø¨Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¹Ø¯Ø¯ÛŒ
  ['addCount1','addCount2','editCount1','editCount2'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      const wrap = document.createElement('div');
      wrap.style.position = 'relative';
      el.parentNode.insertBefore(wrap, el);
      wrap.appendChild(el);
      const btn = document.createElement('button');
      btn.innerHTML = 'ðŸ§®';
      btn.style.cssText = 
        'position:absolute;left:12px;top:50%;transform:translateY(-50%);' +
        'background:#e0e0e0;border:none;width:40px;height:40px;' +
        'border-radius:10px;cursor:pointer;font-size:20px;font-weight:bold;';
      btn.onclick = () => openCalc(id);
      wrap.appendChild(btn);
      el.style.paddingLeft = '60px';
    }
  });

  const params = new URLSearchParams(window.location.search);
  const bc = params.get('SCAN_RESULT')?.trim() || params.get('barcode')?.trim();
  if (bc && !settings.searchByTag) {
    document.getElementById('searchInput').value = bc;
    setTimeout(searchOrAdd, 150);
  }
});

// ØªØ§Ø¨Ø¹ saveAdd Ø¨Ø§ ØªØºÛŒÛŒØ± Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets
async function saveAdd() {
  const bc = document.getElementById('addBarcode').value.trim();
  const name = document.getElementById('addName').value.trim();
  const stock = parseFloat(document.getElementById('addStock').value) || 0;
  const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
  const c2Raw = document.getElementById('addCount2').value;
  const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;
  const disc1 = (c1 - stock).toFixed(2);
  const disc2 = calculateDiscrepancy2(stock, c2Raw, disc1);
  
  const itemData = {
    barcode: bc,
    name: name,
    count1: c1,
    discrepancy1: disc1,
    count2: c2,
    discrepancy2: disc2,
    tag: document.getElementById('addTag').value.trim(),
    team: settings.teamName,
    location: document.getElementById('addLocation').value.trim(),
    stock: stock,
    notes: document.getElementById('addNotes').value.trim(),
    lastUpdate: getNowFa(),
    user: settings.userName
  };
  
  const result = await saveOrUpdateItem(itemData);
  
  if (result) {
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±
    items = await loadDataFromSheets();
    renderTable();
    renderDiscrepancyReports();
    closeAddModal();
    document.getElementById('searchInput').value = '';
  }
}

// ØªØ§Ø¨Ø¹ saveEdit Ø¨Ø§ ØªØºÛŒÛŒØ± Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets
async function saveEdit() {
  if (currentEditIndex < 0) return;
  
  const r = items[currentEditIndex];
  const stock = parseFloat(document.getElementById('editStock').value) || 0;
  const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
  const c2Raw = document.getElementById('editCount2').value;
  const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;
  
  const itemData = {
    barcode: r[0],
    name: document.getElementById('editName').value.trim(),
    count1: c1,
    discrepancy1: (c1 - stock).toFixed(2),
    count2: c2,
    discrepancy2: calculateDiscrepancy2(stock, c2Raw, (c1 - stock).toFixed(2)),
    tag: document.getElementById('editTag').value.trim(),
    team: settings.teamName,
    location: document.getElementById('editLocation').value.trim(),
    stock: stock,
    notes: document.getElementById('editNotes').value.trim(),
    lastUpdate: getNowFa(),
    user: settings.userName
  };
  
  const result = await saveOrUpdateItem(itemData);
  
  if (result) {
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±
    items = await loadDataFromSheets();
    renderTable();
    renderDiscrepancyReports();
    closeEditModal();
    document.getElementById('searchInput').value = '';
  }
}

// ØªØ§Ø¨Ø¹ removeItem Ø¨Ø§ ØªØºÛŒÛŒØ± Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ø§Ø² Google Sheets
async function removeItem(i) {
  if (confirm('Ø§ÛŒÙ† Ø±Ø¯ÛŒÙ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
    const item = items[i];
    const success = await deleteItemFromSheets(item[0], item[8]);
    
    if (success) {
      // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±
      items = await loadDataFromSheets();
      renderTable();
      renderDiscrepancyReports();
    }
  }
}

// ØªØ§Ø¨Ø¹ clearAll Ø¨Ø§ ØªØºÛŒÛŒØ± Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ø§Ø² Google Sheets
async function clearAll() {
  if (confirm('âš ï¸ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ')) {
    // Ø°Ø®ÛŒØ±Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ Ø®Ø§Ù„ÛŒ Ø¯Ø± Google Sheets
    items = [];
    await saveDataToSheets();
    
    renderTable();
    renderDiscrepancyReports();
    alert('âœ… ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.');
  }
}

// ØªØ§Ø¨Ø¹ loadExcel Ø¨Ø§ ØªØºÛŒÛŒØ± Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets
async function loadExcel() {
  const file = document.getElementById('excelFile').files[0];
  if (!file) return alert('ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
      
      if (json.length < 2) return alert('ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.');
      
      items = [];
      for (let i = 1; i < json.length; i++) {
        const row = json[i];
        const bc = String(row[0] || '').trim();
        if (!bc) continue;
        
        const stock = parseFloat(row[9]) || 0;
        const c1 = parseFloat(row[2]) || 0;
        const c2 = parseFloat(row[4]) || 0;
        const disc1 = (c1 - stock).toFixed(2);
        const disc2 = (c2 - stock).toFixed(2);
        
        items.push([
          bc,
          row[1] || '',
          c1,
          disc1,
          c2,
          disc2,
          row[6] || '',
          row[7] || '',
          row[8] || '',
          stock,
          row[10] || '',
          getNowFa(),
          row[12] || ''
        ]);
      }
      
      // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets
      const success = await saveDataToSheets();
      
      if (success) {
        renderTable();
        renderDiscrepancyReports();
        alert(`âœ… ${items.length} Ù…ÙˆØ±Ø¯ import Ø´Ø¯.`);
      }
    } catch (err) {
      alert('Ø®Ø·Ø§ Ø¯Ø± import: ' + (err.message || 'Ù†Ø§Ù…Ø´Ø®Øµ'));
    }
  };
  reader.readAsArrayBuffer(file);
}

// ØªØºÛŒÛŒØ± ØªØ§Ø¨Ø¹ exportExcel Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ
function exportExcel() {
  if (items.length === 0) return alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
  const headers = ['Ø¨Ø§Ø±Ú©Ø¯','Ù†Ø§Ù… Ú©Ø§Ù„Ø§','Ø´Ù…Ø§Ø±Ø´Û±','Ù…ØºØ§ÛŒØ±ØªÛ±','Ø´Ù…Ø§Ø±Ø´Û²','Ù…ØºØ§ÛŒØ±ØªÛ²','ØªÚ¯','ØªÛŒÙ…','Ù…Ø­Ù„','Ù…ÙˆØ¬ÙˆØ¯ÛŒ','ØªÙˆØ¶ÛŒØ­Ø§Øª','Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ','Ú©Ø§Ø±Ø¨Ø±'];
  const wsData = [headers, ...items.map(r => r.slice(0,13))];
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù†Ø¨Ø§Ø±');
  XLSX.writeFile(wb, 'Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ_Ø®Ø±ÙˆØ¬ÛŒ.xlsx');
}

// Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯...
// [Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ Ù…Ø§Ù†Ù†Ø¯ renderTable, applyFilters, renderFilterRow Ùˆ ... Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±]

