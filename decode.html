<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ùˆ Ø´Ù…Ø§Ø±Ø´ Ø¯Ø§Ø±Ø§ÛŒÛŒ</title>
  <style>
    body { font-family: Tahoma, sans-serif; background: #f4f7f9; margin: 0; padding: 20px; }
    .container { max-width: 1600px; margin: 0 auto; }
    .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
    h1, h2, h3, h4 { color: #0277bd; }
    .header-controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .header-controls button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.2s; }
    #settingsBtn { background: #ffa000; color: #333; }
    #scannerBtn { background: #00b0ff; color: white; }
    #reportsBtn { background: #2e7d32; color: white; }
    #reportsBtn:hover { background: #1b5e20; }
    #scannerBtn:hover { background: #01579b; }
    #settingsBtn:hover { background: #ff8f00; }

    /* Table Styles */
    .table-container { overflow-x: auto; }
    .table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
    .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: center; white-space: nowrap; }
    .table th { background-color: #e1f5fe; color: #01579b; font-weight: bold; }
    .table tr:nth-child(even) { background-color: #f9f9f9; }
    .table tbody tr:hover { background-color: #e3f2fd; }
    .table td:nth-child(2), .table td:nth-child(11) { text-align: right; min-width: 150px; }
    .table td:nth-child(3), .table td:nth-child(5), .table td:nth-child(10) { font-weight: bold; color: #333; }
    .table td:nth-child(4), .table td:nth-child(6) { font-weight: bold; color: #c62828; }
    .table .btn-group button { padding: 4px 8px; font-size: 11px; margin: 1px; }

    /* Input and Search */
    input[type="text"], input[type="number"], textarea { width: 100%; padding: 10px; margin: 6px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
    #searchInput { width: calc(100% - 22px); }
    #scanButtonContainer { display: flex; gap: 10px; }

    /* Modals */
    .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; }
    .modal-content { background-color: #fefefe; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal h3 { text-align: center; color: #01579b; margin-top: 0; }
    .modal label { display: block; margin-top: 10px; font-weight: bold; color: #555; }
    .modal input[type="text"], .modal input[type="number"], .modal textarea { margin-bottom: 10px; }
    .modal button { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.2s; margin-top: 10px; }
    .modal button.secondary { background: #ddd; color: #333; }
    .modal button.danger { background: #c62828; color: white; }
    .modal button:hover:not([disabled]) { opacity: 0.9; }
    .discrepancy { font-weight: bold; color: #d32f2f; }
    .modal .calc-display { text-align: right; font-size: 24px; padding: 15px; }
    .modal .calc-btn { font-size: 18px; padding: 15px 0; }

    /* Custom Select (for Location) */
    .custom-select-container { position: relative; width: 100%; }
    .custom-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; border: 1px solid #ccc; background: white; max-height: 200px; overflow-y: auto; z-index: 101; border-radius: 0 0 4px 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .custom-select-option { padding: 10px; cursor: pointer; text-align: right; }
    .custom-select-option:hover { background-color: #e1f5fe; }
    .select-arrow { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #777; }

    /* Camera Modal */
    #cameraModal .modal-content { width: 100vw; height: 100vh; max-width: 100%; max-height: 100%; padding: 0; border-radius: 0; display: flex; flex-direction: column; }
    #cameraVideo { width: 100%; height: 100%; object-fit: cover; }
    .scanner-frame { position: absolute; top: 50%; left: 50%; width: 200px; height: 150px; margin-left: -100px; margin-top: -75px; border: 4px solid #00bcd4; border-radius: 10px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); }
    .scan-hint { position: absolute; top: 30px; width: 100%; text-align: center; color: white; font-size: 18px; text-shadow: 0 0 5px black; }
    .zoom-controls { position: absolute; bottom: 80px; width: 100%; text-align: center; display: flex; justify-content: center; gap: 15px; }
    .zoom-btn { background: rgba(0,0,0,0.6); color: white; border: 1px solid white; padding: 10px 20px; border-radius: 50px; font-size: 18px; }

    /* Report Card */
    .calc-apply {
      background: #2e7d32 !important;
      width: 100% !important;
      padding: 18px !important;
      margin-top: 14px;
      font-size: 20px;
      border-radius: 10px;
    }
    .report-card { background: #fff8e1; border-left: 4px solid #ffa000; }
    .report-card h4 { color: #e65100; margin-bottom: 10px; }
    .location-display {
      width: 100%; padding: 12px; background: #f5f5f5; border-radius: 8px;
      font-weight: bold; color: #2e7d32; text-align: center; border: 1px solid #ddd;
    }
    .sync-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 10px 20px;
      background: #1976d2;
      color: white;
      border-radius: 20px;
      font-size: 14px;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
    }
    .sync-status.show { display: block; }
    .sync-status.success { background: #2e7d32; }
    .sync-status.error { background: #c62828; }
  </style>
</head>
<body>
  <!-- ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ -->
  <div id="syncStatus" class="sync-status"></div>

  <div class="container">
    <div class="header-controls">
        <button id="scannerBtn" onclick="openScanner()">ğŸ” Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù†Ø±</button>
        <button id="reportsBtn" onclick="renderDiscrepancyReports()">ğŸ“Š Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§</button>
        <button id="settingsBtn" onclick="openSettingsModal()">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </div>

    <div class="card">
        <h3>Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ø¹Ù…Ù„ÛŒØ§Øª</h3>
        <div style="display:flex; gap:10px; margin-bottom:12px;">
            <input type="text" id="searchInput" placeholder="Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" oninput="applyFilters()" style="flex-grow:1;" />
            <div id="scanButtonContainer">
                <button onclick="scanBarcode('camera')" class="secondary" style="padding:10px;">ğŸ“¸ Ø¯ÙˆØ±Ø¨ÛŒÙ†</button>
                <button onclick="scanBarcode('gamma')" class="secondary" style="padding:10px;">ğŸ”Œ Gamma</button>
            </div>
        </div>
        <div class="location-display">
            Ù…Ø­Ù„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ÙØ¹Ù„ÛŒ: <span id="globalLocationDisplay">Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ</span>
            <button onclick="toggleLocationDropdown('main')" style="float:left; padding: 0 5px; background:none; border:none; color:#0277bd;">ØªØºÛŒÛŒØ±</button>
            <div id="locationDropdown" class="custom-select-dropdown hidden"></div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ -->
    <div id="cameraModal" class="modal hidden">
        <div style="position:relative; width:100vw; height:100vh;">
          <video id="cameraVideo" playsinline></video>
          <div class="scanner-frame"></div>
          <div class="scan-hint" id="scanHint">
            ğŸ” Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¯Ø± Ú†Ù‡Ø§Ø±Ú†ÙˆØ¨ Ø¢Ø¨ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.<br>
            <span id="hintZoom">ğŸ” Ø²ÙˆÙ…: Ã—1.0</span>
          </div>
          <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomOut()">â€“</button>
            <button class="zoom-btn" onclick="resetZoom()">â†º</button>
            <button class="zoom-btn" onclick="zoomIn()">+</button>
          </div>
        </div>
        <div style="padding:16px; text-align:center;">
          <button onclick="stopCamera()" class="danger" style="width:auto; padding:12px 24px; font-size:16px;">â¹ï¸ ØªÙˆÙ‚Ù Ø§Ø³Ú©Ù†</button>
        </div>
      </div>

    <div id="addModal" class="modal hidden">
        <div class="modal-content">
          <h3>Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
          <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
          <input type="text" id="addBarcode" readonly />
          <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
          <input type="text" id="addName" />
          <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
          <input type="number" id="addStock" step="0.01" readonly />
          <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
          <input type="number" id="addCount1" step="0.01" inputmode="numeric" pattern="[0-9.]*" oninput="updateDiscrepancyAdd()" />
          <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="addDisc1" class="discrepancy">â€”</span></div>
          <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
          <input type="number" id="addCount2" step="0.01" inputmode="numeric" pattern="[0-9.]*" oninput="updateDiscrepancyAdd()" />
          <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="addDisc2" class="discrepancy">â€”</span></div>
          <label>ØªÚ¯:</label>
          <input type="text" id="addTag" />
          <label>ØªÛŒÙ…:</label>
          <input type="text" id="addTeam" readonly value="Ú©Ø§Ø±Ø¨Ø±" />
          <label>Ù…Ø­Ù„:</label>
          <div class="custom-select-container">
            <input type="text" id="addLocation" autocomplete="off" />
            <div class="custom-select-dropdown hidden" id="addLocationDropdown"></div>
            <span class="select-arrow" onclick="toggleLocationDropdown('add')">â–¼</span>
          </div>
          <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
          <textarea id="addNotes" rows="2"></textarea>
          <div style="display:flex; gap:8px; margin-top:16px;">
            <button onclick="saveAdd()" style="flex:1;">âœ… Ø§ÙØ²ÙˆØ¯Ù†</button>
            <button onclick="closeAddModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
          </div>
        </div>
      </div>

    <div id="editModal" class="modal hidden">
        <div class="modal-content">
          <h3>ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù„Ø§</h3>
          <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
          <input type="text" id="editBarcode" readonly />
          <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
          <input type="text" id="editName" />
          <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
          <input type="number" id="editStock" step="0.01" readonly />
          <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
          <input type="number" id="editCount1" step="0.01" inputmode="numeric" pattern="[0-9.]*" oninput="updateDiscrepancyEdit()" />
          <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="editDisc1" class="discrepancy">â€”</span></div>
          <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
          <input type="number" id="editCount2" step="0.01" inputmode="numeric" pattern="[0-9.]*" oninput="updateDiscrepancyEdit()" />
          <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="editDisc2" class="discrepancy">â€”</span></div>
          <label>ØªÚ¯:</label>
          <input type="text" id="editTag" />
          <label>ØªÛŒÙ…:</label>
          <input type="text" id="editTeam" readonly value="Ú©Ø§Ø±Ø¨Ø±" />
          <label>Ù…Ø­Ù„:</label>
          <div class="custom-select-container">
            <input type="text" id="editLocation" autocomplete="off" />
            <div class="custom-select-dropdown hidden" id="editLocationDropdown"></div>
            <span class="select-arrow" onclick="toggleLocationDropdown('edit')">â–¼</span>
          </div>
          <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
          <textarea id="editNotes" rows="2"></textarea>
          <div style="display:flex; gap:8px; margin-top:16px;">
            <button onclick="saveEdit()" style="flex:1;">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
            <button onclick="closeEditModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
          </div>
        </div>
      </div>

    <div id="calcModal" class="modal hidden">
        <div class="modal-content">
          <h3>Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨</h3>
          <input type="text" id="calcDisplay" class="calc-display" inputmode="numeric" pattern="[0-9+\-*/().]*"
                 placeholder="12+5*(3-1)" />
          <div style="display:grid; grid-template-columns: repeat(4,1fr); gap:6px; margin-top:10px;">
            <button class="calc-btn" onclick="calcAppend('7')">7</button>
            <button class="calc-btn" onclick="calcAppend('8')">8</button>
            <button class="calc-btn" onclick="calcAppend('9')">9</button>
            <button class="calc-btn" onclick="calcAppend('/')">Ã·</button>
            <button class="calc-btn" onclick="calcAppend('4')">4</button>
            <button class="calc-btn" onclick="calcAppend('5')">5</button>
            <button class="calc-btn" onclick="calcAppend('6')">6</button>
            <button class="calc-btn" onclick="calcAppend('*')">Ã—</button>
            <button class="calc-btn" onclick="calcAppend('1')">1</button>
            <button class="calc-btn" onclick="calcAppend('2')">2</button>
            <button class="calc-btn" onclick="calcAppend('3')">3</button>
            <button class="calc-btn" onclick="calcAppend('-')">âˆ’</button>
            <button class="calc-btn" onclick="calcAppend('0')">0</button>
            <button class="calc-btn" onclick="calcAppend('(')">(</button>
            <button class="calc-btn" onclick="calcAppend(')')">)</button>
            <button class="calc-btn" onclick="calcAppend('+')">+</button>
            <button class="calc-btn" onclick="calcAppend('.')">.</button>
            <button class="calc-btn" style="background:#ffc107;color:#000;" onclick="calcClear()">C</button>
            <button class="calc-btn" style="background:#2196f3;color:white;" onclick="calcApply()">=</button>
            <button class="calc-btn" onclick="calcBackspace()">âŒ«</button>
          </div>
          <button class="calc-btn calc-apply" onclick="calcApply()">âœ… Ø§Ø¹Ù…Ø§Ù„ Ù†ØªÛŒØ¬Ù‡</button>
          <button class="secondary" style="width:100%; margin-top:10px; padding:14px; font-size:18px;"
                  onclick="closeCalcModal()">âŒ Ù„ØºÙˆ</button>
        </div>
      </div>

    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
          <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡</h3>
          <label>ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ:</label>
          <input type="text" id="settingUserName" value="Ú©Ø§Ø±Ø¨Ø±" />
          <label>ğŸ¢ Ù†Ø§Ù… ØªÛŒÙ…:</label>
          <input type="text" id="settingTeamName" />
          <label>ğŸ“ Ù…Ø­Ù„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶:</label>
          <div class="custom-select-container">
            <input type="text" id="settingDefaultLocation" autocomplete="off" />
            <div class="custom-select-dropdown hidden" id="settingsLocationDropdown"></div>
            <span class="select-arrow" onclick="toggleLocationDropdown('settings')">â–¼</span>
          </div>
          <label>ğŸ“ Ø­Ø¯Ø§Ù‚Ù„ Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯:</label>
          <input type="number" id="settingMinLength" value="14" />
          <label>ğŸ“ Ø­Ø¯Ø§Ú©Ø«Ø± Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯:</label>
          <input type="number" id="settingMaxLength" value="20" />
          <label><input type="checkbox" id="settingSearchByTag" /> Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÚ¯ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯</label>

          <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Google Sheets -->
          <h4 style="margin:20px 0 8px;">ğŸŒ Ø§ØªØµØ§Ù„ Google Sheets</h4>
          <label>ğŸ”— URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª:</label>
          <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/..." />
          <button onclick="testScriptConnection()" class="secondary" style="width:100%; margin:8px 0;">ğŸ”— ØªØ³Øª Ø§ØªØµØ§Ù„ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª</button>
          <button onclick="loadFromGoogleAppsScript()" class="secondary" style="width:100%; margin:8px 0;">ğŸ”„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Sheets</button>
          <button onclick="saveToGoogleAppsScript()" class="secondary" style="width:100%; margin:8px 0;">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets (Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯ÛŒØ¯)</button>

          <h4 style="margin:20px 0 8px;">ğŸ—ƒï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡</h4>
          <input type="file" id="excelFile" accept=".xlsx,.xls" style="width:100%; margin:6px 0;" />
          <button onclick="importExcel()" style="width:100%; margin:6px 0;">ğŸ“¥ import Ø§Ú©Ø³Ù„</button>
          <button onclick="exportExcel()" style="width:100%; margin:6px 0; background:#1976d2;">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
          <button onclick="clearAll()" class="danger" style="width:100%; margin:6px 0;">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
          <button onclick="saveSettings()" style="margin-top:20px; width:100%;">âœ… Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
        </div>
      </div>

    <div class="card" id="mainTableCard">
        <h3>Ù„ÛŒØ³Øª Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (<span id="totalCount">0</span> Ù…ÙˆØ±Ø¯)</h3>
        <input type="text" id="globalSearch" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù‡Ù…Ù‡ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§..." oninput="applyFilters()" style="margin-bottom:12px;" />
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Ø¨Ø§Ø±Ú©Ø¯</th>
                <th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th>
                <th>Ø´Ù…Ø§Ø±Ø´Û±</th>
                <th>Ù…ØºØ§ÛŒØ±ØªÛ±</th>
                <th>Ø´Ù…Ø§Ø±Ø´Û²</th>
                <th>Ù…ØºØ§ÛŒØ±ØªÛ²</th>
                <th>ØªÚ¯</th>
                <th>ØªÛŒÙ…</th>
                <th>Ù…Ø­Ù„</th>
                <th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th>
                <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                <th>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</th>
                <th>Ú©Ø§Ø±Ø¨Ø±</th>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
              </tr>
              <tr id="filterRow"></tr>
            </thead>
            <tbody id="tableBody">
              <tr><td colspan="14" style="text-align:center;">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    <div class="card report-card" id="reportCard" style="display:none;">
        <h4>Ú¯Ø²Ø§Ø±Ø´ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§</h4>
        <div id="discrepancyReportBody"></div>
        <button onclick="renderTable()" style="width:100%; margin-top:15px; background:#795548; color:white;">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ø§ØµÙ„ÛŒ</button>
    </div>
  </div>

<script>
    // ============ ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù† ============
    function getNowFa() {
      const now = new Date();
      const year = now.getFullYear();
      const month = (now.getMonth() + 1).toString().padStart(2, '0');
      const day = now.getDate().toString().padStart(2, '0');
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    // ============ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ ============
    let settings = JSON.parse(localStorage.getItem('appSettings')) || {
      userName: 'Ú©Ø§Ø±Ø¨Ø±',
      teamName: '',
      defaultLocation: 'Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ',
      minLength: 14,
      maxLength: 20,
      searchByTag: false,
      scriptUrl: ''
    };

    let items = JSON.parse(localStorage.getItem('items')) || [];
    let filters = {};
    let currentEditIndex = -1;
    let currentDropdown = null;
    let LAST_SCAN_METHOD = localStorage.getItem('scanner') || 'camera';
    let barcodeDetector = null;
    let videoStream = null;
    let scanInterval = null;
    let lastScannedValue = '';
    let stableScanCount = 0;
    let zoomLevel = 1.0;
    let CURRENT_CALC_TARGET = null;

    document.addEventListener('DOMContentLoaded', () => {
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ UI
        document.getElementById('settingUserName').value = settings.userName;
        document.getElementById('settingTeamName').value = settings.teamName || '';
        document.getElementById('settingDefaultLocation').value = settings.defaultLocation;
        document.getElementById('settingMinLength').value = settings.minLength;
        document.getElementById('settingMaxLength').value = settings.maxLength;
        document.getElementById('settingSearchByTag').checked = settings.searchByTag;
        document.getElementById('scriptUrl').value = settings.scriptUrl;
        document.getElementById('globalLocationDisplay').textContent = settings.defaultLocation;

        updateSearchUI();
        renderTable();
        renderDiscrepancyReports();
        document.getElementById('totalCount').textContent = items.length;
    });

    // ============ ØªÙˆØ§Ø¨Ø¹ Google Apps Script (Ø³Ø±ÙˆØ±) ============

    // Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª
    function showSyncStatus(message, type = 'info') {
      const statusEl = document.getElementById('syncStatus');
      statusEl.textContent = message;
      statusEl.className = 'sync-status show';
      statusEl.classList.remove('success', 'error');
      if (type === 'success') statusEl.classList.add('success');
      else if (type === 'error') statusEl.classList.add('error');

      setTimeout(() => {
        statusEl.classList.remove('show');
      }, 3000);
    }

    // ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
    async function testScriptConnection() {
      const scriptUrl = document.getElementById('scriptUrl').value.trim();

      if (!scriptUrl) {
        alert('Ù„Ø·ÙØ§Ù‹ URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
      }

      showSyncStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§ØªØµØ§Ù„...', 'info');

      try {
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² doGet Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª
        const response = await fetch(scriptUrl);

        if (response.ok) {
          settings.scriptUrl = scriptUrl;
          localStorage.setItem('appSettings', JSON.stringify(settings));
          showSyncStatus('âœ… Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚!', 'success');
          alert('âœ… Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯!');
        } else {
          throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
        }
      } catch (error) {
        console.error(error);
        showSyncStatus('âŒ Ø§ØªØµØ§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚', 'error');
        alert(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„:\n${error.message}\nØ§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ú©Ù†ÛŒØ¯ Ú©Ù‡ URL ØµØ­ÛŒØ­ Ø§Ø³Øª Ùˆ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù† Ø¯Ø± Ø­Ø§Ù„Øª Ø¹Ù…ÙˆÙ…ÛŒ (Anyone) ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ Ø§Ø³Øª.`);
      }
    }

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Google Apps Script
    async function loadFromGoogleAppsScript() {
      if (!settings.scriptUrl) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ùˆ ØªØ³Øª Ú©Ù†ÛŒØ¯');
        return;
      }

      showSyncStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...', 'info');

      try {
        const response = await fetch(settings.scriptUrl);

        if (!response.ok) {
          throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
        }

        const dataText = await response.text();
        const data = JSON.parse(dataText);

        if (Array.isArray(data)) {
          items = data;
          localStorage.setItem('items', JSON.stringify(items));
          showSyncStatus(`âœ… ${items.length} Ù…ÙˆØ±Ø¯ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`, 'success');
          renderTable();
          renderDiscrepancyReports();
        } else {
          showSyncStatus('ğŸ“­ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª ÛŒØ§ Ø³Ø§Ø®ØªØ§Ø± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', 'info');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ:', error);
        showSyncStatus('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ', 'error');
        alert(`Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: ${error.message}`);
      }
    }
    
    // **ØªØºÛŒÛŒØ± Ú©Ù„ÛŒØ¯ÛŒ: Ø§Ø±Ø³Ø§Ù„ payload Ø¨Ø§ Ù¾Ø§Ø±Ø§Ù…ØªØ± action**
    async function saveToGoogleAppsScript(payload) {
        if (!settings.scriptUrl) {
            showSyncStatus('âŒ URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.', 'error');
            return { success: false };
        }
        
        showSyncStatus(`ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ${payload.action} Ø¨Ù‡ Ø³Ø±ÙˆØ±...`, 'info');

        try {
            const response = await fetch(settings.scriptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                showSyncStatus('âœ… Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ø´ÛŒØª Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ² Ø¨ÙˆØ¯.', 'success');
                return { success: true };
            } else {
                throw new Error(result.error || 'Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.');
            }

        } catch (error) {
            console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø³Ù…Øª Ø³Ø±ÙˆØ±:', error);
            showSyncStatus('âŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø´ÛŒØª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.', 'error');
            alert(`âŒ Ø®Ø·Ø§ÛŒ Ø³Ù…Øª Ø³Ø±ÙˆØ±:\n${error.message}`);
            return { success: false };
        }
    }

    async function exportExcel() {
        if (!items.length) {
            return alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
        }
        
        showSyncStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„...', 'info');
        
        const headers = [
            'Ø¨Ø§Ø±Ú©Ø¯', 'Ù†Ø§Ù… Ú©Ø§Ù„Ø§', 'Ø´Ù…Ø§Ø±Ø´Û±', 'Ù…ØºØ§ÛŒØ±ØªÛ±', 'Ø´Ù…Ø§Ø±Ø´Û²', 'Ù…ØºØ§ÛŒØ±ØªÛ²',
            'ØªÚ¯', 'ØªÛŒÙ…', 'Ù…Ø­Ù„', 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ', 'ØªÙˆØ¶ÛŒØ­Ø§Øª', 'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', 'Ú©Ø§Ø±Ø¨Ø±'
        ];
        
        const exportData = [headers, ...items];

        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾Ø§ÛŒØªÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„
        try {
            const response = await fetch('/api/run_python', { // ÙØ±Ø¶ Ø¨Ø± Ø§ÛŒÙ† Ø§Ø³Øª Ú©Ù‡ Ø§ÛŒÙ† Ù…Ø³ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ø§ÛŒØªÙˆÙ† ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    code: `
import pandas as pd
import io

data = ${JSON.stringify(exportData)}
df = pd.DataFrame(data[1:], columns=data[0])
output = io.BytesIO()
df.to_excel(output, index=False, engine='xlsxwriter')
output.seek(0)
with open('[/mnt/data/inventory_export.xlsx'](https://storage.gapgpt.app/media/code_interpreter/8b7c82e5-05b7-44f4-9f7d-76601e0fbb5c/inventory_export.xlsx%27), 'wb') as f:
    f.write(output.read())
print("File saved to [/mnt/data/inventory_export.xlsx"](https://storage.gapgpt.app/media/code_interpreter/8b7c82e5-05b7-44f4-9f7d-76601e0fbb5c/inventory_export.xlsx%22))
`
                })
            });
            
            if (response.ok) {
                showSyncStatus('âœ… ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¢Ù…Ø§Ø¯Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ø³Øª.', 'success');
                // Ø¯Ø± Ù…Ø­ÛŒØ· ÙˆØ§Ù‚Ø¹ÛŒØŒ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø§Ø±Ø§Ø¦Ù‡ Ø´ÙˆØ¯.
                alert('ÙØ§ÛŒÙ„ "inventory_export.xlsx" Ø¢Ù…Ø§Ø¯Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø§Ø³Øª.');
            } else {
                throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ø§ÛŒØªÙˆÙ†.');
            }
        } catch(e) {
            console.error(e);
            showSyncStatus('âŒ Ø®Ø·Ø§ÛŒ Ø³Ø§Ø®Øª Ø§Ú©Ø³Ù„.', 'error');
        }
    }

    async function clearAll() {
        if (!confirm('âš ï¸ Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ¾Ø°ÛŒØ± Ù†ÛŒØ³Øª!')) return;

        // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø³ØªÙˆØ± Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¨Ù‡ Ø³Ø±ÙˆØ±
        const payload = { action: 'clear_all' }; // Ø³Ø±ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† Ø§Ú©Ø´Ù† Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ú©Ù†Ø¯

        if (settings.scriptUrl) {
            // Ø§Ø¨ØªØ¯Ø§ Ø³Ø¹ÛŒ Ú©Ù† Ø³Ø±ÙˆØ± Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒ
            const saveResult = await saveToGoogleAppsScript(payload);
            if (saveResult.success) {
                items = [];
                localStorage.setItem('items', JSON.stringify(items));
                renderTable();
                renderDiscrepancyReports();
                showSyncStatus('âœ… Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø´ÛŒØª Ùˆ Ø­Ø§ÙØ¸Ù‡ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.', 'success');
            }
        } else {
            // Ø§Ú¯Ø± Ø³Ø±ÙˆØ± Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ ÙÙ‚Ø· Ù…Ø­Ù„ÛŒ Ù¾Ø§Ú© Ú©Ù†
            items = [];
            localStorage.setItem('items', JSON.stringify(items));
            renderTable();
            renderDiscrepancyReports();
            showSyncStatus('âœ… Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.', 'success');
        }
    }

    // ============ Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ Ø¬Ø¯ÙˆÙ„ Ùˆ Ù†Ù…Ø§ÛŒØ´ ============
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const filteredItems = items.filter(row =>
        Object.keys(filters).every(key =>
          String(row[key]).toLowerCase().includes(filters[key].toLowerCase())
        )
      ).filter(row =>
        row[0] && (String(row[0]) + String(row[1]) + String(row[2]) + String(row[3]) + String(row[4]) + String(row[5]) + String(row[6]) + String(row[7]) + String(row[8]) + String(row[9]) + String(row[10]) + String(row[11]) + String(row[12])).toLowerCase().includes(document.getElementById('globalSearch').value.toLowerCase())
      );

      document.getElementById('totalCount').textContent = filteredItems.length;
      tbody.innerHTML = '';

      if (filteredItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="14" style="text-align:center;">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>';
        return;
      }

      filteredItems.forEach((row, indexInFiltered) => {
        // ÛŒØ§ÙØªÙ† Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø§ØµÙ„ÛŒ Ø¯Ø± Ø¢Ø±Ø§ÛŒÙ‡ 'items' Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª ÙˆÛŒØ±Ø§ÛŒØ´
        const originalIndex = items.findIndex(item => item[0] === row[0]);

        const isDiscrepancy = parseFloat(row[3]) !== 0 || (row[4] !== 0 && parseFloat(row[5]) !== 0);
        const rowClass = isDiscrepancy ? 'class="report-card"' : '';

        const rowHtml = `
          <tr ${rowClass}>
            <td>${row[0] || 'â€”'}</td>
            <td>${row[1] || 'â€”'}</td>
            <td>${row[2] || 0}</td>
            <td>${row[3] || 0}</td>
            <td>${row[4] || 0}</td>
            <td>${row[5] || 0}</td>
            <td>${row[6] || 'â€”'}</td>
            <td>${row[7] || 'â€”'}</td>
            <td>${row[8] || 'â€”'}</td>
            <td>${row[9] || 0}</td>
            <td>${row[10] || 'â€”'}</td>
            <td>${row[11] || 'â€”'}</td>
            <td>${row[12] || 'â€”'}</td>
            <td class="btn-group">
              <button onclick="openEditModal(${originalIndex})" title="ÙˆÛŒØ±Ø§ÛŒØ´">âœï¸</button>
              <button onclick="confirmRemove(${originalIndex})" title="Ø­Ø°Ù" style="background:#f44336; color:white;">ğŸ—‘ï¸</button>
              <button onclick="openCalc('editCount1', ${originalIndex})" title="Ù…Ø­Ø§Ø³Ø¨Ù‡ Û±" style="background:#ff9800;">ğŸ§®1</button>
              <button onclick="openCalc('editCount2', ${originalIndex})" title="Ù…Ø­Ø§Ø³Ø¨Ù‡ Û²" style="background:#ff9800;">ğŸ§®2</button>
            </td>
          </tr>
        `;
        tbody.innerHTML += rowHtml;
      });
    }
    
    function applyFilters() {
        filters = {};
        const filterInputs = document.querySelectorAll('#filterRow input');
        filterInputs.forEach((input, index) => {
            if (input.value) {
                // Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø¯Ø± Ø¢Ø±Ø§ÛŒÙ‡ Ø§ØµÙ„ÛŒ: 0 ØªØ§ 12
                filters[index] = input.value;
            }
        });
        renderTable();
    }
    
    function setupFilterRow() {
        const filterRow = document.getElementById('filterRow');
        filterRow.innerHTML = '';
        // 13 Ø³ØªÙˆÙ† Ø¯Ø§Ø¯Ù‡ + 1 Ø³ØªÙˆÙ† Ø¹Ù…Ù„ÛŒØ§Øª (Ø¢Ø®Ø±ÛŒÙ† Ø³ØªÙˆÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ø³Øª Ùˆ ÙÛŒÙ„ØªØ± Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯)
        for (let i = 0; i < 13; i++) { 
            const th = document.createElement('th');
            const input = document.createElement('input');
            input.type = 'text';
            input.oninput = applyFilters;
            input.style.padding = '3px';
            input.style.fontSize = '11px';
            th.appendChild(input);
            filterRow.appendChild(th);
        }
    }
    setupFilterRow();


    // ============ Ø¹Ù…Ù„ÛŒØ§Øª Ø§ÙØ²ÙˆØ¯Ù† ============
    function openAddModal() {
        if (!settings.teamName) {
            return alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù†Ø§Ù… ØªÛŒÙ… Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ø¨Ø®Ø´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
        }
        document.getElementById('addBarcode').value = '';
        document.getElementById('addName').value = '';
        document.getElementById('addStock').value = 0;
        document.getElementById('addCount1').value = 0;
        document.getElementById('addCount2').value = '';
        document.getElementById('addTag').value = '';
        document.getElementById('addTeam').value = settings.teamName;
        document.getElementById('addLocation').value = settings.defaultLocation || '';
        document.getElementById('addNotes').value = '';
        
        updateDiscrepancyAdd();
        document.getElementById('addModal').classList.remove('hidden');
        document.getElementById('addBarcode').focus();
    }

    function closeAddModal() {
      document.getElementById('addModal').classList.add('hidden');
    }

    function updateDiscrepancyAdd() {
        const stock = parseFloat(document.getElementById('addStock').value) || 0;
        const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
        const c2Raw = document.getElementById('addCount2').value;
        
        const disc1 = (c1 - stock).toFixed(2);
        const disc2 = calculateDiscrepancy2(stock, c2Raw, disc1);

        document.getElementById('addDisc1').textContent = disc1;
        document.getElementById('addDisc2').textContent = disc2;
    }
    
    function calculateDiscrepancy2(stock, c2Raw, disc1Str) {
        if (c2Raw === '') return 'â€”';
        const c2 = parseFloat(c2Raw) || 0;
        return (c2 - stock).toFixed(2);
    }

    // **ØªØºÛŒÛŒØ± Ú©Ù„ÛŒØ¯ÛŒ: Ø§Ø±Ø³Ø§Ù„ payload Ø¨Ø§ action: 'save'**
    async function saveAdd() {
      const bc = document.getElementById('addBarcode').value.trim();
      const name = document.getElementById('addName').value.trim();
      const stock = parseFloat(document.getElementById('addStock').value) || 0;
      const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
      const c2Raw = document.getElementById('addCount2').value;
      const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;
      const disc1 = (c1 - stock).toFixed(2);
      const disc2 = calculateDiscrepancy2(stock, c2Raw, disc1);

      if (!bc || !name) return alert('Ø¨Ø§Ø±Ú©Ø¯ Ùˆ Ù†Ø§Ù… Ú©Ø§Ù„Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.');
      if (bc.length < settings.minLength || bc.length > settings.maxLength) return alert(`Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† ${settings.minLength} ØªØ§ ${settings.maxLength} Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.`);


      const newRow = [
        bc, name, c1, disc1, c2, disc2,
        document.getElementById('addTag').value.trim(),
        settings.teamName,
        document.getElementById('addLocation').value.trim(),
        stock,
        document.getElementById('addNotes').value.trim(),
        getNowFa(),
        settings.userName
      ];

      // 1. Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª (Ø§ÙØ²ÙˆØ¯Ù†)
      const tempItems = [...items, newRow];

      // 2. Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Google Sheets
      if (settings.scriptUrl) {
        const payload = {
            action: 'save', // ÛŒØ§ 'edit' Ø§Ú¯Ø± ÙØ±Ø¶ Ú©Ù†ÛŒÙ… Ø¨Ø§Ø±Ú©Ø¯ Ù‚Ø¨Ù„Ø§Ù‹ Ú†Ú© Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† 'save' Ø¨Ù‡ØªØ± Ø§Ø³Øª.
            items: tempItems
        };
        const saveResult = await saveToGoogleAppsScript(payload);

        if (saveResult.success) {
          items = tempItems;
          localStorage.setItem('items', JSON.stringify(items));
          renderTable();
          renderDiscrepancyReports();
          closeAddModal();
          document.getElementById('searchInput').value = '';
          document.getElementById('totalCount').textContent = items.length;
        } 
        // Ø§Ú¯Ø± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ Ø¯Ø± ØªØ§Ø¨Ø¹ saveToGoogleAppsScript Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø¨Ø±Ù†Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ù†Ø¯.
      } else {
        // Ø§Ú¯Ø± Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ ÙÙ‚Ø· Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
        items = tempItems;
        localStorage.setItem('items', JSON.stringify(items));
        renderTable();
        renderDiscrepancyReports();
        closeAddModal();
        document.getElementById('searchInput').value = '';
        document.getElementById('totalCount').textContent = items.length;
        showSyncStatus('ğŸ“± Ø¯Ø§Ø¯Ù‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'info');
      }
    }

    // ============ Ø¹Ù…Ù„ÛŒØ§Øª ÙˆÛŒØ±Ø§ÛŒØ´ ============
    function openEditModal(index) {
      if (index < 0 || index >= items.length) return;
      currentEditIndex = index;
      const row = items[index];

      document.getElementById('editBarcode').value = row[0] || '';
      document.getElementById('editName').value = row[1] || '';
      document.getElementById('editStock').value = row[9] || 0; // Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ
      document.getElementById('editCount1').value = row[2] || 0;
      document.getElementById('editCount2').value = row[4] || '';
      document.getElementById('editTag').value = row[6] || '';
      document.getElementById('editTeam').value = row[7] || settings.teamName;
      document.getElementById('editLocation').value = row[8] || settings.defaultLocation || '';
      document.getElementById('editNotes').value = row[10] || '';
      
      updateDiscrepancyEdit();
      document.getElementById('editModal').classList.remove('hidden');
      document.getElementById('editName').focus();
    }

    function closeEditModal() {
      currentEditIndex = -1;
      document.getElementById('editModal').classList.add('hidden');
    }

    function updateDiscrepancyEdit() {
        const stock = parseFloat(document.getElementById('editStock').value) || 0;
        const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
        const c2Raw = document.getElementById('editCount2').value;
        
        const disc1 = (c1 - stock).toFixed(2);
        const disc2 = calculateDiscrepancy2(stock, c2Raw, disc1);

        document.getElementById('editDisc1').textContent = disc1;
        document.getElementById('editDisc2').textContent = disc2;
    }

    // **ØªØºÛŒÛŒØ± Ú©Ù„ÛŒØ¯ÛŒ: Ø§Ø±Ø³Ø§Ù„ payload Ø¨Ø§ action: 'edit'**
    async function saveEdit() {
      if (currentEditIndex < 0) return;

      const originalRow = items[currentEditIndex];
      const stock = parseFloat(document.getElementById('editStock').value) || 0;
      const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
      const c2Raw = document.getElementById('editCount2').value;
      const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;
      const disc1 = (c1 - stock).toFixed(2);
      const disc2 = calculateDiscrepancy2(stock, c2Raw, disc1);

      const updatedRow = [
        originalRow[0], // Ø¨Ø§Ø±Ú©Ø¯ (Ø«Ø§Ø¨Øª)
        document.getElementById('editName').value.trim(),
        c1,
        disc1,
        c2,
        disc2,
        document.getElementById('editTag').value.trim(),
        settings.teamName,
        document.getElementById('editLocation').value.trim(),
        stock, // Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ (Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø´Ù…Ø§Ø±Ø´ Ø¬Ø¯ÛŒØ¯)
        document.getElementById('editNotes').value.trim(),
        getNowFa(),
        settings.userName
      ];

      // 1. Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
      const tempItems = [...items];
      tempItems[currentEditIndex] = updatedRow;

      // 2. Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡
      if (settings.scriptUrl) {
        const payload = {
            action: 'edit',
            items: tempItems
        };
        const saveResult = await saveToGoogleAppsScript(payload);

        if (saveResult.success) {
          items = tempItems;
          localStorage.setItem('items', JSON.stringify(items));
          renderTable();
          renderDiscrepancyReports();
          closeEditModal();
          document.getElementById('searchInput').value = '';
        }
      } else {
        // Ø§Ú¯Ø± Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ ÙÙ‚Ø· Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
        items = tempItems;
        localStorage.setItem('items', JSON.stringify(items));
        renderTable();
        renderDiscrepancyReports();
        closeEditModal();
        document.getElementById('searchInput').value = '';
        showSyncStatus('ğŸ“± Ø¯Ø§Ø¯Ù‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'info');
      }
    }
    
    function confirmRemove(i) {
        if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ù„Ø§ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) return;
        removeItem(i);
    }

    // **ØªØºÛŒÛŒØ± Ú©Ù„ÛŒØ¯ÛŒ: Ø§Ø±Ø³Ø§Ù„ payload Ø¨Ø§ action: 'delete'**
    async function removeItem(i) {
      if (i < 0 || i >= items.length) return;
      
      const originalItems = [...items];
      const deletedBarcode = originalItems[i][0];
      
      // 1. Ø³Ø§Ø®Øª Ù„ÛŒØ³Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø¯ÙˆÙ† Ø¢ÛŒØªÙ… Ø­Ø°Ù Ø´Ø¯Ù‡
      const tempItems = originalItems.filter((_, index) => index !== i);

      // 2. Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡
      if (settings.scriptUrl) {
        const payload = {
            action: 'delete',
            items: tempItems
        };
        const saveResult = await saveToGoogleAppsScript(payload);

        if (saveResult.success) {
            items = tempItems;
            localStorage.setItem('items', JSON.stringify(items));
            renderTable();
            renderDiscrepancyReports();
            document.getElementById('totalCount').textContent = items.length;
            showSyncStatus(`âœ… Ú©Ø§Ù„Ø§ÛŒ ${deletedBarcode} Ø­Ø°Ù Ùˆ Ø´ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯.`, 'success');
        }
      } else {
        // Ø§Ú¯Ø± Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ ÙÙ‚Ø· Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
        items = tempItems;
        localStorage.setItem('items', JSON.stringify(items));
        renderTable();
        renderDiscrepancyReports();
        document.getElementById('totalCount').textContent = items.length;
        showSyncStatus(`ğŸ—‘ï¸ Ú©Ø§Ù„Ø§ÛŒ ${deletedBarcode} Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ Ø­Ø°Ù Ø´Ø¯.`, 'info');
      }
    }

    // ============ Ø¹Ù…Ù„ÛŒØ§Øª Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ ============
    function renderDiscrepancyReports() {
        const reportBody = document.getElementById('discrepancyReportBody');
        const reportCard = document.getElementById('reportCard');
        
        const discrepancies = items.filter(row => {
            const c1 = parseFloat(row[2]) || 0;
            const c2Raw = String(row[4]);
            const c2 = c2Raw === '' ? 0 : (parseFloat(c2Raw) || 0);
            const stock = parseFloat(row[9]) || 0;
            
            const disc1 = (c1 - stock).toFixed(2);
            const disc2 = calculateDiscrepancy2(stock, c2Raw, disc1);

            return parseFloat(disc1) !== 0 || parseFloat(disc2) !== 0;
        });
        
        if (discrepancies.length === 0) {
            reportBody.innerHTML = '<p style="text-align:center; color:#2e7d32;">ğŸ‰ ØªØ¨Ø±ÛŒÚ©! Ù‡ÛŒÚ† Ù…ØºØ§ÛŒØ±Øª Ø´Ù…Ø§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
            reportCard.style.display = 'block';
            renderTable(); // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ
            return;
        }

        let html = '<table class="table">';
        html += '<thead><tr><th>Ø¨Ø§Ø±Ú©Ø¯</th><th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th><th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th><th>Ø´Ù…Ø§Ø±Ø´ Û±</th><th>Ù…ØºØ§ÛŒØ±Øª Û±</th><th>Ø´Ù…Ø§Ø±Ø´ Û²</th><th>Ù…ØºØ§ÛŒØ±Øª Û²</th><th>Ù…Ø­Ù„</th><th>Ú©Ø§Ø±Ø¨Ø±</th></tr></thead><tbody>';

        discrepancies.forEach(row => {
            const c1 = parseFloat(row[2]) || 0;
            const c2Raw = String(row[4]);
            const c2 = c2Raw === '' ? 0 : (parseFloat(c2Raw) || 0);
            const stock = parseFloat(row[9]) || 0;
            const disc1 = (c1 - stock).toFixed(2);
            const disc2 = calculateDiscrepancy2(stock, c2Raw, disc1);

            html += `
                <tr>
                    <td>${row[0] || 'â€”'}</td>
                    <td>${row[1] || 'â€”'}</td>
                    <td>${stock}</td>
                    <td>${c1}</td>
                    <td style="font-weight:bold; color:${parseFloat(disc1) !== 0 ? '#c62828' : '#2e7d32'};">${disc1}</td>
                    <td>${c2}</td>
                    <td style="font-weight:bold; color:${parseFloat(disc2) !== 0 ? '#c62828' : '#2e7d32'};">${disc2}</td>
                    <td>${row[8] || 'â€”'}</td>
                    <td>${row[12] || 'â€”'}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        reportBody.innerHTML = html;
        
        // Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Øª Ú¯Ø²Ø§Ø±Ø´ Ùˆ Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Øª Ø¬Ø¯ÙˆÙ„ Ø§ØµÙ„ÛŒ
        document.getElementById('mainTableCard').style.display = 'none';
        reportCard.style.display = 'block';
    }

    // ============ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ============
    function openSettingsModal() {
        document.getElementById('settingUserName').value = settings.userName;
        document.getElementById('settingTeamName').value = settings.teamName || '';
        document.getElementById('settingDefaultLocation').value = settings.defaultLocation;
        document.getElementById('settingMinLength').value = settings.minLength;
        document.getElementById('settingMaxLength').value = settings.maxLength;
        document.getElementById('settingSearchByTag').checked = settings.searchByTag;
        document.getElementById('scriptUrl').value = settings.scriptUrl;

        document.getElementById('settingsModal').classList.remove('hidden');
    }

    function saveSettings() {
      const user = document.getElementById('settingUserName').value.trim();
      const team = document.getElementById('settingTeamName').value.trim();
      const loc = document.getElementById('settingDefaultLocation').value.trim();
      const min = parseInt(document.getElementById('settingMinLength').value) || 10;
      const max = parseInt(document.getElementById('settingMaxLength').value) || 20;
      const searchByTag = document.getElementById('settingSearchByTag').checked;
      const scriptUrl = document.getElementById('scriptUrl').value.trim();

      if (min <= 0 || max <= 0) return alert('Ø·ÙˆÙ„â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ù…Ø«Ø¨Øª Ø¨Ø§Ø´Ù†Ø¯.');
      if (min > max) return alert('âš ï¸ Ø­Ø¯Ø§Ù‚Ù„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø­Ø¯Ø§Ú©Ø«Ø± Ø¨Ø§Ø´Ø¯.');

      settings = {
        userName: user,
        teamName: team,
        defaultLocation: loc,
        minLength: min,
        maxLength: max,
        searchByTag,
        scriptUrl
      };

      localStorage.setItem('appSettings', JSON.stringify(settings));
      document.getElementById('globalLocationDisplay').textContent = loc || 'ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡';
      document.getElementById('addTeam').value = team; // Ø¨Ù‡â€ŒØ±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù†
      settings.userName = user; // Ø¨Ù‡â€ŒØ±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±
      settings.teamName = team; // Ø¨Ù‡â€ŒØ±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù… ØªÛŒÙ…
      
      updateSearchUI();
      alert('âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
      document.getElementById('settingsModal').classList.add('hidden');
    }

    function updateSearchUI() {
      const searchByTag = settings.searchByTag;
      const input = document.getElementById('searchInput');
      const scanContainer = document.getElementById('scanButtonContainer');
      if (searchByTag) {
        input.placeholder = "ØªÚ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: T-001)";
        scanContainer.style.display = 'none';
      } else {
        input.placeholder = "Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯";
        scanContainer.style.display = 'flex';
      }
    }

    // ============ Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ ============
    function openCalc(id, index) {
        if (index !== undefined) {
            // Ø§Ú¯Ø± Ø§Ø² Ø¯Ø§Ø®Ù„ Ø¬Ø¯ÙˆÙ„ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø´Ø¯Ù‡
            CURRENT_CALC_TARGET = `editCount${id.includes('1') ? 1 : 2}`;
            const row = items[index];
            document.getElementById('calcDisplay').value = String(row[id.includes('1') ? 2 : 4] || '');
            currentEditIndex = index; // Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø± Ø²Ù…Ø§Ù† Ù…Ø­Ø§Ø³Ø¨Ù‡
        } else {
            // Ø§Ú¯Ø± Ø§Ø² Ø¬Ø§ÛŒ Ø¯ÛŒÚ¯Ø± ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø´Ø¯Ù‡
            CURRENT_CALC_TARGET = id;
            document.getElementById('calcDisplay').value = '';
        }
      
        document.getElementById('calcModal').classList.remove('hidden');
    }
    function calcAppend(c) { document.getElementById('calcDisplay').value += c; }
    function calcBackspace() { const e = document.getElementById('calcDisplay'); e.value = e.value.slice(0, -1); }
    function calcClear() { document.getElementById('calcDisplay').value = ''; }
    
    function calcApply() {
      const expr = document.getElementById('calcDisplay').value;
      if (!expr.trim()) return alert('Ø¹Ø¨Ø§Ø±ØªÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
      const safe = expr.replace(/[^0-9+\-*/().\sÃ·Ã—]/g, '').replace(/Ã·/g, '/').replace(/Ã—/g, '*');
      try {
        const r = new Function('return (' + safe + ')')();
        if (isNaN(r) || !isFinite(r)) throw '';
        const result = parseFloat(r).toFixed(2);

        if (currentEditIndex !== null && currentEditIndex >= 0) {
            // Ø§Ø¹Ù…Ø§Ù„ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø± Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´
            const targetInput = document.getElementById(CURRENT_CALC_TARGET);
            if (targetInput) {
                targetInput.value = result;
                if (CURRENT_CALC_TARGET.startsWith('add')) updateDiscrepancyAdd();
                else if (CURRENT_CALC_TARGET.startsWith('edit')) updateDiscrepancyEdit();
            }
        } else {
            // Ø§Ø¹Ù…Ø§Ù„ Ø¯Ø± ÙÛŒÙ„Ø¯ Ù‡Ø¯Ù Ø§ØµÙ„ÛŒ (Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† ÛŒØ§ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±)
            const t = document.getElementById(CURRENT_CALC_TARGET);
            if (t) {
                t.value = result;
                if (CURRENT_CALC_TARGET.startsWith('add')) updateDiscrepancyAdd();
                else if (CURRENT_CALC_TARGET.startsWith('edit')) updateDiscrepancyEdit();
            }
        }

        closeCalcModal();
      } catch (e) { alert('Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.'); }
    }
    function closeCalcModal() {
      document.getElementById('calcModal').classList.add('hidden');
      CURRENT_CALC_TARGET = null;
      currentEditIndex = -1;
    }

    // ============ ØªÙˆØ§Ø¨Ø¹ Ù…ÙˆÙ‚Ø¹ÛŒØª ============
    function getLocations() {
      const set = new Set();
      items.forEach(r => { const loc = (r[8] || '').trim(); if (loc) set.add(loc); });
      if (settings.defaultLocation) set.add(settings.defaultLocation);
      return Array.from(set).sort();
    }

    function renderDropdown(id, locations) {
      const el = document.getElementById(id);
      if (!el) return;
      el.innerHTML = locations.length
        ? locations.map(l => `<div class="custom-select-option" onclick="selectLocation('${l.replace(/'/g,"\\'")}','${id}')">${l}</div>`).join('')
        : '<div class="custom-select-option" style="color:#999;">Ù…Ø­Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
    }

    function toggleLocationDropdown(context) {
      hideAllDropdowns();
      const map = {
        main: { dropdown: 'locationDropdown', input: 'globalLocation' },
        add:  { dropdown: 'addLocationDropdown', input: 'addLocation' },
        edit: { dropdown: 'editLocationDropdown', input: 'editLocation' },
        settings: { dropdown: 'settingsLocationDropdown', input: 'settingDefaultLocation' }
      };
      const conf = map[context];
      if (!conf) return;
      const { dropdown, input } = conf;
      const el = document.getElementById(dropdown);
      const inp = document.getElementById(input);
      
      if (el && el.classList.contains('hidden')) {
        renderDropdown(dropdown, getLocations());
        el.classList.remove('hidden');
        currentDropdown = context;
        if (inp) {
            inp.focus();
        }
      }
    }

    function hideAllDropdowns() {
      ['locationDropdown','addLocationDropdown','editLocationDropdown','settingsLocationDropdown'].forEach(id=>{
        const e=document.getElementById(id); if(e) e.classList.add('hidden');
      });
      currentDropdown = null;
    }

    function selectLocation(loc, dropdownId) {
      const map = {
        'locationDropdown': 'globalLocation',
        'addLocationDropdown': 'addLocation',
        'editLocationDropdown': 'editLocation',
        'settingsLocationDropdown': 'settingDefaultLocation'
      };
      const inputId = map[dropdownId] || dropdownId.replace('Dropdown', '');
      document.getElementById(inputId).value = loc;
      hideAllDropdowns();
      if (dropdownId === 'locationDropdown') {
          settings.defaultLocation = loc;
          document.getElementById('globalLocationDisplay').textContent = loc;
      }
    }
    
    // Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒÚ© Ø®Ø§Ø±Ø¬ Ø§Ø² Ø¯Ø±Ø§Ù¾â€ŒØ¯Ø§ÙˆÙ†
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.custom-select-container')) {
            hideAllDropdowns();
        }
    });


    // ============ ØªÙˆØ§Ø¨Ø¹ Ø§Ø³Ú©Ù†Ø± ============
    const SCANNERS = [
      { id: 'camera', name: 'ğŸ“¸ Ø§Ø³Ú©Ù† Ø¨Ø§ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø§Ø®Ù„ÛŒ' },
      { id: 'gamma', name: 'Gamma Barcode Scanner',
        intent: 'intent://scan/#Intent;scheme=scan;package=com.gamma.scan;end;' },
      { id: 'zxing', name: 'ZXing Barcode Scanner',
        intent: 'intent://scan/#Intent;scheme=zxing;package=com.google.zxing.client.android;end;' },
      { id: 'easy', name: 'Easy Barcode Scanner',
        intent: 'intent://scan/#Intent;scheme=scan;package=com.tecace.easybarcodescanner;end;' }
    ];

    function openScanner() {
        document.getElementById('cameraModal').classList.remove('hidden');
        startCamera();
    }

    function stopCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        if (scanInterval) {
            clearInterval(scanInterval);
            scanInterval = null;
        }
        if (barcodeDetector) {
            barcodeDetector.close();
            barcodeDetector = null;
        }
        document.getElementById('cameraVideo').srcObject = null;
        document.getElementById('cameraModal').classList.add('hidden');
        resetZoom();
        lastScannedValue = '';
        stableScanCount = 0;
    }

    async function startCamera() {
        if (!('mediaDevices' in navigator) || !('BarcodeDetector' in window)) {
            alert('Ø¯ÙˆØ±Ø¨ÛŒÙ† ÛŒØ§ Ù‚Ø§Ø¨Ù„ÛŒØª ØªØ´Ø®ÛŒØµ Ø¨Ø§Ø±Ú©Ø¯ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
            stopCamera();
            return;
        }

        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            const videoElement = document.getElementById('cameraVideo');
            videoElement.srcObject = videoStream;
            videoElement.setAttribute('playsinline', true);
            await videoElement.play();
            
            barcodeDetector = new BarcodeDetector({ formats: ['CODE_128', 'EAN_13', 'QR_CODE'] });
            scanInterval = setInterval(scanVideoFrame, 300); // Ú†Ú© Ú©Ø±Ø¯Ù† Ù‡Ø± 300 Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡

        } catch (err) {
            console.error("Error accessing camera: ", err);
            alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¨Ø§ Ù…Ø´Ú©Ù„ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯. Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø¬ÙˆØ² Ø¨Ø§Ø´Ø¯.');
            stopCamera();
        }
    }

    async function scanVideoFrame() {
        const videoElement = document.getElementById('cameraVideo');
        if (!videoElement.videoWidth || videoElement.paused) return;

        try {
            const results = await barcodeDetector.detect(videoElement);
            if (results.length > 0) {
                const detectedBarcode = results[0].rawValue;
                if (detectedBarcode === lastScannedValue) {
                    stableScanCount++;
                } else {
                    lastScannedValue = detectedBarcode;
                    stableScanCount = 1;
                }

                // Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ: 3 Ø¨Ø§Ø± Ù¾Ø´Øª Ø³Ø± Ù‡Ù… ÛŒÚ©Ø³Ø§Ù† Ø¨Ø§Ø´Ø¯
                if (stableScanCount >= 3) {
                    handleScannedBarcode(detectedBarcode);
                    stopCamera(); // ØªÙˆÙ‚Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø³ Ø§Ø² Ø§Ø³Ú©Ù† Ù…ÙˆÙÙ‚
                }
            } else {
                lastScannedValue = '';
                stableScanCount = 0;
            }
        } catch (e) {
            console.warn("Barcode detection error:", e);
            lastScannedValue = '';
            stableScanCount = 0;
        }
    }
    
    function zoomIn() {
        zoomLevel = Math.min(zoomLevel + 0.25, 2.0);
        applyZoom();
    }
    function zoomOut() {
        zoomLevel = Math.max(zoomLevel - 0.25, 1.0);
        applyZoom();
    }
    function resetZoom() {
        zoomLevel = 1.0;
        applyZoom();
    }
    function applyZoom() {
        const videoElement = document.getElementById('cameraVideo');
        if (videoElement.style) {
            videoElement.style.transform = `scale(${zoomLevel})`;
            videoElement.style.transformOrigin = 'center';
            document.getElementById('hintZoom').textContent = `ğŸ” Ø²ÙˆÙ…: Ã—${zoomLevel.toFixed(2)}`;
        }
    }

    function handleScannedBarcode(barcode) {
        const trimmedBarcode = barcode.trim();
        document.getElementById('searchInput').value = trimmedBarcode;
        applyFilters(); // ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨Ø§Ø±Ú©Ø¯ Ø§Ø³Ú©Ù† Ø´Ø¯Ù‡
        
        // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
        const foundItem = items.find(item => item[0] === trimmedBarcode);
        if (foundItem) {
            const index = items.findIndex(item => item[0] === trimmedBarcode);
            openEditModal(index);
        } else {
            // Ø§Ú¯Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†
            openAddModal();
            document.getElementById('addBarcode').value = trimmedBarcode;
            document.getElementById('addStock').value = 0; // ÙØ±Ø¶ Ø¨Ø± Ø§ÛŒÙ† Ø§Ø³Øª Ú©Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¯Ø± Ø´ÛŒØª 0 Ø§Ø³Øª
            document.getElementById('addCount1').focus();
            updateDiscrepancyAdd();
        }
    }
    
    function scanBarcode(scannerId) {
        if (scannerId === 'camera') {
            startCamera();
        } else {
            const scanner = SCANNERS.find(s => s.id === scannerId);
            if (scanner && scanner.intent) {
                window.location = scanner.intent;
            } else {
                alert('Ø§Ø³Ú©Ù†Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.');
            }
        }
    }


    // ============ Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø§Ø¯Ù‡ Ø§ØµÙ„ÛŒ ============
    function searchItem() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) {
            renderTable();
            return;
        }
        
        let foundIndex = -1;
        
        if (settings.searchByTag) {
             foundIndex = items.findIndex(row => row[6] === query); // Ø³ØªÙˆÙ† ØªÚ¯ 6
        } else {
             foundIndex = items.findIndex(row => row[0] === query); // Ø³ØªÙˆÙ† Ø¨Ø§Ø±Ú©Ø¯ 0
        }
        
        if (foundIndex !== -1) {
            // Ø§Ú¯Ø± Ù¾ÛŒØ¯Ø§ Ø´Ø¯ØŒ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø§Ø² Ø´ÙˆØ¯
            openEditModal(foundIndex);
        } else {
            // Ø§Ú¯Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø§Ø² Ø´ÙˆØ¯
            openAddModal();
            document.getElementById('addBarcode').value = query;
            document.getElementById('addStock').value = 0;
            document.getElementById('addCount1').focus();
            updateDiscrepancyAdd();
        }
    }

    function importExcel() {
        const fileInput = document.getElementById('excelFile');
        if (!fileInput.files.length) return alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = async (e) => {
            const data = e.target.result;
            // **Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ø§ÛŒØªÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡**
            showSyncStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„...', 'info');
            
            try {
                // Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§ Ù¾Ø§ÛŒØªÙˆÙ†/Ù¾Ø§Ù†Ø¯Ø§Ø³
                const response = await fetch('/api/process_excel', { // Ù…Ø³ÛŒØ± ÙØ±Ø¶ÛŒ
                    method: 'POST',
                    body: data // Ù…Ø¹Ù…ÙˆÙ„Ø§ Ø¨Ù‡ ØµÙˆØ±Øª base64 ÛŒØ§ ÙØ±Ù… Ø¯ÛŒØªØ§ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                });
                
                if (!response.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¯Ø± Ø³Ù…Øª Ø³Ø±ÙˆØ±.');
                
                const result = await response.json(); // ÙØ±Ø¶: Ø¢Ø±Ø§ÛŒÙ‡ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯
                
                if (Array.isArray(result.data)) {
                    // **Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…:** Ø¯Ø§Ø¯Ù‡ Ø§Ú©Ø³Ù„ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ù…Ø§ Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯:
                    // [Ø¨Ø§Ø±Ú©Ø¯, Ù†Ø§Ù…, Ø´Ù…Ø§Ø±Ø´Û±, Ù…ØºØ§ÛŒØ±ØªÛ±, Ø´Ù…Ø§Ø±Ø´Û², Ù…ØºØ§ÛŒØ±ØªÛ², ØªÚ¯, ØªÛŒÙ…, Ù…Ø­Ù„, Ù…ÙˆØ¬ÙˆØ¯ÛŒ, ØªÙˆØ¶ÛŒØ­Ø§Øª, ØªØ§Ø±ÛŒØ®, Ú©Ø§Ø±Ø¨Ø±]
                    
                    const processedItems = result.data.map(item => {
                        // Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ 13 ÙÛŒÙ„Ø¯
                        const stock = item[9] || 0;
                        const c1 = item[2] || 0;
                        const c2 = item[4] || 0;
                        const disc1 = (c1 - stock).toFixed(2);
                        const disc2 = (c2 - stock).toFixed(2);

                        return [
                            String(item[0] || ''), 
                            String(item[1] || ''), 
                            parseFloat(c1), 
                            disc1, 
                            parseFloat(c2), 
                            disc2, 
                            String(item[6] || ''), 
                            settings.teamName, // ØªÛŒÙ… Ø±Ø§ Ø¨Ø§ ØªÛŒÙ… Ø¬Ø§Ø±ÛŒ Ù¾Ø± Ú©Ù†
                            String(item[8] || settings.defaultLocation), 
                            parseFloat(stock), 
                            String(item[10] || ''), 
                            getNowFa(), 
                            settings.userName
                        ];
                    });
                    
                    // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± (ÛŒØ§ Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ)
                    if (settings.scriptUrl) {
                        const payload = { action: 'save', items: processedItems };
                        const saveResult = await saveToGoogleAppsScript(payload);
                        if (saveResult.success) {
                            items = processedItems;
                            localStorage.setItem('items', JSON.stringify(items));
                            renderTable();
                            showSyncStatus('âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ú©Ø³Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´Ø¯Ù†Ø¯.', 'success');
                        }
                    } else {
                        items = processedItems;
                        localStorage.setItem('items', JSON.stringify(items));
                        renderTable();
                        showSyncStatus('âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ú©Ø³Ù„ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯.', 'success');
                    }

                }
            } catch (e) {
                console.error(e);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÛŒØ§ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„.');
            }
        };
        
        reader.readAsText(file); // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒØŒ Ø§Ú¯Ø±Ú†Ù‡ Ø¨Ø±Ø§ÛŒ XLSX Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø§Ø² Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ù…Øª Ø³Ø±ÙˆØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯
    }


</script>
<script>
    // ============ ØªÙˆØ§Ø¨Ø¹ Google Apps Script (ØªÚ©Ù…ÛŒÙ„ Ú©Ù†Ù†Ø¯Ù‡) ============
    
    // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Code.gs Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´ÙˆØ¯ ØªØ§ Ø§Ø² Ø³Ù…Øª Ø³Ø±ÙˆØ± ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø´ÙˆØ¯
    async function saveToGoogleAppsScript(payload) {
        if (!settings.scriptUrl) {
            showSyncStatus('âŒ URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.', 'error');
            return { success: false };
        }
        
        showSyncStatus(`ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ${payload.action} Ø¨Ù‡ Ø³Ø±ÙˆØ±...`, 'info');

        try {
            // **Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² doPost Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§**
            const response = await fetch(settings.scriptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            const resultText = await response.text();
            let result;
            try {
                result = JSON.parse(resultText);
            } catch(e) {
                // Ø§Ú¯Ø± Ø³Ø±ÙˆØ± Ù¾Ø§Ø³Ø® JSON Ù†Ø¯Ø§Ø¯ (Ù…Ø«Ù„Ø§Ù‹ Ø®Ø·Ø§ÛŒ 500)
                throw new Error(`Ù¾Ø§Ø³Ø® ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø³Ø±ÙˆØ±: ${resultText.substring(0, 100)}`);
            }

            if (response.ok && result.success) {
                showSyncStatus('âœ… Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ø´ÛŒØª Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ² Ø¨ÙˆØ¯.', 'success');
                return { success: true };
            } else {
                throw new Error(result.error || `Ø¹Ù…Ù„ÛŒØ§Øª ${payload.action} Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯. Ø³Ø±ÙˆØ±: ${result.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}`);
            }

        } catch (error) {
            console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø³Ù…Øª Ø³Ø±ÙˆØ±:', error);
            showSyncStatus('âŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø´ÛŒØª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.', 'error');
            alert(`âŒ Ø®Ø·Ø§ÛŒ Ø³Ù…Øª Ø³Ø±ÙˆØ±:\n${error.message}`);
            return { success: false };
        }
    }

    // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯â€ŒØ³Ø§Ø²ÛŒ (Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø­ÙØ¸ ÙˆØ¶Ø¹ÛŒØª)
    async function syncAll() {
        if (!settings.scriptUrl) {
            showSyncStatus('URL ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. ÙÙ‚Ø· Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.', 'info');
            return;
        }

        showSyncStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„...', 'info');
        
        // 1. Ø§Ø±Ø³Ø§Ù„ Ú©Ù„ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ (Ø¹Ù…Ù„Ú©Ø±Ø¯ Save)
        const payload = {
            action: 'save',
            items: items
        };
        
        const saveResult = await saveToGoogleAppsScript(payload);
        
        if (saveResult.success) {
            showSyncStatus('âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ² Ø¨ÙˆØ¯.', 'success');
        } else {
            showSyncStatus('âŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.', 'error');
        }
    }
    
    // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø§ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„
    document.getElementById('reportsBtn').onclick = syncAll;
    document.getElementById('reportsBtn').textContent = 'ğŸ”„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ (Save All)';
    
    // ØªØºÛŒÛŒØ± Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø§Ø³Ú©Ù†Ø±
    document.getElementById('scannerBtn').textContent = 'ğŸ” Ø§Ø³Ú©Ù† / Ø¬Ø³ØªØ¬Ùˆ';
</script>
</body>
</html>
