<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Vazir', 'IRANSans', Tahoma, 'B Nazanin', sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    body { background: #f9fafb; padding: 12px; }
    .card { background: white; border-radius: 12px; padding: 16px; margin: 12px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    input, select, textarea, button {
      width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ccc;
      border-radius: 8px; font-size: 16px; text-align: right;
    }
    input[readonly] { background-color: #f5f5f5; }
    input[type="number"] { direction: ltr; text-align: right; }
    button { background: #2e7d32; color: white; border: none; font-weight: bold; cursor: pointer; }
    button.scan { background: #1976d2; }
    button.secondary { background: #757575; }
    button.danger { background: #c62828; }
    .hidden { display: none; }

    .table-container {
      overflow-x: auto;
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: right; }
    .table th { background: #e8f5e9; position: sticky; top: 0; }
    .table thead tr:nth-child(2) th { background: #f1f8e9; padding: 4px; }
    .discrepancy { font-weight: bold; color: #c62828; }
    .duplicate { background-color: #ffebee !important; }
    .actions { text-align: center; white-space: nowrap; }
    .btn-icon { width: auto; padding: 5px 10px; font-size: 14px; margin: 2px; }

    h2, h3 { text-align: center; color: #2e7d32; margin-bottom: 12px; }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; }
    .toolbar > * { flex: 1; min-width: 160px; }

    .modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 95%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .modal.hidden { display: none; }

    .filter-input { 
      width: 100% !important; 
      font-size: 12px !important; 
      padding: 4px 6px !important; 
    }

    .custom-select-container {
      position: relative;
      width: 100%;
    }
    .custom-select-container input {
      padding-right: 36px;
    }
    .select-arrow {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: auto;
      cursor: pointer;
      color: #757575;
      font-size: 14px;
    }
    .custom-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #aaa;
      border-top: none;
      border-radius: 0 0 8px 8px;
      z-index: 10;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .custom-select-dropdown.hidden { display: none; }
    .custom-select-option {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }
    .custom-select-option:hover {
      background: #f0f8f0;
    }
    .custom-select-option:last-child {
      border-bottom: none;
    }

    #cameraVideo {
      width: 100%;
      max-height: 70vh;
      background: #000;
      display: block;
      margin: 0 auto;
    }
    .scanner-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 200px;
      height: 200px;
      margin: -100px 0 0 -100px;
      border: 2px solid #2196f3;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
      pointer-events: none;
    }

    .calc-btn { 
      background: #e0e0e0; 
      color: #333; 
      padding: 8px;
      margin: 2px;
      width: 22%;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #bbb;
    }
    .calc-display {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      text-align: left;
      direction: ltr;
      font-size: 18px;
      background: #fff;
      border: 1px solid #ccc;
    }
    .calc-apply {
      background: #2e7d32 !important;
      width: 100% !important;
      padding: 12px !important;
      margin-top: 10px;
    }

    .sheet-config {
      background: #e3f2fd;
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù†</h2>

    <!-- âœ… ÙÛŒÙ„Ø¯ Ø¢Ø¯Ø±Ø³ Google Apps Script -->
    <div class="sheet-config">
      <label>ğŸ”— Ø¢Ø¯Ø±Ø³ Web App Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª:</label>
      <input type="url" id="sheetUrlInput" placeholder="https://script.google.com/macros/s/.../exec" />
      <button onclick="saveSheetUrl()">âœ… ØªØ§ÛŒÛŒØ¯ Ø¢Ø¯Ø±Ø³</button>
      <p style="font-size:12px; color:#1565c0; margin-top:4px;">
        ğŸ“Œ Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ø±Ø§ Ø§Ø² Google Apps Script â†’ Deploy â†’ Web App Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.
      </p>
    </div>

    <div class="toolbar">
      <button class="secondary" onclick="changeScanner()">ğŸ”„ ØªØºÛŒÛŒØ± Ø§Ø³Ú©Ù†Ø±</button>
      <div>
        <label>ğŸ“ Ù…Ø­Ù„:</label>
        <div class="custom-select-container">
          <input type="text" id="globalLocation" placeholder="Ù…Ø­Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯..." autocomplete="off" />
          <div class="custom-select-dropdown hidden" id="locationDropdown"></div>
          <span class="select-arrow" onclick="toggleLocationDropdown('main')">â–¼</span>
        </div>
      </div>
    </div>

    <button onclick="startScan()" class="scan">ğŸ“¸ Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯ (Free 3 of 9 Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡)</button>
    <p style="text-align:center; margin:8px 0;">ÛŒØ§</p>
    <input type="text" id="barcode" placeholder="Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" autofocus />
    <button onclick="searchOrAdd()">ğŸ” Ø¬Ø³ØªØ¬Ùˆ / Ø§ÙØ²ÙˆØ¯Ù†</button>
  </div>

  <div class="card">
    <h3>Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø§ÙˆÙ„ÛŒÙ‡</h3>
    <input type="file" id="excelFile" accept=".xlsx,.xls" style="width:auto; display:block; margin:0 auto 12px;" />
    <button onclick="loadExcel()">ğŸ“¥ import Ø§Ú©Ø³Ù„</button>
  </div>

  <div class="card">
    <h3>Ù„ÛŒØ³Øª Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (<span id="totalCount">0</span> Ù…ÙˆØ±Ø¯)</h3>
    <input type="text" id="globalSearch" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù‡Ù…Ù‡ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§..." oninput="applyFilters()" style="margin-bottom:12px;" />

    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Ø¨Ø§Ø±Ú©Ø¯</th>
            <th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th>
            <th>Ø´Ù…Ø§Ø±Ø´Û±</th>
            <th>Ù…ØºØ§ÛŒØ±ØªÛ±</th>
            <th>Ø´Ù…Ø§Ø±Ø´Û²</th>
            <th>Ù…ØºØ§ÛŒØ±ØªÛ²</th>
            <th>ØªÚ¯</th>
            <th>ØªÛŒÙ…</th>
            <th>Ù…Ø­Ù„</th>
            <th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th>
            <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
            <th>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</th>
            <th>Ø¯Ø³ØªÚ¯Ø§Ù‡</th>
            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
          </tr>
          <tr id="filterRow"></tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="14" style="text-align:center;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
        </tbody>
      </table>
    </div>

    <div style="text-align:center; margin-top:12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
      <button onclick="clearAll()" class="danger" style="padding:10px 16px; flex:1; max-width:200px;">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡</button>
      <button onclick="exportExcel()" style="background:#1976d2; padding:10px 16px; flex:1; max-width:200px;">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
    </div>
  </div>

  <!-- Ù…Ø¯Ø§Ù„ Ø§Ø³Ú©Ù† -->
  <div id="cameraModal" class="modal hidden">
    <div class="modal-content" style="padding:0; max-width:100%; width:100%; max-height:100%;">
      <div style="position:relative; background:#000;">
        <video id="cameraVideo" playsinline autoplay></video>
        <div class="scanner-frame"></div>
      </div>
      <div style="padding:16px; text-align:center;">
        <button onclick="stopCamera()" class="danger" style="width:auto; padding:10px 20px;">â¹ï¸ ØªÙˆÙ‚Ù Ø§Ø³Ú©Ù†</button>
        <p style="margin-top:10px; font-size:14px; color:#666;">Ø¬Ù‡Øª Ø§Ø³Ú©Ù†ØŒ Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ Ø¯Ø± Ø¯Ø§Ø®Ù„ Ú†Ù‡Ø§Ø±Ú†ÙˆØ¨ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.</p>
      </div>
    </div>
  </div>

  <!-- Ù…Ø¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† -->
  <div id="addModal" class="modal hidden">
    <div class="modal-content">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
      <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="text" id="addBarcode" readonly />
      <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
      <input type="text" id="addName" />
      <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
      <input type="number" id="addStock" step="0.01" readonly />
      <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
      <input type="number" id="addCount1" step="0.01" oninput="updateDiscrepancyAdd()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="addDisc1" class="discrepancy">â€”</span></div>
      <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
      <input type="number" id="addCount2" step="0.01" oninput="updateDiscrepancyAdd()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="addDisc2" class="discrepancy">â€”</span></div>
      <label>ØªÚ¯:</label>
      <input type="text" id="addTag" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¢Ø³ÛŒØ¨â€ŒØ¯ÛŒØ¯Ù‡" />
      <label>ØªÛŒÙ…:</label>
      <input type="text" id="addTeam" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÛŒÙ… Ø§Ù„Ù" />
      <label>Ù…Ø­Ù„:</label>
      <div class="custom-select-container">
        <input type="text" id="addLocation" placeholder="Ù…Ø­Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯..." autocomplete="off" />
        <div class="custom-select-dropdown hidden" id="addLocationDropdown"></div>
        <span class="select-arrow" onclick="toggleLocationDropdown('add')">â–¼</span>
      </div>
      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea id="addNotes" rows="2" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ..."></textarea>
      <div style="display:flex; gap:8px; margin-top:16px;">
        <button onclick="saveAdd()" style="flex:1;">âœ… Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§</button>
        <button onclick="closeAddModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
      </div>
    </div>
  </div>

  <!-- Ù…Ø¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ -->
  <div id="editModal" class="modal hidden">
    <div class="modal-content">
      <h3>ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù„Ø§</h3>
      <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="text" id="editBarcode" readonly />
      <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
      <input type="text" id="editName" />
      <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
      <input type="number" id="editStock" step="0.01" readonly />
      <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
      <input type="number" id="editCount1" step="0.01" oninput="updateDiscrepancyEdit()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="editDisc1" class="discrepancy">â€”</span></div>
      <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
      <input type="number" id="editCount2" step="0.01" oninput="updateDiscrepancyEdit()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="editDisc2" class="discrepancy">â€”</span></div>
      <label>ØªÚ¯:</label>
      <input type="text" id="editTag" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¢Ø³ÛŒØ¨â€ŒØ¯ÛŒØ¯Ù‡" />
      <label>ØªÛŒÙ…:</label>
      <input type="text" id="editTeam" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÛŒÙ… Ø§Ù„Ù" />
      <label>Ù…Ø­Ù„:</label>
      <div class="custom-select-container">
        <input type="text" id="editLocation" placeholder="Ù…Ø­Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯..." autocomplete="off" />
        <div class="custom-select-dropdown hidden" id="editLocationDropdown"></div>
        <span class="select-arrow" onclick="toggleLocationDropdown('edit')">â–¼</span>
      </div>
      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea id="editNotes" rows="2" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ..."></textarea>
      <div style="display:flex; gap:8px; margin-top:16px;">
        <button onclick="saveEdit()" style="flex:1;">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
        <button onclick="closeEditModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
      </div>
    </div>
  </div>

  <!-- Ù…Ø¯Ø§Ù„ Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ -->
  <div id="calcModal" class="modal hidden">
    <div class="modal-content">
      <h3>Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨</h3>
      <input type="text" id="calcDisplay" class="calc-display" placeholder="Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: 12+5*2)" />
      <div style="display:grid; grid-template-columns: repeat(4,1fr); gap:4px;">
        <button class="calc-btn" onclick="calcAppend('7')">7</button>
        <button class="calc-btn" onclick="calcAppend('8')">8</button>
        <button class="calc-btn" onclick="calcAppend('9')">9</button>
        <button class="calc-btn" onclick="calcAppend('/')">Ã·</button>
        <button class="calc-btn" onclick="calcAppend('4')">4</button>
        <button class="calc-btn" onclick="calcAppend('5')">5</button>
        <button class="calc-btn" onclick="calcAppend('6')">6</button>
        <button class="calc-btn" onclick="calcAppend('*')">Ã—</button>
        <button class="calc-btn" onclick="calcAppend('1')">1</button>
        <button class="calc-btn" onclick="calcAppend('2')">2</button>
        <button class="calc-btn" onclick="calcAppend('3')">3</button>
        <button class="calc-btn" onclick="calcAppend('-')">âˆ’</button>
        <button class="calc-btn" onclick="calcAppend('0')">0</button>
        <button class="calc-btn" onclick="calcAppend('.')">.</button>
        <button class="calc-btn" onclick="calcBackspace()">âŒ«</button>
        <button class="calc-btn" onclick="calcAppend('+')">+</button>
      </div>
      <button class="calc-btn calc-apply" onclick="calcApply()">âœ… Ø§Ø¹Ù…Ø§Ù„ Ù†ØªÛŒØ¬Ù‡ Ø¯Ø± Ø´Ù…Ø§Ø±Ø´</button>
      <button class="secondary" style="width:100%; margin-top:8px;" onclick="closeCalcModal()">âŒ Ù„ØºÙˆ</button>
    </div>
  </div>

<script>
// =============== Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… ===============
let items = []; // âŒ Ø¨Ø¯ÙˆÙ† localStorage â€” ÙÙ‚Ø· Ø§Ø² Sheets
let filters = {};
let currentEditIndex = -1;
let currentDropdown = null;
let DEVICE_NAME = 'Web';
let qrScanner = null;
let LAST_SCAN_METHOD = 'camera';
let CURRENT_CALC_TARGET = null;
let SHEET_URL = localStorage.getItem('sheetUrl') || '';

// =============== Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ===============
function faToEnDigits(str) {
  return (str || '').replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d))
                     .replace(/[Ù -Ù©]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d));
}

function getNowFa() {
  return new Intl.DateTimeFormat('fa-IR', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  }).format(new Date()).replace(/ØŒ/g, ' ');
}

function calculateDiscrepancy2(stock, count2Str, discrepancy1) {
  if (parseFloat(discrepancy1) === 0) {
    const c2 = count2Str !== '' ? parseFloat(count2Str) : null;
    if (c2 === null || c2 === 0) return "0.00";
  }
  const c2 = count2Str !== '' ? parseFloat(count2Str) || 0 : 0;
  return (c2 - stock).toFixed(2);
}

// =============== Google Sheets API ===============
async function callSheetApi(action, params = {}, body = null) {
  if (!SHEET_URL) throw new Error('Ø¢Ø¯Ø±Ø³ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');

  const url = new URL(SHEET_URL);
  url.searchParams.set('action', action);
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));

  const init = { method: body ? 'POST' : 'GET' };
  if (body) {
    init.headers = { 'Content-Type': 'application/json' };
    init.body = JSON.stringify(body);
  }

  const res = await fetch(url, init);
  const data = await res.json();
  if (data.status !== 'ok') throw new Error(data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø´ÛŒØª');
  return data;
}

// =============== Ø°Ø®ÛŒØ±Ù‡ Ø¢Ø¯Ø±Ø³ Ø´ÛŒØª ===============
function saveSheetUrl() {
  const url = document.getElementById('sheetUrlInput').value.trim();
  if (!url) return alert('Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
  if (!url.startsWith('https://script.google.com/macros/s/')) {
    if (!confirm('Ø¢Ø¯Ø±Ø³ Ø´Ø¨ÛŒÙ‡ URL Ú¯ÙˆÚ¯Ù„ Ù†ÛŒØ³Øª. Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ')) return;
  }
  SHEET_URL = url;
  localStorage.setItem('sheetUrl', url);
  loadFromSheets(); // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙÙˆØ±ÛŒ
  alert('âœ… Ø¢Ø¯Ø±Ø³ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯.');
}

// =============== Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Sheets ===============
async function loadFromSheets() {
  try {
    const data = await callSheetApi('list');
    items = data.data.map(row => [
      row[0] || '', // Ø¨Ø§Ø±Ú©Ø¯
      row[1] || '', // Ù†Ø§Ù…
      parseFloat(row[2]) || 0, // Ø´Ù…Ø§Ø±Ø´Û±
      row[3] || '0.00', // Ù…ØºØ§ÛŒØ±ØªÛ±
      parseFloat(row[4]) || 0, // Ø´Ù…Ø§Ø±Ø´Û²
      row[5] || '0.00', // Ù…ØºØ§ÛŒØ±ØªÛ²
      row[6] || '', // ØªÚ¯
      row[7] || '', // ØªÛŒÙ…
      row[8] || '', // Ù…Ø­Ù„
      parseFloat(row[9]) || 0, // Ù…ÙˆØ¬ÙˆØ¯ÛŒ
      row[10] || '', // ØªÙˆØ¶ÛŒØ­Ø§Øª
      row[11] || getNowFa(), // Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
      row[12] || 'Web', // Ø¯Ø³ØªÚ¯Ø§Ù‡
      Date.now() // timestamp Ø¨Ø±Ø§ÛŒ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ
    ]);
    renderTable();
  } catch (err) {
    document.getElementById('tableBody').innerHTML = 
      `<tr><td colspan="14" style="text-align:center;color:red;">âŒ Ø®Ø·Ø§: ${err.message}</td></tr>`;
  }
}

// =============== ØªÙˆØ§Ø¨Ø¹ Ø§Ø³Ú©Ù† ===============
const SCANNERS = [
  { id: 'camera', name: 'ğŸ“¸ Ø§Ø³Ú©Ù† Ø¨Ø§ Ø¯ÙˆØ±Ø¨ÛŒÙ† (Free 3 of 9 Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡)', desc: 'Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù†ØµØ¨ Ø¨Ø±Ù†Ø§Ù…Ù‡' },
  { id: 'gamma', name: 'Gamma Barcode Scanner', desc: 'Ø³Ø±ÛŒØ¹ØŒ Ø¨Ø¯ÙˆÙ† ØªØ¨Ù„ÛŒØºØŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² QR/WiFi/Contact/Code 39',
    intent: 'intent://scan/#Intent;scheme=scan;package=com.gamma.scan;end;',
    playUrl: 'https://play.google.com/store/apps/details?id=com.gamma.scan' }
];

function changeScanner() {
  let msg = 'Ù„Ø·ÙØ§Ù‹ Ø±ÙˆØ´ Ø§Ø³Ú©Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\n\n';
  SCANNERS.forEach((s, i) => {
    msg += `${i+1} â†’ ${s.name}\n   ${s.desc}\n`;
  });
  msg += `\nØ´Ù…Ø§Ø±Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: 1):`;
  const choice = prompt(msg, '1');
  const idx = Math.max(0, parseInt(choice) - 1);
  const selected = SCANNERS[idx] || SCANNERS[0];
  LAST_SCAN_METHOD = selected.id;
  alert(`âœ… Ø±ÙˆØ´ Ø§Ø³Ú©Ù†: ${selected.name}`);
}

function startScan() {
  if (LAST_SCAN_METHOD === 'gamma') {
    launchGammaScanner();
  } else {
    startCameraScan();
  }
}

function launchGammaScanner() {
  const scanner = SCANNERS.find(s => s.id === 'gamma');
  if (!scanner) return startCameraScan();
  let opened = false;
  try { opened = !!window.open(scanner.intent, '_self'); } catch (e) {}
  setTimeout(() => {
    if (!opened && confirm('Gamma Scanner Ù†ØµØ¨ Ù†ÛŒØ³Øª. Ù†ØµØ¨ Ø´ÙˆØ¯ØŸ')) {
      window.open(scanner.playUrl, '_blank');
    }
  }, 600);
}

async function startCameraScan() {
  const video = document.getElementById('cameraVideo');
  const modal = document.getElementById('cameraModal');
  if (!video || !modal) return alert('Ø®Ø·Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ: Ø§Ù„Ù…Ø§Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯.');

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'environment' } 
    });
    video.srcObject = stream;
    modal.classList.remove('hidden');

    if (!window.QrScanner) {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js';
      document.head.appendChild(script);
      await new Promise(r => { script.onload = r; });
    }

    if (qrScanner) qrScanner.destroy();
    
    qrScanner = new QrScanner(video, result => {
      stopCamera();
      document.getElementById('barcode').value = result.trim();
      setTimeout(searchOrAdd, 300);
    }, {
      highlightScanRegion: true,
      highlightCodeOutline: true,
      formatsToSupport: ['qr_code', 'ean_13', 'code_39', 'code_128', 'upc_a', 'data_matrix']
    });

    qrScanner.start();
  } catch (err) {
    alert('âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø¯ Ø´Ø¯.');
  }
}

function stopCamera() {
  const modal = document.getElementById('cameraModal');
  modal.classList.add('hidden');
  if (qrScanner) {
    qrScanner.stop();
    qrScanner.destroy();
    qrScanner = null;
  }
  const video = document.getElementById('cameraVideo');
  if (video.srcObject) {
    video.srcObject.getTracks().forEach(t => t.stop());
    video.srcObject = null;
  }
}

// =============== Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ØºØ§ÛŒØ±Øª ===============
function updateDiscrepancyAdd() {
  const stock = parseFloat(document.getElementById('addStock').value) || 0;
  const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
  const c2 = document.getElementById('addCount2').value;
  const disc1 = (c1 - stock).toFixed(2);
  document.getElementById('addDisc1').textContent = disc1;
  const disc2 = calculateDiscrepancy2(stock, c2, disc1);
  document.getElementById('addDisc2').textContent = disc2;
}

function updateDiscrepancyEdit() {
  const stock = parseFloat(document.getElementById('editStock').value) || 0;
  const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
  const c2 = document.getElementById('editCount2').value;
  const disc1 = (c1 - stock).toFixed(2);
  document.getElementById('editDisc1').textContent = disc1;
  const disc2 = calculateDiscrepancy2(stock, c2, disc1);
  document.getElementById('editDisc2').textContent = disc2;
}

// =============== Ù…Ø­Ù„â€ŒÙ‡Ø§ ===============
function getLocations() {
  const set = new Set();
  items.forEach(r => {
    const loc = (r[8] || '').trim();
    if (loc) set.add(loc);
  });
  return Array.from(set).sort();
}

function renderDropdown(id, locations) {
  const el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = locations.length 
    ? locations.map(l => `<div class="custom-select-option" onclick="selectLocation('${l.replace(/'/g,"\\'")}','${id}')">${l}</div>`).join('')
    : '<div class="custom-select-option" style="color:#999;">Ù…Ø­Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
}

function toggleLocationDropdown(context) {
  ['locationDropdown','addLocationDropdown','editLocationDropdown'].forEach(id => {
    const e = document.getElementById(id);
    if (e) e.classList.add('hidden');
  });
  const map = { main: 'locationDropdown', add: 'addLocationDropdown', edit: 'editLocationDropdown' };
  const dropdownId = map[context];
  if (!dropdownId) return;
  const el = document.getElementById(dropdownId);
  if (el.classList.contains('hidden')) {
    renderDropdown(dropdownId, getLocations());
    el.classList.remove('hidden');
  }
}

function selectLocation(loc, dropdownId) {
  const map = { 'locationDropdown': 'globalLocation', 'addLocationDropdown': 'addLocation', 'editLocationDropdown': 'editLocation' };
  const inputId = map[dropdownId] || dropdownId.replace('Dropdown', '');
  document.getElementById(inputId).value = loc;
  toggleLocationDropdown(null);
}

document.addEventListener('click', e => {
  if (!e.target.closest('.custom-select-container')) {
    toggleLocationDropdown(null);
  }
});

// =============== Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ ===============
function searchOrAdd() {
  const bc = document.getElementById('barcode').value.trim();
  const loc = document.getElementById('globalLocation').value.trim();
  if (!bc) return alert('Ù„Ø·ÙØ§Ù‹ Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
  const idx = items.findIndex(r => r[0] === bc && r[8] === loc);
  if (idx !== -1) openEditModal(idx);
  else openAddModal(bc, loc);
}

function openAddModal(bc, loc) {
  const existing = items.find(r => r[0] === bc);
  const stock = existing ? parseFloat(existing[9]) || 0 : 0;
  document.getElementById('addBarcode').value = bc;
  document.getElementById('addLocation').value = loc;
  document.getElementById('addStock').value = stock;
  document.getElementById('addCount1').value = stock;
  document.getElementById('addCount2').value = '';
  document.getElementById('addTag').value = '';
  document.getElementById('addTeam').value = '';
  document.getElementById('addNotes').value = '';
  updateDiscrepancyAdd();
  document.getElementById('addModal').classList.remove('hidden');
}

async function saveAdd() {
  const bc = document.getElementById('addBarcode').value.trim();
  const loc = document.getElementById('addLocation').value.trim();
  const name = document.getElementById('addName').value.trim();
  const stock = parseFloat(document.getElementById('addStock').value) || 0;
  const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
  const c2Raw = document.getElementById('addCount2').value;
  const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;

  const disc1 = (c1 - stock).toFixed(2);
  const disc2 = calculateDiscrepancy2(stock, c2Raw, disc1);

  const newRow = [
    bc, name, c1, disc1, c2, disc2,
    document.getElementById('addTag').value.trim(),
    document.getElementById('addTeam').value.trim(),
    loc,
    stock,
    document.getElementById('addNotes').value.trim(),
    getNowFa(), DEVICE_NAME
  ];

  try {
    // âœ… Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Google Sheets
    await callSheetApi('add', {}, newRow);
    await loadFromSheets(); // Ø±ÙØ±Ø´ Ú©Ø§Ù…Ù„
    closeAddModal();
    document.getElementById('barcode').value = '';
    document.getElementById('barcode').focus();
  } catch (err) {
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: ' + err.message);
  }
}

function closeAddModal() {
  document.getElementById('addModal').classList.add('hidden');
}

function openEditModal(idx) {
  currentEditIndex = idx;
  const r = items[idx];
  document.getElementById('editBarcode').value = r[0];
  document.getElementById('editName').value = r[1];
  document.getElementById('editStock').value = r[9] || 0;
  document.getElementById('editCount1').value = r[2]; // âœ… Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ (Ù†Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ)
  document.getElementById('editCount2').value = r[4] || '';
  document.getElementById('editTag').value = r[6] || '';
  document.getElementById('editTeam').value = r[7] || '';
  document.getElementById('editLocation').value = r[8] || '';
  document.getElementById('editNotes').value = r[10] || '';
  updateDiscrepancyEdit();
  document.getElementById('editModal').classList.remove('hidden');
}

async function saveEdit() {
  if (currentEditIndex < 0) return;
  const r = items[currentEditIndex];
  const bc = r[0], loc = r[8];

  const name = document.getElementById('editName').value.trim();
  const stock = parseFloat(document.getElementById('editStock').value) || 0;
  const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
  const c2Raw = document.getElementById('editCount2').value;
  const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;

  const disc1 = (c1 - stock).toFixed(2);
  const disc2 = calculateDiscrepancy2(stock, c2Raw, disc1);

  const newRow = [
    bc, name, c1, disc1, c2, disc2,
    document.getElementById('editTag').value.trim(),
    document.getElementById('editTeam').value.trim(),
    loc,
    stock,
    document.getElementById('editNotes').value.trim(),
    getNowFa(), DEVICE_NAME
  ];

  try {
    // âœ… Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø± Sheets
    await callSheetApi('update', { barcode: bc, location: loc }, newRow);
    await loadFromSheets();
    closeEditModal();
  } catch (err) {
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ' + err.message);
  }
}

function closeEditModal() {
  document.getElementById('editModal').classList.add('hidden');
  currentEditIndex = -1;
}

async function removeItem(i) {
  if (!confirm('Ø§ÛŒÙ† Ø±Ø¯ÛŒÙ Ø§Ø² Google Sheets Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
  const r = items[i];
  try {
    await callSheetApi('delete', { barcode: r[0], location: r[8] });
    await loadFromSheets();
  } catch (err) {
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù: ' + err.message);
  }
}

// =============== import/export ===============
function loadExcel() {
  const file = document.getElementById('excelFile').files[0];
  if (!file) return alert('ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');

  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { header: 1 });

      if (json.length < 2) return alert('ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.');

      const headers = json[0].map(h => String(h).trim().toLowerCase());
      const getCol = (aliases) => {
        for (let alias of aliases) {
          const i = headers.indexOf(alias);
          if (i !== -1) return i;
        }
        return -1;
      };

      const bcCol = getCol(['Ø¨Ø§Ø±Ú©Ø¯','Ú©Ø¯','id','barcode']);
      const nameCol = getCol(['Ù†Ø§Ù…','Ù†Ø§Ù… Ú©Ø§Ù„Ø§','Ú©Ø§Ù„Ø§','name']);
      const stockCol = getCol(['Ù…ÙˆØ¬ÙˆØ¯ÛŒ','stock','quantity']);
      const count1Col = getCol(['Ø´Ù…Ø§Ø±Ø´1','Ø´Ù…Ø§Ø±Ø´ 1','count1']);
      const count2Col = getCol(['Ø´Ù…Ø§Ø±Ø´2','Ø´Ù…Ø§Ø±Ø´ 2','count2']);
      const tagCol = getCol(['ØªÚ¯','label']);
      const teamCol = getCol(['ØªÛŒÙ…','team']);
      const locCol = getCol(['Ù…Ø­Ù„','location']);
      const notesCol = getCol(['ØªÙˆØ¶ÛŒØ­Ø§Øª','notes']);

      const newRows = [];
      for (let i = 1; i < json.length; i++) {
        const row = json[i];
        const bc = String(row[bcCol] || '').trim();
        if (!bc) continue;

        const stock = parseFloat(String(row[stockCol] || 0).replace(/,/g, '')) || 0;
        const c1 = parseFloat(String(row[count1Col] || stock).replace(/,/g, '')) || 0;
        const c2 = parseFloat(String(row[count2Col] || 0).replace(/,/g, '')) || 0;

        const newRow = [
          bc,
          String(row[nameCol] || '').trim(),
          c1,
          (c1 - stock).toFixed(2),
          c2,
          calculateDiscrepancy2(stock, c2.toString(), (c1 - stock).toFixed(2)),
          String(row[tagCol] || '').trim(),
          String(row[teamCol] || '').trim(),
          String(row[locCol] || '').trim(),
          stock,
          String(row[notesCol] || '').trim(),
          getNowFa(),
          'Import'
        ];
        newRows.push(newRow);
      }

      if (newRows.length === 0) return alert('Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.');

      // âœ… Ø§Ø±Ø³Ø§Ù„ Ø±Ø¯ÛŒÙâ€ŒØ¨Ù‡â€ŒØ±Ø¯ÛŒÙ Ø¨Ù‡ Sheets
      for (const row of newRows) {
        await callSheetApi('add', {}, row);
      }
      await loadFromSheets();
      alert(`âœ… ${newRows.length} Ù…ÙˆØ±Ø¯ import Ùˆ Ø¯Ø± Google Sheets Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.`);
    } catch (err) {
      alert('âŒ Ø®Ø·Ø§ Ø¯Ø± import: ' + (err.message || 'Ù†Ø§Ù…Ø´Ø®Øµ'));
    }
  };
  reader.readAsArrayBuffer(file);
}

function exportExcel() {
  if (items.length === 0) return alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');

  const wsData = [
    ['Ø¨Ø§Ø±Ú©Ø¯','Ù†Ø§Ù… Ú©Ø§Ù„Ø§','Ø´Ù…Ø§Ø±Ø´Û±','Ù…ØºØ§ÛŒØ±ØªÛ±','Ø´Ù…Ø§Ø±Ø´Û²','Ù…ØºØ§ÛŒØ±ØªÛ²','ØªÚ¯','ØªÛŒÙ…','Ù…Ø­Ù„','Ù…ÙˆØ¬ÙˆØ¯ÛŒ','ØªÙˆØ¶ÛŒØ­Ø§Øª','Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ','Ø¯Ø³ØªÚ¯Ø§Ù‡'],
    ...items.map(r => [
      r[0], r[1], r[2], r[3], r[4], r[5],
      r[6], r[7], r[8], r[9], r[10], r[11], r[12]
    ])
  ];

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [{wch:15},{wch:25},{wch:8},{wch:10},{wch:8},{wch:10},{wch:12},{wch:8},{wch:15},{wch:10},{wch:20},{wch:18},{wch:20}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù†Ø¨Ø§Ø±');
  XLSX.writeFile(wb, 'Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ_Ø®Ø±ÙˆØ¬ÛŒ.xlsx');
}

// =============== Ø¬Ø¯ÙˆÙ„ ===============
function renderTable() {
  document.getElementById('totalCount').textContent = items.length;

  // âœ… Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ timestamp (Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø¨Ø§Ù„Ø§ØªØ±)
  items.sort((a, b) => (b[13] || 0) - (a[13] || 0));

  const filtered = items.filter(row => {
    const global = document.getElementById('globalSearch')?.value.toLowerCase() || '';
    if (global && !row.slice(0,13).some(cell => String(cell).toLowerCase().includes(global))) return false;
    for (let c in filters) if (!String(row[c] || '').toLowerCase().includes(filters[c])) return false;
    return true;
  });

  const t = document.getElementById('tableBody');
  if (filtered.length === 0) {
    t.innerHTML = '<tr><td colspan="14" style="text-align:center;">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>';
    return;
  }

  const dupMap = {};
  filtered.forEach(r => {
    const key = `${r[0]}|${r[8]}`;
    dupMap[key] = (dupMap[key] || 0) + 1;
  });

  t.innerHTML = filtered.map((row, _) => {
    const key = `${row[0]}|${row[8]}`;
    const isDup = dupMap[key] > 1;
    const idx = items.findIndex(r => r[0] === row[0] && r[8] === row[8]);
    return `<tr>
      <td${isDup ? ' class="duplicate"' : ''}>${row[0]}</td>
      <td${isDup ? ' class="duplicate"' : ''}>${row[1]}</td>
      <td>${row[2]}</td>
      <td class="discrepancy">${row[3]}</td>
      <td>${row[4]}</td>
      <td class="discrepancy">${row[5]}</td>
      <td>${row[6]}</td>
      <td>${row[7]}</td>
      <td${isDup ? ' class="duplicate"' : ''}>${row[8]}</td>
      <td>${parseFloat(row[9]).toLocaleString('fa-IR')}</td>
      <td>${row[10]}</td>
      <td>${row[11]}</td>
      <td>${row[12]}</td>
      <td class="actions">
        <button class="btn-icon" style="background:#1976d2;" onclick="openEditModal(${idx})">âœï¸</button>
        <button class="btn-icon danger" onclick="removeItem(${idx})">ğŸ—‘ï¸</button>
      </td>
    </tr>`;
  }).join('');
}

function applyFilters() {
  const inputs = document.querySelectorAll('.filter-input');
  filters = {};
  inputs.forEach(inp => {
    const c = parseInt(inp.dataset.col);
    const v = inp.value.toLowerCase();
    if (v) filters[c] = v;
  });
  renderTable();
}

function renderFilterRow() {
  const headers = ['Ø¨Ø§Ø±Ú©Ø¯','Ù†Ø§Ù… Ú©Ø§Ù„Ø§','Ø´Ù…Ø§Ø±Ø´Û±','Ù…ØºØ§ÛŒØ±ØªÛ±','Ø´Ù…Ø§Ø±Ø´Û²','Ù…ØºØ§ÛŒØ±ØªÛ²','ØªÚ¯','ØªÛŒÙ…','Ù…Ø­Ù„','Ù…ÙˆØ¬ÙˆØ¯ÛŒ','ØªÙˆØ¶ÛŒØ­Ø§Øª','Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ','Ø¯Ø³ØªÚ¯Ø§Ù‡'];
  const f = document.getElementById('filterRow');
  f.innerHTML = headers.map((_,i)=>`<th><input type="text" class="filter-input" data-col="${i}" placeholder="ÙÛŒÙ„ØªØ±..." oninput="applyFilters()"></th>`).join('') + '<th></th>';
}

async function clearAll() {
  if (!items.length || !confirm('âš ï¸ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Google Sheets Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ')) return;
  try {
    await callSheetApi('clear');
    items = [];
    renderTable();
    alert('âœ… ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Google Sheets Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.');
  } catch (err) {
    alert('âŒ Ø®Ø·Ø§: ' + err.message);
  }
}

// =============== Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ ===============
function openCalc(targetInputId) {
  CURRENT_CALC_TARGET = targetInputId;
  document.getElementById('calcDisplay').value = '';
  document.getElementById('calcModal').classList.remove('hidden');
}

function calcAppend(char) {
  document.getElementById('calcDisplay').value += char;
}

function calcBackspace() {
  const v = document.getElementById('calcDisplay').value;
  document.getElementById('calcDisplay').value = v.slice(0, -1);
}

function calcApply() {
  const expr = document.getElementById('calcDisplay').value;
  if (!expr.trim()) return alert('Ø¹Ø¨Ø§Ø±ØªÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
  const safe = expr.replace(/[^0-9+\-*/().\sÃ·Ã—]/g, '').replace(/Ã·/g, '/').replace(/Ã—/g, '*');
  try {
    const result = new Function('return (' + safe + ')')();
    if (isNaN(result) || !isFinite(result)) throw '';
    const target = document.getElementById(CURRENT_CALC_TARGET);
    target.value = parseFloat(result).toFixed(2);
    if (CURRENT_CALC_TARGET.startsWith('add')) updateDiscrepancyAdd();
    else if (CURRENT_CALC_TARGET.startsWith('edit')) updateDiscrepancyEdit();
    closeCalcModal();
  } catch (e) {
    alert('Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
  }
}

function closeCalcModal() {
  document.getElementById('calcModal').classList.add('hidden');
  CURRENT_CALC_TARGET = null;
}

// =============== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ===============
document.addEventListener('DOMContentLoaded', () => {
  if (SHEET_URL) {
    document.getElementById('sheetUrlInput').value = SHEET_URL;
  }
  renderFilterRow();

  // Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ Ø±ÙˆÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¹Ø¯Ø¯ÛŒ
  ['addCount1','addCount2','editCount1','editCount2'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      const wrap = document.createElement('div');
      wrap.style.position = 'relative';
      el.parentNode.insertBefore(wrap, el);
      wrap.appendChild(el);
      const btn = document.createElement('button');
      btn.innerHTML = 'ğŸ§®';
      btn.style.cssText = 'position:absolute;left:8px;top:50%;transform:translateY(-50%);background:#e0e0e0;border:none;width:28px;height:28px;border-radius:4px;cursor:pointer;';
      btn.onclick = () => openCalc(id);
      wrap.appendChild(btn);
      el.style.paddingLeft = '40px';
    }
  });

  // Ø§Ú¯Ø± Ø¢Ø¯Ø±Ø³ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ØŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†
  if (SHEET_URL) {
    loadFromSheets();
  } else {
    document.getElementById('tableBody').innerHTML = 
      '<tr><td colspan="14" style="text-align:center;">Ù„Ø·ÙØ§Ù‹ Ø¯Ø± Ø¨Ø§Ù„Ø§ Ø¢Ø¯Ø±Ø³ Google Apps Script Ø±Ø§ ÙˆØ§Ø±Ø¯ Ùˆ ØªØ§ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯.</td></tr>';
  }
});
</script>

<!-- SheetJS + QRScanner -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js"></script>

</body>
</html>