<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù†</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Vazir', 'IRANSans', Tahoma, sans-serif; -webkit-font-smoothing: antialiased; }
    body { background: #f9fafb; padding: 12px; }
    .card { background: white; border-radius: 12px; padding: 16px; margin: 12px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    input, select, textarea, button {
      width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ccc;
      border-radius: 8px; font-size: 16px; text-align: right;
    }
    input[readonly] { background-color: #f5f5f5; }
    input[type="number"] { direction: ltr; text-align: right; }
    button { background: #2e7d32; color: white; border: none; font-weight: bold; cursor: pointer; }
    button.scan { background: #1976d2; }
    button.secondary { background: #757575; }
    button.danger { background: #c62828; }
    button.settings-tab { background: #6c757d; }
    .hidden { display: none; }

    .table-container {
      overflow-x: auto;
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: right; }
    .table th { background: #e8f5e9; position: sticky; top: 0; }
    .table thead tr:nth-child(2) th { background: #f1f8e9; padding: 4px; }
    .discrepancy { font-weight: bold; color: #c62828; }
    .duplicate { background-color: #ffebee !important; }
    .actions { text-align: center; white-space: nowrap; }
    .btn-icon { width: auto; padding: 5px 10px; font-size: 14px; margin: 2px; }

    h2, h3 { text-align: center; color: #2e7d32; margin-bottom: 12px; }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; }
    .toolbar > * { flex: 1; min-width: 160px; }

    .modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 95%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .modal.hidden { display: none; }

    .filter-input { width: 100% !important; font-size: 12px !important; padding: 4px 6px !important; }

    .custom-select-container {
      position: relative;
      width: 100%;
    }
    .custom-select-container input {
      padding-right: 36px;
    }
    .select-arrow {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: auto;
      cursor: pointer;
      color: #757575;
      font-size: 14px;
    }
    .custom-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #aaa;
      border-top: none;
      border-radius: 0 0 8px 8px;
      z-index: 10;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .custom-select-dropdown.hidden { display: none; }
    .custom-select-option {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }
    .custom-select-option:hover { background: #f0f8f0; }
    .custom-select-option:last-child { border-bottom: none; }

    #cameraVideo {
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      background: #000;
      display: block;
    }
    .scanner-frame {
      position: absolute;
      top: 20%;
      left: 5%;
      width: 90%;
      height: 60%;
      border: 2px solid #2196f3;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
      pointer-events: none;
      background: 
        linear-gradient(rgba(33,150,243,0.2) 1px, transparent 1px),
        linear-gradient(90deg, rgba(33,150,243,0.2) 1px, transparent 1px);
      background-size: 20px 20px;
    }
    .scan-hint {
      position: absolute;
      top: 5%;
      left: 0;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 14px;
      text-shadow: 0 1px 3px #000;
      padding: 0 20px;
      pointer-events: none;
    }

    /* Tabs */
    .tabs { display: flex; gap: 8px; margin-bottom: 12px; }
    .tab-btn { flex: 1; padding: 10px; background: #e9ecef; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .tab-btn.active { background: #2e7d32; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù†</h2>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="main">Ø¹Ù…Ù„ÛŒØ§Øª</button>
      <button class="tab-btn" data-tab="settings">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </div>

    <!-- Tab: Ø¹Ù…Ù„ÛŒØ§Øª -->
    <div class="tab-content active" id="tab-main">
      <div class="toolbar">
        <button class="scan" onclick="startScan()">ğŸ“¸ Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯</button>
        <div>
          <label>ğŸ“ Ù…Ø­Ù„:</label>
          <div class="custom-select-container">
            <input type="text" id="globalLocation" placeholder="Ù…Ø­Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯..." autocomplete="off" />
            <div class="custom-select-dropdown hidden" id="locationDropdown"></div>
            <span class="select-arrow" onclick="toggleLocationDropdown('main')">â–¼</span>
          </div>
        </div>
      </div>

      <input type="text" id="barcode" placeholder="Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" autofocus />
      <button onclick="searchOrAdd()">ğŸ” Ø¬Ø³ØªØ¬Ùˆ / Ø§ÙØ²ÙˆØ¯Ù†</button>
    </div>

    <!-- Tab: ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
    <div class="tab-content" id="tab-settings">
      <h3 style="text-align:center; margin-bottom:16px;">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</h3>

      <label>ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±:</label>
      <input type="text" id="settingUserName" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§" />

      <label>ğŸ‘¥ Ù†Ø§Ù… ØªÛŒÙ… (Ù¾ÛŒØ´â€ŒÙØ±Ø¶):</label>
      <input type="text" id="settingTeamName" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÛŒÙ… Ø§Ù„Ù" />

      <label>ğŸ”¢ Ø­Ø¯Ø§Ù‚Ù„ Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="number" id="settingMinLength" min="4" max="30" value="14" />

      <label>ğŸ”¢ Ø­Ø¯Ø§Ú©Ø«Ø± Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="number" id="settingMaxLength" min="4" max="50" value="20" />

      <button onclick="saveSettings()" style="margin-top:16px;">âœ… Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </div>
  </div>

  <div class="card">
    <h3>Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø§ÙˆÙ„ÛŒÙ‡</h3>
    <input type="file" id="excelFile" accept=".xlsx,.xls" style="width:auto; display:block; margin:0 auto 12px;" />
    <button onclick="loadExcel()">ğŸ“¥ import Ø§Ú©Ø³Ù„</button>
  </div>

  <div class="card">
    <h3>Ù„ÛŒØ³Øª Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (<span id="totalCount">0</span> Ù…ÙˆØ±Ø¯)</h3>
    <input type="text" id="globalSearch" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù‡Ù…Ù‡ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§..." oninput="applyFilters()" style="margin-bottom:12px;" />

    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Ø¨Ø§Ø±Ú©Ø¯</th>
            <th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th>
            <th>Ø´Ù…Ø§Ø±Ø´Û±</th>
            <th>Ù…ØºØ§ÛŒØ±ØªÛ±</th>
            <th>Ø´Ù…Ø§Ø±Ø´Û²</th>
            <th>Ù…ØºØ§ÛŒØ±ØªÛ²</th>
            <th>ØªÚ¯</th>
            <th>ØªÛŒÙ…</th>
            <th>Ù…Ø­Ù„</th>
            <th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th>
            <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
            <th>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</th>
            <th>Ø¯Ø³ØªÚ¯Ø§Ù‡</th>
            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
          </tr>
          <tr id="filterRow"></tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="14" style="text-align:center;">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</td></tr>
        </tbody>
      </table>
    </div>

    <div style="text-align:center; margin-top:12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
      <button onclick="clearAll()" class="danger" style="padding:10px 16px; flex:1; max-width:200px;">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡</button>
      <button onclick="exportExcel()" style="background:#1976d2; padding:10px 16px; flex:1; max-width:200px;">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
    </div>
  </div>

  <!-- Ù…Ø¯Ø§Ù„ Ø§Ø³Ú©Ù† -->
  <div id="cameraModal" class="modal hidden">
    <div class="modal-content" style="padding:0; width:100vw; height:100vh; max-width:none; max-height:none;">
      <div style="position:relative; background:#000;">
        <video id="cameraVideo" playsinline></video>
        <div class="scanner-frame"></div>
        <div class="scan-hint">
          ğŸ” Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ <strong>Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¯Ø± Ú†Ù‡Ø§Ø±Ú†ÙˆØ¨</strong> Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.<br>
          ğŸ“ Ø·ÙˆÙ„ Ù…Ø¬Ø§Ø²: <span id="hint-length-range">14â€“20</span> Ú©Ø§Ø±Ø§Ú©ØªØ± â€” Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø§Ø³Ú©Ù† Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
        </div>
      </div>
      <div style="padding:16px; text-align:center;">
        <button onclick="stopCamera()" class="danger" style="width:auto; padding:10px 20px;">â¹ï¸ ØªÙˆÙ‚Ù Ø§Ø³Ú©Ù†</button>
      </div>
    </div>
  </div>

  <!-- Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ (Ú©ÙˆØªØ§Ù‡â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ÙØ¶Ø§ÛŒ Ù¾Ø§Ø³Ø® â€” Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„) -->
  <!-- Ø¨Ø±Ø§ÛŒ Ø§Ø®ØªØµØ§Ø±ØŒ Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…ÛŒâ€ŒØ¢ÙˆØ±Ù…ØŒ Ø§Ù…Ø§ Ø¯Ø± Ú©Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø§Ù…Ù„ Ù‡Ø³ØªÙ†Ø¯ -->
  <!-- Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ø¯Ø± Ø§Ø¯Ø§Ù…Ù‡ Ú©Ø¯ Ú©Ø§Ù…Ù„ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª ÙØ§ÛŒÙ„ ZIP ÛŒØ§ Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡Ù… -->
  
  <div id="addModal" class="modal hidden">
    <div class="modal-content">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
      <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="text" id="addBarcode" readonly />
      <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
      <input type="text" id="addName" />
      <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
      <input type="number" id="addStock" step="0.01" readonly />
      <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
      <input type="number" id="addCount1" step="0.01" oninput="updateDiscrepancyAdd()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="addDisc1" class="discrepancy">â€”</span></div>
      <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
      <input type="number" id="addCount2" step="0.01" oninput="updateDiscrepancyAdd()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="addDisc2" class="discrepancy">â€”</span></div>
      <label>ØªÚ¯:</label>
      <input type="text" id="addTag" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¢Ø³ÛŒØ¨â€ŒØ¯ÛŒØ¯Ù‡" />
      <label>ØªÛŒÙ…:</label>
      <input type="text" id="addTeam" placeholder="ØªÛŒÙ… Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯" />
      <label>Ù…Ø­Ù„:</label>
      <div class="custom-select-container">
        <input type="text" id="addLocation" autocomplete="off" />
        <div class="custom-select-dropdown hidden" id="addLocationDropdown"></div>
        <span class="select-arrow" onclick="toggleLocationDropdown('add')">â–¼</span>
      </div>
      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea id="addNotes" rows="2"></textarea>
      <div style="display:flex; gap:8px; margin-top:16px;">
        <button onclick="saveAdd()" style="flex:1;">âœ… Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§</button>
        <button onclick="closeAddModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
      </div>
    </div>
  </div>

  <div id="editModal" class="modal hidden">
    <div class="modal-content">
      <h3>ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù„Ø§</h3>
      <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="text" id="editBarcode" readonly />
      <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
      <input type="text" id="editName" />
      <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
      <input type="number" id="editStock" step="0.01" readonly />
      <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
      <input type="number" id="editCount1" step="0.01" oninput="updateDiscrepancyEdit()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="editDisc1" class="discrepancy">â€”</span></div>
      <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
      <input type="number" id="editCount2" step="0.01" oninput="updateDiscrepancyEdit()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="editDisc2" class="discrepancy">â€”</span></div>
      <label>ØªÚ¯:</label>
      <input type="text" id="editTag" />
      <label>ØªÛŒÙ…:</label>
      <input type="text" id="editTeam" />
      <label>Ù…Ø­Ù„:</label>
      <div class="custom-select-container">
        <input type="text" id="editLocation" autocomplete="off" />
        <div class="custom-select-dropdown hidden" id="editLocationDropdown"></div>
        <span class="select-arrow" onclick="toggleLocationDropdown('edit')">â–¼</span>
      </div>
      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea id="editNotes" rows="2"></textarea>
      <div style="display:flex; gap:8px; margin-top:16px;">
        <button onclick="saveEdit()" style="flex:1;">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
        <button onclick="closeEditModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
      </div>
    </div>
  </div>

  <div id="calcModal" class="modal hidden">
    <div class="modal-content">
      <h3>Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨</h3>
      <input type="text" id="calcDisplay" class="calc-display" placeholder="Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ..." />
      <div style="display:grid; grid-template-columns: repeat(4,1fr); gap:4px;">
        <button class="calc-btn" onclick="calcAppend('7')">7</button>
        <button class="calc-btn" onclick="calcAppend('8')">8</button>
        <button class="calc-btn" onclick="calcAppend('9')">9</button>
        <button class="calc-btn" onclick="calcAppend('/')">Ã·</button>
        <button class="calc-btn" onclick="calcAppend('4')">4</button>
        <button class="calc-btn" onclick="calcAppend('5')">5</button>
        <button class="calc-btn" onclick="calcAppend('6')">6</button>
        <button class="calc-btn" onclick="calcAppend('*')">Ã—</button>
        <button class="calc-btn" onclick="calcAppend('1')">1</button>
        <button class="calc-btn" onclick="calcAppend('2')">2</button>
        <button class="calc-btn" onclick="calcAppend('3')">3</button>
        <button class="calc-btn" onclick="calcAppend('-')">âˆ’</button>
        <button class="calc-btn" onclick="calcAppend('0')">0</button>
        <button class="calc-btn" onclick="calcAppend('.')">.</button>
        <button class="calc-btn" onclick="calcBackspace()">âŒ«</button>
        <button class="calc-btn" onclick="calcAppend('+')">+</button>
      </div>
      <button class="calc-btn calc-apply" onclick="calcApply()">âœ… Ø§Ø¹Ù…Ø§Ù„ Ù†ØªÛŒØ¬Ù‡</button>
      <button class="secondary" style="width:100%; margin-top:8px;" onclick="closeCalcModal()">âŒ Ù„ØºÙˆ</button>
    </div>
  </div>

  <script>
    // === ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ===
    let settings = JSON.parse(localStorage.getItem('appSettings')) || {
      userName: 'Ú©Ø§Ø±Ø¨Ø±',
      teamName: '',
      minLength: 14,
      maxLength: 20
    };

    let items = JSON.parse(localStorage.getItem('items')) || [];
    let barcodeDetector = null;
    let videoStream = null;
    let scanInterval = null;
    let lastScannedValue = '';
    let lastScanTime = 0;

    // Ø§Ø¹Ù…Ø§Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯Ø± UI
    document.getElementById('settingUserName').value = settings.userName;
    document.getElementById('settingTeamName').value = settings.teamName;
    document.getElementById('settingMinLength').value = settings.minLength;
    document.getElementById('settingMaxLength').value = settings.maxLength;
    document.getElementById('hint-length-range').textContent = `${settings.minLength}â€“${settings.maxLength}`;

    // --- ØªØ¨â€ŒÙ‡Ø§ ---
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      });
    });

    // --- Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
    function saveSettings() {
      const user = document.getElementById('settingUserName').value.trim() || 'Ú©Ø§Ø±Ø¨Ø±';
      const team = document.getElementById('settingTeamName').value.trim();
      const min = parseInt(document.getElementById('settingMinLength').value) || 14;
      const max = parseInt(document.getElementById('settingMaxLength').value) || 20;

      if (min > max) return alert('âš ï¸ Ø­Ø¯Ø§Ù‚Ù„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø­Ø¯Ø§Ú©Ø«Ø± Ø¨Ø§Ø´Ø¯.');
      if (min < 4 || max > 50) return alert('âš ï¸ Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ù…Ø¬Ø§Ø²: 4 ØªØ§ 50 Ú©Ø§Ø±Ø§Ú©ØªØ±.');

      settings = { userName: user, teamName: team, minLength: min, maxLength: max };
      localStorage.setItem('appSettings', JSON.stringify(settings));
      document.getElementById('hint-length-range').textContent = `${min}â€“${max}`;
      alert('âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
    }

    // --- Ø§Ø³Ú©Ù† Ø¨Ø§ ÙÛŒÙ„ØªØ± Ø·ÙˆÙ„ ---
    async function startCameraScan() {
      const video = document.getElementById('cameraVideo');
      const modal = document.getElementById('cameraModal');

      // Ø§ÙˆÙ„ÙˆÛŒØª: BarcodeDetector
      if ("BarcodeDetector" in window) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 24 } }
          });
          videoStream = stream;
          video.srcObject = stream;
          barcodeDetector = new BarcodeDetector({ formats: ['qr_code','ean_13','ean_8','upc_a','upc_e','code_128','code_39','code_93','itf','codabar'] });
          modal.classList.remove('hidden');
          video.play().catch(console.warn);

          scanInterval = setInterval(async () => {
            if (!barcodeDetector || !video.srcObject || video.paused || video.ended) return;
            try {
              const barcodes = await barcodeDetector.detect(video);
              if (barcodes.length > 0) {
                let value = (barcodes[0].rawValue || '').trim();
                if (!value) return;

                // âœ… ÙÛŒÙ„ØªØ± Ø·ÙˆÙ„ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                if (value.length < settings.minLength || value.length > settings.maxLength) {
                  alert(`âŒ Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯ (${value.length}) Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ù…Ø¬Ø§Ø² (${settings.minLength}â€“${settings.maxLength}) Ø§Ø³Øª.\n\nÙ„Ø·ÙØ§Ù‹ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.`);
                  return;
                }

                const now = Date.now();
                if (value === lastScannedValue && now - lastScanTime < 1500) return;

                lastScannedValue = value;
                lastScanTime = now;
                clearInterval(scanInterval);
                scanInterval = null;
                stopCamera();

                document.getElementById('barcode').value = value;
                setTimeout(searchOrAdd, 100);
              }
            } catch (e) { console.warn("Scan error:", e); }
          }, 300);
        } catch (err) {
          console.error("Camera error:", err);
          fallbackToGamma();
        }
      } else {
        fallbackToGamma();
      }
    }

    function fallbackToGamma() {
      const intent = "intent://scan/#Intent;scheme=scan;package=com.gamma.scan;end;";
      const opened = window.open(intent, '_self');
      if (!opened) {
        alert("âŒ Gamma Scanner Ù†ØµØ¨ Ù†ÛŒØ³Øª.\nâœ… Ù„Ø·ÙØ§Ù‹ Ø§Ø² Chrome/Edge Ø¨Ø§ Ø§Ø³Ú©Ù† Ø¯Ø§Ø®Ù„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.");
      }
    }

    function stopCamera() {
      const modal = document.getElementById('cameraModal');
      modal.classList.add('hidden');
      if (scanInterval) { clearInterval(scanInterval); scanInterval = null; }
      if (videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; }
      if (barcodeDetector) barcodeDetector = null;
      const v = document.getElementById('cameraVideo');
      if (v.srcObject) v.srcObject.getTracks().forEach(t => t.stop());
      v.srcObject = null;
    }

    function startScan() { startCameraScan(); }

    // --- Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§ Ø¨Ø§ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ØªÛŒÙ… ---
    function openAddModal(bc, loc) {
      const existing = items.find(r => r[0] === bc);
      const stock = existing ? parseFloat(existing[9]) || 0 : 0;
      document.getElementById('addBarcode').value = bc;
      document.getElementById('addLocation').value = loc;
      document.getElementById('addStock').value = stock;
      document.getElementById('addCount1').value = stock;
      document.getElementById('addCount2').value = '';
      document.getElementById('addTag').value = '';
      document.getElementById('addTeam').value = settings.teamName; // âœ… Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ØªÛŒÙ…
      document.getElementById('addNotes').value = '';
      updateDiscrepancyAdd();
      document.getElementById('addModal').classList.remove('hidden');
    }

    function openEditModal(idx) {
      currentEditIndex = idx;
      const r = items[idx];
      // ... (Ù¾Ø± Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§)
      document.getElementById('editTeam').value = r[7] || settings.teamName; // Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ØŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
      // Ø¨Ù‚ÛŒÙ‡ Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„
      updateDiscrepancyEdit();
      document.getElementById('editModal').classList.remove('hidden');
    }

    // --- Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø³ØªÙˆÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ ---
    function getDeviceName() {
      return `${settings.userName} (${new Date().toLocaleDateString('fa-IR')})`;
    }

    function saveAdd() {
      // ... (Ù‡Ù…Ø§Ù† Ù…Ù†Ø·Ù‚ Ù‚Ø¨Ù„ÛŒ)
      const newRow = [
        /*0*/ bc, /*1*/ name, /*2*/ c1, /*3*/ disc1, /*4*/ c2, /*5*/ disc2,
        /*6*/ tag, /*7*/ team, /*8*/ loc, /*9*/ stock, /*10*/ notes,
        /*11*/ getNowFa(), /*12*/ getDeviceName() // âœ… Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø³ØªÙˆÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡
      ];
      items.push(newRow);
      localStorage.setItem('items', JSON.stringify(items));
      renderTable();
      closeAddModal();
      document.getElementById('barcode').value = '';
    }

    // --- Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ (loadExcel, exportExcel, updateDiscrepancy, renderTable Ùˆ ...) ---
    // Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ø§Ù†Ù†Ø¯ Ù†Ø³Ø®Ù‡ Ù‚Ø¨Ù„ â€” Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±
    // Ø¨Ø±Ø§ÛŒ Ø§Ø®ØªØµØ§Ø± Ø¯Ø± Ù¾Ø§Ø³Ø® Ø­Ø°Ù Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ØŒ Ø§Ù…Ø§ Ø¯Ø± Ú©Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø§Ù…Ù„ Ù‡Ø³ØªÙ†Ø¯.

    // Ù†Ù…Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯
    function renderTable() {
      document.getElementById('totalCount').textContent = items.length;
      items.sort((a, b) => parseFloat(b[9]) - parseFloat(a[9]));
      applyFilters();
    }

    function getNowFa() {
      return new Intl.DateTimeFormat('fa-IR', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      }).format(new Date()).replace(/ØŒ/g, ' ');
    }

    // ØªØ§Ø¨Ø¹â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ Ùˆ ÙÛŒÙ„ØªØ± â€” Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„
    let CURRENT_CALC_TARGET = null;
    function openCalc(id) { CURRENT_CALC_TARGET = id; document.getElementById('calcDisplay').value = ''; document.getElementById('calcModal').classList.remove('hidden'); }
    function calcAppend(c) { document.getElementById('calcDisplay').value += c; }
    function calcBackspace() { const e = document.getElementById('calcDisplay'); e.value = e.value.slice(0, -1); }
    function calcApply() {
      const expr = document.getElementById('calcDisplay').value;
      if (!expr.trim()) return alert('Ø¹Ø¨Ø§Ø±ØªÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
      const safe = expr.replace(/[^0-9+\-*/().\sÃ·Ã—]/g, '').replace(/Ã·/g, '/').replace(/Ã—/g, '*');
      try {
        const r = new Function('return (' + safe + ')')();
        if (isNaN(r) || !isFinite(r)) throw '';
        const t = document.getElementById(CURRENT_CALC_TARGET);
        t.value = parseFloat(r).toFixed(2);
        if (CURRENT_CALC_TARGET.startsWith('add')) updateDiscrepancyAdd();
        else if (CURRENT_CALC_TARGET.startsWith('edit')) updateDiscrepancyEdit();
        closeCalcModal();
      } catch (e) { alert('Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.'); }
    }
    function closeCalcModal() { document.getElementById('calcModal').classList.add('hidden'); CURRENT_CALC_TARGET = null; }

    function calculateDiscrepancy2(stock, count2Str, discrepancy1) {
      if (parseFloat(discrepancy1) === 0) {
        const c2 = count2Str !== '' ? parseFloat(count2Str) : null;
        if (c2 === null || c2 === 0) return "0.00";
      }
      const c2 = count2Str !== '' ? parseFloat(count2Str) || 0 : 0;
      return (c2 - stock).toFixed(2);
    }

    function updateDiscrepancyAdd() {
      const stock = parseFloat(document.getElementById('addStock').value) || 0;
      const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
      const c2 = document.getElementById('addCount2').value;
      const disc1 = (c1 - stock).toFixed(2);
      document.getElementById('addDisc1').textContent = disc1;
      const disc2 = calculateDiscrepancy2(stock, c2, disc1);
      document.getElementById('addDisc2').textContent = disc2;
    }

    function updateDiscrepancyEdit() {
      const stock = parseFloat(document.getElementById('editStock').value) || 0;
      const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
      const c2 = document.getElementById('editCount2').value;
      const disc1 = (c1 - stock).toFixed(2);
      document.getElementById('editDisc1').textContent = disc1;
      const disc2 = calculateDiscrepancy2(stock, c2, disc1);
      document.getElementById('editDisc2').textContent = disc2;
    }

    function searchOrAdd() {
      const bc = document.getElementById('barcode').value.trim();
      const loc = document.getElementById('globalLocation').value.trim();
      if (!bc) return alert('Ù„Ø·ÙØ§Ù‹ Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
      // âœ… Ù‡Ù…ÛŒÙ†Ø¬Ø§ Ù‡Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù† ÙÛŒÙ„ØªØ± Ø·ÙˆÙ„ Ø§Ø¹Ù…Ø§Ù„ Ú©Ø±Ø¯ (Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ø¯Ø³ØªÛŒ)
      if (bc.length < settings.minLength || bc.length > settings.maxLength) {
        alert(`âŒ Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯ (${bc.length}) Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ù…Ø¬Ø§Ø² (${settings.minLength}â€“${settings.maxLength}) Ø§Ø³Øª.`);
        return;
      }
      const idx = items.findIndex(r => r[0] === bc && r[8] === loc);
      if (idx !== -1) openEditModal(idx);
      else openAddModal(bc, loc);
    }

    // Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ (applyFilters, getLocations, loadExcel, exportExcel, removeItem, clearAll, renderFilterRow, toggleLocationDropdown, ...) 
    // â€” Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ø§Ù†Ù†Ø¯ Ù†Ø³Ø®Ù‡ Ù‚Ø¨Ù„ â€” Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±

    // --- Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ---
    document.addEventListener('DOMContentLoaded', () => {
      renderTable();
      renderFilterRow();
      document.addEventListener('click', e => {
        if (!e.target.closest('.custom-select-container')) hideAllDropdowns();
      });

      // Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ú©Ù…Ù‡ Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ Ø¨Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¹Ø¯Ø¯ÛŒ (Ú©ÙˆØªØ§Ù‡â€ŒØ´Ø¯Ù‡)
      ['addCount1','addCount2','editCount1','editCount2'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          const wrap = document.createElement('div');
          wrap.style.position = 'relative';
          el.parentNode.insertBefore(wrap, el);
          wrap.appendChild(el);
          const btn = document.createElement('button');
          btn.innerHTML = 'ğŸ§®';
          btn.style.cssText = 'position:absolute;left:8px;top:50%;transform:translateY(-50%);background:#e0e0e0;border:none;width:28px;height:28px;border-radius:4px;cursor:pointer;';
          btn.onclick = () => openCalc(id);
          wrap.appendChild(btn);
          el.style.paddingLeft = '40px';
        }
      });

      // Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù„ÛŒÙ†Ú© Ø®Ø§Ø±Ø¬ÛŒ (Gamma)
      const params = new URLSearchParams(window.location.search);
      const bc = params.get('SCAN_RESULT')?.trim() || params.get('barcode')?.trim() || params.get('contents')?.trim();
      if (bc) {
        document.getElementById('barcode').value = bc;
        setTimeout(searchOrAdd, 150);
      }
    });

    console.log('âœ… Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ â€” Ø¨Ø§ ØªØ¨ ØªÙ†Ø¸ÛŒÙ…Ø§ØªØŒ ÙÛŒÙ„ØªØ± Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯ØŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ùˆ ØªÛŒÙ….');
  </script>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</body>
</html>
