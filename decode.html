<script>
    // ============ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ ============
    let settings = JSON.parse(localStorage.getItem('appSettings')) || {
      userName: 'Ú©Ø§Ø±Ø¨Ø±',
      teamName: '',
      defaultLocation: 'Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ',
      minLength: 14,
      maxLength: 20,
      searchByTag: false,
      scriptUrl: ''
    };
    
    let items = JSON.parse(localStorage.getItem('items')) || [];
    let filters = {};
    let currentEditIndex = -1;
    let currentDropdown = null;
    let LAST_SCAN_METHOD = localStorage.getItem('scanner') || 'camera';
    let barcodeDetector = null;
    let videoStream = null;
    let scanInterval = null;
    let lastScannedValue = '';
    let stableScanCount = 0;
    let zoomLevel = 1.0;
    let CURRENT_CALC_TARGET = null;
    
    // ============ ØªÙˆØ§Ø¨Ø¹ Google Apps Script ============
    
    // Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª
    function showSyncStatus(message, type = 'info') {
      const statusEl = document.getElementById('syncStatus');
      statusEl.textContent = message;
      statusEl.className = 'sync-status show';
      if (type === 'success') statusEl.classList.add('success');
      else if (type === 'error') statusEl.classList.add('error');
      
      setTimeout(() => {
        statusEl.classList.remove('show');
      }, 3000);
    }
    
    // ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
    async function testScriptConnection() {
      const scriptUrl = document.getElementById('scriptUrl').value.trim();
      
      if (!scriptUrl) {
        alert('Ù„Ø·ÙØ§Ù‹ URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
      }
      
      showSyncStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§ØªØµØ§Ù„...', 'info');
      
      try {
        const response = await fetch(scriptUrl);
        
        if (response.ok) {
          settings.scriptUrl = scriptUrl;
          localStorage.setItem('appSettings', JSON.stringify(settings));
          showSyncStatus('âœ… Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚!', 'success');
          alert('âœ… Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯!');
        } else {
          throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
        }
      } catch (error) {
        showSyncStatus('âŒ Ø§ØªØµØ§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚', 'error');
        alert(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„:\n${error.message}`);
      }
    }
    
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Google Apps Script
    async function loadFromGoogleAppsScript() {
      if (!settings.scriptUrl) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ùˆ ØªØ³Øª Ú©Ù†ÛŒØ¯');
        return;
      }
      
      showSyncStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...', 'info');
      
      try {
        const response = await fetch(settings.scriptUrl);
        
        if (!response.ok) {
          throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (Array.isArray(data)) {
          items = data;
          localStorage.setItem('items', JSON.stringify(items));
          showSyncStatus(`âœ… ${items.length} Ù…ÙˆØ±Ø¯ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`, 'success');
          renderTable();
          renderDiscrepancyReports();
        } else {
          showSyncStatus('ğŸ“­ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª', 'info');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ:', error);
        showSyncStatus('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ', 'error');
      }
    }
    
    // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Apps Script
    async function saveToGoogleAppsScript() {
      if (!settings.scriptUrl) {
        return {success: false, error: 'URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡'};
      }
      
      showSyncStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...', 'info');
      
      try {
        const response = await fetch(settings.scriptUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'save',
            items: items
          })
        });
        
        if (!response.ok) {
          throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          showSyncStatus(`âœ… ${items.length} Ù…ÙˆØ±Ø¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`, 'success');
          return {success: true};
        } else {
          throw new Error(result.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡:', error);
        showSyncStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
        return {success: false, error: error.message};
      }
    }
    
    // ============ ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ ============
    
    function getNowFa() {
      return new Intl.DateTimeFormat('fa-IR', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      }).format(new Date()).replace(/ØŒ/g, ' ');
    }
    
    function calculateDiscrepancy2(stock, count2Str, discrepancy1) {
      if (parseFloat(discrepancy1) === 0) {
        const c2 = count2Str !== '' ? parseFloat(count2Str) : null;
        if (c2 === null || c2 === 0) return "0.00";
      }
      const c2 = count2Str !== '' ? parseFloat(count2Str) || 0 : 0;
      return (c2 - stock).toFixed(2);
    }
    
    function updateDiscrepancyAdd() {
      const stock = parseFloat(document.getElementById('addStock').value) || 0;
      const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
      const c2 = document.getElementById('addCount2').value;
      const disc1 = (c1 - stock).toFixed(2);
      document.getElementById('addDisc1').textContent = disc1;
      const disc2 = calculateDiscrepancy2(stock, c2, disc1);
      document.getElementById('addDisc2').textContent = disc2;
    }
    
    function updateDiscrepancyEdit() {
      const stock = parseFloat(document.getElementById('editStock').value) || 0;
      const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
      const c2 = document.getElementById('editCount2').value;
      const disc1 = (c1 - stock).toFixed(2);
      document.getElementById('editDisc1').textContent = disc1;
      const disc2 = calculateDiscrepancy2(stock, c2, disc1);
      document.getElementById('editDisc2').textContent = disc2;
    }
    
    // ============ ØªÙˆØ§Ø¨Ø¹ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ ============
    
    async function saveAdd() {
      const bc = document.getElementById('addBarcode').value.trim();
      const name = document.getElementById('addName').value.trim();
      const stock = parseFloat(document.getElementById('addStock').value) || 0;
      const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
      const c2Raw = document.getElementById('addCount2').value;
      const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;
      const disc1 = (c1 - stock).toFixed(2);
      const disc2 = calculateDiscrepancy2(stock, c2Raw, disc1);
      
      const newRow = [
        bc, name, c1, disc1, c2, disc2,
        document.getElementById('addTag').value.trim(),
        settings.teamName,
        document.getElementById('addLocation').value.trim(),
        stock,
        document.getElementById('addNotes').value.trim(),
        getNowFa(),
        settings.userName
      ];
      
      // Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
      const tempItems = [...items, newRow];
      
      // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡
      if (settings.scriptUrl) {
        const originalItems = [...items];
        items = tempItems; // Ù…ÙˆÙ‚ØªØ§Ù‹ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets
        const saveResult = await saveToGoogleAppsScript();
        
        if (saveResult.success) {
          // Ø§Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ Ø¯Ø± localStorage Ù‡Ù… Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
          localStorage.setItem('items', JSON.stringify(items));
          showSyncStatus('âœ… Ø¯Ø§Ø¯Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
          renderTable();
          renderDiscrepancyReports();
          closeAddModal();
          document.getElementById('searchInput').value = '';
        } else {
          // Ø§Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
          items = originalItems;
          showSyncStatus('âŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ - ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ù†Ø´Ø¯', 'error');
        }
      } else {
        // Ø§Ú¯Ø± Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ ÙÙ‚Ø· Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
        items = tempItems;
        localStorage.setItem('items', JSON.stringify(items));
        showSyncStatus('ğŸ“± Ø¯Ø§Ø¯Ù‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'info');
        renderTable();
        renderDiscrepancyReports();
        closeAddModal();
        document.getElementById('searchInput').value = '';
      }
    }
    
    async function saveEdit() {
      if (currentEditIndex < 0) return;
      
      const stock = parseFloat(document.getElementById('editStock').value) || 0;
      const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
      const c2Raw = document.getElementById('editCount2').value;
      const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;
      
      const updatedRow = [
        document.getElementById('editBarcode').value.trim(),
        document.getElementById('editName').value.trim(),
        c1,
        (c1 - stock).toFixed(2),
        c2,
        calculateDiscrepancy2(stock, c2Raw, (c1 - stock).toFixed(2)),
        document.getElementById('editTag').value.trim(),
        settings.teamName,
        document.getElementById('editLocation').value.trim(),
        stock,
        document.getElementById('editNotes').value.trim(),
        getNowFa(),
        settings.userName
      ];
      
      // Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
      const tempItems = [...items];
      tempItems[currentEditIndex] = updatedRow;
      
      // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡
      if (settings.scriptUrl) {
        const originalItems = [...items];
        items = tempItems; // Ù…ÙˆÙ‚ØªØ§Ù‹ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets
        const saveResult = await saveToGoogleAppsScript();
        
        if (saveResult.success) {
          // Ø§Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ Ø¯Ø± localStorage Ù‡Ù… Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
          localStorage.setItem('items', JSON.stringify(items));
          showSyncStatus('âœ… Ø¯Ø§Ø¯Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
          renderTable();
          renderDiscrepancyReports();
          closeEditModal();
          document.getElementById('searchInput').value = '';
        } else {
          // Ø§Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
          items = originalItems;
          showSyncStatus('âŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ - ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ù†Ø´Ø¯', 'error');
        }
      } else {
        // Ø§Ú¯Ø± Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ ÙÙ‚Ø· Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
        items = tempItems;
        localStorage.setItem('items', JSON.stringify(items));
        showSyncStatus('ğŸ“± Ø¯Ø§Ø¯Ù‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'info');
        renderTable();
        renderDiscrepancyReports();
        closeEditModal();
        document.getElementById('searchInput').value = '';
      }
    }
    
    async function removeItem(i) {
      if (!confirm('Ø§ÛŒÙ† Ø±Ø¯ÛŒÙ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
      
      // Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
      const tempItems = [...items];
      tempItems.splice(i, 1);
      
      // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡
      if (settings.scriptUrl) {
        const originalItems = [...items];
        items = tempItems; // Ù…ÙˆÙ‚ØªØ§Ù‹ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets
        const saveResult = await saveToGoogleAppsScript();
        
        if (saveResult.success) {
          // Ø§Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ Ø¯Ø± localStorage Ù‡Ù… Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
          localStorage.setItem('items', JSON.stringify(items));
          showSyncStatus('âœ… Ø¯Ø§Ø¯Ù‡ Ø­Ø°Ù Ø´Ø¯', 'success');
          renderTable();
          renderDiscrepancyReports();
        } else {
          // Ø§Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
          items = originalItems;
          showSyncStatus('âŒ Ø­Ø°Ù Ù†Ø§Ù…ÙˆÙÙ‚ - ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ù†Ø´Ø¯', 'error');
        }
      } else {
        // Ø§Ú¯Ø± Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ ÙÙ‚Ø· Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
        items = tempItems;
        localStorage.setItem('items', JSON.stringify(items));
        showSyncStatus('ğŸ“± Ø¯Ø§Ø¯Ù‡ Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ Ø­Ø°Ù Ø´Ø¯', 'info');
        renderTable();
        renderDiscrepancyReports();
      }
    }
    
    // ============ ØªÙˆØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ ============
    
    function renderTable() {
      document.getElementById('totalCount').textContent = items.length;
      items.sort((a, b) => {
        const dateA = a[11] ? parseFaDateTime(a[11]) : 0;
        const dateB = b[11] ? parseFaDateTime(b[11]) : 0;
        return dateB - dateA;
      });
      applyFilters();
    }
    
    function parseFaDateTime(faStr) {
      if (!faStr) return 0;
      const parts = faStr.split(' ');
      if (parts.length < 2) return Date.now();
      const time = parts[1];
      const [h, m, s] = time.split(':').map(x => parseInt(x) || 0);
      const d = new Date();
      d.setHours(h, m, s, 0);
      return d.getTime();
    }
    
    function applyFilters() {
      const global = document.getElementById('globalSearch').value.toLowerCase();
      const colFilters = Array.from(document.querySelectorAll('.filter-input')).map(el => el.value.toLowerCase());
      
      const filtered = items.filter(row => {
        const matchesGlobal = !global || row.some(cell => String(cell).toLowerCase().includes(global));
        const matchesCols = colFilters.every((f, i) => {
          if (!f) return true;
          const cell = row[i] != null ? String(row[i]).toLowerCase() : '';
          return cell.includes(f);
        });
        return matchesGlobal && matchesCols;
      });
      
      renderTableBody(filtered);
    }
    
    function renderTableBody(data) {
      const t = document.getElementById('tableBody');
      if (data.length === 0) {
        t.innerHTML = '<tr><td colspan="14" style="text-align:center;">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>';
        return;
      }
      
      t.innerHTML = data.map((r, i) => {
        return `<tr>
          <td>${r[0]}</td>
          <td>${r[1]}</td>
          <td>${r[2]}</td>
          <td class="discrepancy">${r[3]}</td>
          <td>${r[4]}</td>
          <td class="discrepancy">${r[5]}</td>
          <td>${r[6]}</td>
          <td>${r[7]}</td>
          <td>${r[8]}</td>
          <td>${parseFloat(r[9]).toLocaleString('fa-IR')}</td>
          <td>${r[10]}</td>
          <td>${r[11]}</td>
          <td>${r[12]}</td>
          <td class="actions">
            <button class="btn-icon" style="background:#1976d2;" onclick="openEditModal(${i})">âœï¸</button>
            <button class="btn-icon danger" onclick="removeItem(${i})">ğŸ—‘ï¸</button>
          </td>
        </tr>`;
      }).join('');
    }
    
    function renderFilterRow() {
      const headers = Array(13).fill('').map((_,i) => 
        `<th><input type="text" class="filter-input" data-col="${i}" placeholder="ÙÛŒÙ„ØªØ±..." oninput="applyFilters()"></th>`
      );
      document.getElementById('filterRow').innerHTML = headers.join('') + '<th></th>';
    }
    
    function renderDiscrepancyReports() {
      const disc1List = document.getElementById('discrepancy1List');
      const disc2List = document.getElementById('discrepancy2List');
      const disc1Items = items.filter(r => Math.abs(parseFloat(r[3])) > 0.001);
      const disc2Items = items.filter(r => Math.abs(parseFloat(r[5])) > 0.001);
      
      function buildDiscrepancyTable(data) {
        if (data.length === 0) return '<p style="text-align:center; color:#666;">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
        return `
          <table class="table" style="font-size:12px;">
            <thead><tr><th>Ø¨Ø§Ø±Ú©Ø¯</th><th>Ù†Ø§Ù…</th><th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th><th>Ø´Ù…Ø§Ø±Ø´</th><th>Ù…ØºØ§ÛŒØ±Øª</th><th>ØªÚ¯</th><th>Ù…Ø­Ù„</th></tr></thead>
            <tbody>
              ${data.map(r => `<tr>
                <td>${r[0]}</td>
                <td>${r[1]}</td>
                <td>${r[9]}</td>
                <td>${r[2] || r[4]}</td>
                <td class="discrepancy">${r[3] || r[5]}</td>
                <td>${r[6]}</td>
                <td>${r[8]}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        `;
      }
      disc1List.innerHTML = buildDiscrepancyTable(disc1Items);
      disc2List.innerHTML = buildDiscrepancyTable(disc2Items);
    }
    
    function exportDiscrepancies() {
      const disc1 = items.filter(r => Math.abs(parseFloat(r[3])) > 0.001);
      const disc2 = items.filter(r => Math.abs(parseFloat(r[5])) > 0.001);
      const wsData = [
        ['--- Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´ Û± ---'],
        ['Ø¨Ø§Ø±Ú©Ø¯','Ù†Ø§Ù… Ú©Ø§Ù„Ø§','Ù…ÙˆØ¬ÙˆØ¯ÛŒ','Ø´Ù…Ø§Ø±Ø´Û±','Ù…ØºØ§ÛŒØ±ØªÛ±','ØªÚ¯','Ù…Ø­Ù„'],
        ...disc1.map(r => [r[0], r[1], r[9], r[2], r[3], r[6], r[8]]),
        [],
        ['--- Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´ Û² ---'],
        ['Ø¨Ø§Ø±Ú©Ø¯','Ù†Ø§Ù… Ú©Ø§Ù„Ø§','Ù…ÙˆØ¬ÙˆØ¯ÛŒ','Ø´Ù…Ø§Ø±Ø´Û²','Ù…ØºØ§ÛŒØ±ØªÛ²','ØªÚ¯','Ù…Ø­Ù„'],
        ...disc2.map(r => [r[0], r[1], r[9], r[4], r[5], r[6], r[8]])
      ];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§');
      XLSX.writeFile(wb, 'Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ÛŒ_Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ.xlsx');
    }
    
    function exportExcel() {
      if (items.length === 0) return alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
      const headers = ['Ø¨Ø§Ø±Ú©Ø¯','Ù†Ø§Ù… Ú©Ø§Ù„Ø§','Ø´Ù…Ø§Ø±Ø´Û±','Ù…ØºØ§ÛŒØ±ØªÛ±','Ø´Ù…Ø§Ø±Ø´Û²','Ù…ØºØ§ÛŒØ±ØªÛ²','ØªÚ¯','ØªÛŒÙ…','Ù…Ø­Ù„','Ù…ÙˆØ¬ÙˆØ¯ÛŒ','ØªÙˆØ¶ÛŒØ­Ø§Øª','Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ','Ú©Ø§Ø±Ø¨Ø±'];
      const wsData = [headers, ...items.map(r => r.slice(0,13))];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù†Ø¨Ø§Ø±');
      XLSX.writeFile(wb, 'Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ_Ø®Ø±ÙˆØ¬ÛŒ.xlsx');
    }
    
    async function importExcel() {
      const file = document.getElementById('excelFile').files[0];
      if (!file) return alert('ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
          
          if (json.length < 2) return alert('ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.');
          
          const importedItems = [];
          for (let i = 1; i < json.length; i++) {
            const row = json[i];
            const bc = String(row[0] || '').trim();
            if (!bc) continue;
            
            const stock = parseFloat(row[9]) || 0;
            const c1 = parseFloat(row[2]) || 0;
            const c2 = parseFloat(row[4]) || 0;
            const disc1 = (c1 - stock).toFixed(2);
            const disc2 = (c2 - stock).toFixed(2);
            
            importedItems.push([
              bc,
              row[1] || '',
              c1,
              disc1,
              c2,
              disc2,
              row[6] || '',
              row[7] || '',
              row[8] || '',
              stock,
              row[10] || '',
              getNowFa(),
              row[12] || ''
            ]);
          }
          
          // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡
          if (settings.scriptUrl) {
            const originalItems = [...items];
            items = importedItems; // Ù…ÙˆÙ‚ØªØ§Ù‹ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets
            const saveResult = await saveToGoogleAppsScript();
            
            if (saveResult.success) {
              // Ø§Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ Ø¯Ø± localStorage Ù‡Ù… Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
              localStorage.setItem('items', JSON.stringify(items));
              showSyncStatus(`âœ… ${items.length} Ù…ÙˆØ±Ø¯ import Ø´Ø¯`, 'success');
              renderTable();
              renderDiscrepancyReports();
              alert(`âœ… ${items.length} Ù…ÙˆØ±Ø¯ import Ø´Ø¯.`);
            } else {
              // Ø§Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
              items = originalItems;
              showSyncStatus('âŒ import Ù†Ø§Ù…ÙˆÙÙ‚', 'error');
              alert('âŒ import Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯. Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ØªØºÛŒÛŒØ± Ù†Ú©Ø±Ø¯Ù†Ø¯.');
            }
          } else {
            // Ø§Ú¯Ø± Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ ÙÙ‚Ø· Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
            items = importedItems;
            localStorage.setItem('items', JSON.stringify(items));
            showSyncStatus(`ğŸ“± ${items.length} Ù…ÙˆØ±Ø¯ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ import Ø´Ø¯`, 'info');
            renderTable();
            renderDiscrepancyReports();
            alert(`âœ… ${items.length} Ù…ÙˆØ±Ø¯ import Ø´Ø¯.`);
          }
          
        } catch (err) {
          alert('Ø®Ø·Ø§ Ø¯Ø± import: ' + (err.message || 'Ù†Ø§Ù…Ø´Ø®Øµ'));
        }
      };
      reader.readAsArrayBuffer(file);
    }
    
    async function clearAll() {
      if (confirm('âš ï¸ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ')) {
        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡
        if (settings.scriptUrl) {
          const originalItems = [...items];
          items = []; // Ù…ÙˆÙ‚ØªØ§Ù‹ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets
          const saveResult = await saveToGoogleAppsScript();
          
          if (saveResult.success) {
            // Ø§Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ Ø¯Ø± localStorage Ù‡Ù… Ù¾Ø§Ú© Ú©Ù†
            localStorage.removeItem('items');
            showSyncStatus('âœ… ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯', 'success');
            renderTable();
            renderDiscrepancyReports();
            alert('âœ… ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.');
          } else {
            // Ø§Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
            items = originalItems;
            showSyncStatus('âŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†Ø§Ù…ÙˆÙÙ‚', 'error');
            alert('âŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯. Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ØªØºÛŒÛŒØ± Ù†Ú©Ø±Ø¯Ù†Ø¯.');
          }
        } else {
          // Ø§Ú¯Ø± Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ ÙÙ‚Ø· Ø§Ø² localStorage Ù¾Ø§Ú© Ú©Ù†
          items = [];
          localStorage.removeItem('items');
          showSyncStatus('ğŸ“± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯', 'info');
          renderTable();
          renderDiscrepancyReports();
          alert('âœ… ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.');
        }
      }
    }
    
    // ============ ØªÙˆØ§Ø¨Ø¹ UI ============
    
    function searchOrAdd() {
      const query = document.getElementById('searchInput').value.trim();
      const loc = settings.defaultLocation;
      if (!query) return alert('Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
      
      if (settings.searchByTag) {
        const idx = items.findIndex(r => r[6] === query && r[8] === loc);
        if (idx !== -1) {
          openEditModal(idx);
        } else {
          alert('âš ï¸ Ø¯Ø± Ø­Ø§Ù„Øª Â«Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÚ¯Â»ØŒ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª. Ú©Ø§Ù„Ø§ÛŒÛŒ Ø¨Ø§ Ø§ÛŒÙ† ØªÚ¯ ÛŒØ§ÙØª Ù†Ø´Ø¯.');
          return;
        }
      } else {
        if (query.length < settings.minLength || query.length > settings.maxLength) {
          alert(`âŒ Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯ (${query.length}) Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ (${settings.minLength}â€“${settings.maxLength}) Ø§Ø³Øª.`);
          return;
        }
        const idx = items.findIndex(r => r[0] === query && r[8] === loc);
        if (idx !== -1) openEditModal(idx);
        else openAddModal(query, loc);
      }
    }
    
    function openAddModal(bc, loc, tag = '') {
      const existing = items.find(r => r[0] === bc);
      const stock = existing ? parseFloat(existing[9]) || 0 : 0;
      document.getElementById('addBarcode').value = bc;
      document.getElementById('addLocation').value = loc;
      document.getElementById('addStock').value = stock;
      document.getElementById('addCount1').value = stock;
      document.getElementById('addCount2').value = '';
      document.getElementById('addTag').value = tag;
      document.getElementById('addTeam').value = settings.teamName;
      document.getElementById('addNotes').value = '';
      updateDiscrepancyAdd();
      document.getElementById('addModal').classList.remove('hidden');
    }
    
    function openEditModal(idx) {
      currentEditIndex = idx;
      const r = items[idx];
      document.getElementById('editBarcode').value = r[0];
      document.getElementById('editName').value = r[1] || '';
      document.getElementById('editStock').value = r[9] || 0;
      document.getElementById('editCount1').value = r[2] || '';
      document.getElementById('editCount2').value = r[4] != null ? r[4] : '';
      document.getElementById('editTag').value = r[6] || '';
      document.getElementById('editTeam').value = settings.teamName;
      document.getElementById('editLocation').value = r[8] || '';
      document.getElementById('editNotes').value = r[10] || '';
      updateDiscrepancyEdit();
      document.getElementById('editModal').classList.remove('hidden');
    }
    
    function closeAddModal() { document.getElementById('addModal').classList.add('hidden'); }
    function closeEditModal() { 
      document.getElementById('editModal').classList.add('hidden');
      currentEditIndex = -1; 
    }
    
    // ============ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ============
    
    document.addEventListener('DOMContentLoaded', () => {
      // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
      document.getElementById('settingUserName').value = settings.userName;
      document.getElementById('settingTeamName').value = settings.teamName;
      document.getElementById('settingDefaultLocation').value = settings.defaultLocation;
      document.getElementById('settingMinLength').value = settings.minLength;
      document.getElementById('settingMaxLength').value = settings.maxLength;
      document.getElementById('searchByTag').checked = settings.searchByTag;
      document.getElementById('scriptUrl').value = settings.scriptUrl || '';
      
      document.getElementById('globalLocationDisplay').textContent = settings.defaultLocation;
      
      // ØªÙ†Ø¸ÛŒÙ… ØªØ¨â€ŒÙ‡Ø§
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
          if (btn.dataset.tab === 'reports') renderDiscrepancyReports();
        });
      });
      
      // Ø¢Ù¾Ø¯ÛŒØª UI Ø¬Ø³ØªØ¬Ùˆ
      document.getElementById('searchByTag').addEventListener('change', function() {
        settings.searchByTag = this.checked;
        updateSearchUI();
      });
      updateSearchUI();
      
      // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
      if (items.length > 0) {
        renderTable();
        renderDiscrepancyReports();
      }
      
      // Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø² Ø¢Ù†Ø¬Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†
      if (settings.scriptUrl) {
        setTimeout(() => loadFromGoogleAppsScript(), 1000);
      }
      
      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø¨Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§
      ['addCount1','addCount2','editCount1','editCount2'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          const wrap = document.createElement('div');
          wrap.style.position = 'relative';
          el.parentNode.insertBefore(wrap, el);
          wrap.appendChild(el);
          const btn = document.createElement('button');
          btn.innerHTML = 'ğŸ§®';
          btn.style.cssText = 
            'position:absolute;left:12px;top:50%;transform:translateY(-50%);' +
            'background:#e0e0e0;border:none;width:40px;height:40px;' +
            'border-radius:10px;cursor:pointer;font-size:20px;font-weight:bold;';
          btn.onclick = () => openCalc(id);
          wrap.appendChild(btn);
          el.style.paddingLeft = '60px';
        }
      });
      
      // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ URL
      const params = new URLSearchParams(window.location.search);
      const bc = params.get('SCAN_RESULT')?.trim() || params.get('barcode')?.trim();
      if (bc && !settings.searchByTag) {
        document.getElementById('searchInput').value = bc;
        setTimeout(searchOrAdd, 150);
      }
      
      // Ø±Ù†Ø¯Ø± Ø§ÙˆÙ„ÛŒÙ‡
      renderFilterRow();
    });
    
    function saveSettings() {
      const user = document.getElementById('settingUserName').value.trim() || 'Ú©Ø§Ø±Ø¨Ø±';
      const team = document.getElementById('settingTeamName').value.trim();
      let loc = document.getElementById('settingDefaultLocation').value.trim();
      if (!loc) loc = 'Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ';
      const min = parseInt(document.getElementById('settingMinLength').value) || 14;
      const max = parseInt(document.getElementById('settingMaxLength').value) || 20;
      const searchByTag = document.getElementById('searchByTag').checked;
      const scriptUrl = document.getElementById('scriptUrl').value.trim();
      
      if (min > max) return alert('âš ï¸ Ø­Ø¯Ø§Ù‚Ù„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø­Ø¯Ø§Ú©Ø«Ø± Ø¨Ø§Ø´Ø¯.');
      
      settings = { 
        userName: user, 
        teamName: team, 
        defaultLocation: loc, 
        minLength: min, 
        maxLength: max, 
        searchByTag,
        scriptUrl
      };
      
      localStorage.setItem('appSettings', JSON.stringify(settings));
      document.getElementById('globalLocationDisplay').textContent = loc;
      updateSearchUI();
      alert('âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
    }
    
    function updateSearchUI() {
      const searchByTag = settings.searchByTag;
      const input = document.getElementById('searchInput');
      const scanContainer = document.getElementById('scanButtonContainer');
      if (searchByTag) {
        input.placeholder = "ØªÚ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: T-001)";
        scanContainer.style.display = 'none';
      } else {
        input.placeholder = "Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯";
        scanContainer.style.display = 'flex';
      }
    }
    
    function openCalc(id) { 
      CURRENT_CALC_TARGET = id; 
      document.getElementById('calcDisplay').value = ''; 
      document.getElementById('calcModal').classList.remove('hidden'); 
    }
    function calcAppend(c) { document.getElementById('calcDisplay').value += c; }
    function calcBackspace() { const e = document.getElementById('calcDisplay'); e.value = e.value.slice(0, -1); }
    function calcClear() { document.getElementById('calcDisplay').value = ''; }
    function calcApply() {
      const expr = document.getElementById('calcDisplay').value;
      if (!expr.trim()) return alert('Ø¹Ø¨Ø§Ø±ØªÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
      const safe = expr.replace(/[^0-9+\-*/().\sÃ·Ã—]/g, '').replace(/Ã·/g, '/').replace(/Ã—/g, '*');
      try {
        const r = new Function('return (' + safe + ')')();
        if (isNaN(r) || !isFinite(r)) throw '';
        const t = document.getElementById(CURRENT_CALC_TARGET);
        t.value = parseFloat(r).toFixed(2);
        if (CURRENT_CALC_TARGET.startsWith('add')) updateDiscrepancyAdd();
        else if (CURRENT_CALC_TARGET.startsWith('edit')) updateDiscrepancyEdit();
        closeCalcModal();
      } catch (e) { alert('Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.'); }
    }
    function closeCalcModal() { 
      document.getElementById('calcModal').classList.add('hidden'); 
      CURRENT_CALC_TARGET = null; 
    }
    
    // ØªÙˆØ§Ø¨Ø¹ Ù…ÙˆÙ‚Ø¹ÛŒØª
    function getLocations() {
      const set = new Set();
      items.forEach(r => { const loc = (r[8] || '').trim(); if (loc) set.add(loc); });
      if (settings.defaultLocation) set.add(settings.defaultLocation);
      return Array.from(set).sort();
    }
    
    function renderDropdown(id, locations) {
      const el = document.getElementById(id);
      if (!el) return;
      el.innerHTML = locations.length 
        ? locations.map(l => `<div class="custom-select-option" onclick="selectLocation('${l.replace(/'/g,"\\'")}','${id}')">${l}</div>`).join('')
        : '<div class="custom-select-option" style="color:#999;">Ù…Ø­Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
    }
    
    function toggleLocationDropdown(context) {
      hideAllDropdowns();
      const map = {
        main: { dropdown: 'locationDropdown', input: 'globalLocation' },
        add:  { dropdown: 'addLocationDropdown', input: 'addLocation' },
        edit: { dropdown: 'editLocationDropdown', input: 'editLocation' },
        settings: { dropdown: 'settingsLocationDropdown', input: 'settingDefaultLocation' }
      };
      const conf = map[context];
      if (!conf) return;
      const { dropdown, input } = conf;
      const el = document.getElementById(dropdown);
      const inp = document.getElementById(input);
      if (el && el.classList.contains('hidden')) {
        renderDropdown(dropdown, getLocations());
        el.classList.remove('hidden');
        currentDropdown = context;
        if (inp && !inp.hasBlurListener) {
          inp.addEventListener('blur', function() {
            setTimeout(hideAllDropdowns, 150);
          });
          inp.hasBlurListener = true;
        }
        inp.focus();
      }
    }
    
    function hideAllDropdowns() {
      ['locationDropdown','addLocationDropdown','editLocationDropdown','settingsLocationDropdown'].forEach(id=>{
        const e=document.getElementById(id); if(e) e.classList.add('hidden');
      });
      currentDropdown = null;
    }
    
    function selectLocation(loc, dropdownId) {
      const map = {
        'locationDropdown': 'globalLocation',
        'addLocationDropdown': 'addLocation',
        'editLocationDropdown': 'editLocation',
        'settingsLocationDropdown': 'settingDefaultLocation'
      };
      const inputId = map[dropdownId] || dropdownId.replace('Dropdown', '');
      document.getElementById(inputId).value = loc;
      hideAllDropdowns();
    }
    
    // ØªÙˆØ§Ø¨Ø¹ Ø§Ø³Ú©Ù†Ø±
    const SCANNERS = [
      { id: 'camera', name: 'ğŸ“¸ Ø§Ø³Ú©Ù† Ø¨Ø§ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø§Ø®Ù„ÛŒ' },
      { id: 'gamma', name: 'Gamma Barcode Scanner',
        intent: 'intent://scan/#Intent;scheme=scan;package=com.gamma.scan;end;' },
      { id: 'zxing', name: 'ZXing Barcode Scanner',
        intent: 'intent://scan/#Intent;scheme=zxing;package=com.google.zxing.client.android;end;' },
      { id: 'easy', name: 'Easy Barcode Scanner',
        intent: 'intent://scan/#Intent;scheme=scan;package=com.tecace.easybarcodescanner;end;' }
    ];
    
    function changeScanner() {
      let msg = 'Ø±ÙˆØ´ Ø§Ø³Ú©Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\n';
      SCANNERS.forEach((s, i) => msg += `${i+1}. ${s.name}\n`);
      msg += '\nØ´Ù…Ø§Ø±Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: 1):';
      const choice = prompt(msg, '1');
      const idx = Math.max(0, parseInt(choice) - 1);
      const sel = SCANNERS[idx] || SCANNERS[0];
      LAST_SCAN_METHOD = sel.id;
      localStorage.setItem('scanner', sel.id);
      alert(`âœ… Ø§Ø³Ú©Ù†Ø±: ${sel.name}`);
    }
    
    function launchExternalScanner(id) {
      const s = SCANNERS.find(x => x.id === id);
      if (s && s.intent) {
        const w = window.open(s.intent, '_self');
        if (!w) alert(`âŒ Â«${s.name}Â» Ù†ØµØ¨ Ù†ÛŒØ³Øª. Ø§Ø² Ø§Ø³Ú©Ù† Ø¯Ø§Ø®Ù„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.`);
      }
    }
    
    function startScan() {
      if (settings.searchByTag) {
        alert('âš ï¸ Ø¯Ø± Ø­Ø§Ù„Øª Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÚ¯ØŒ Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª.');
        return;
      }
      if (LAST_SCAN_METHOD === 'camera') {
        startCameraScan();
      } else {
        launchExternalScanner(LAST_SCAN_METHOD);
      }
    }
    
    async function applyZoom(level) {
      zoomLevel = Math.max(1.0, Math.min(3.0, level));
      document.getElementById('hintZoom').textContent = `ğŸ” Ø²ÙˆÙ…: Ã—${zoomLevel.toFixed(1)}`;
      if (!videoStream) return;
      const track = videoStream.getVideoTracks()[0];
      if (track && track.applyConstraints) {
        try { await track.applyConstraints({ advanced: [{ zoom: zoomLevel }] }); } catch (e) {}
      }
    }
    function zoomIn() { applyZoom(zoomLevel + 0.3); }
    function zoomOut() { applyZoom(zoomLevel - 0.3); }
    function resetZoom() { applyZoom(1.0); }
    
    async function startCameraScan() {
      if (!("BarcodeDetector" in window)) {
        alert("âŒ Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Ø§Ø³Ú©Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø§Ø² Chrome Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.");
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } }
        });
        videoStream = stream;
        const video = document.getElementById('cameraVideo');
        video.srcObject = stream;
        barcodeDetector = new BarcodeDetector({ formats: ['qr_code','ean_13','code_128','code_39'] });
        document.getElementById('cameraModal').classList.remove('hidden');
        video.play();
        applyZoom(1.0);
        scanInterval = setInterval(async () => {
          if (!barcodeDetector || !video.srcObject || video.paused) return;
          try {
            const barcodes = await barcodeDetector.detect(video);
            if (barcodes.length === 0) {
              stableScanCount = 0;
              return;
            }
            const b = barcodes[0];
            const value = (b.rawValue || '').trim();
            if (!value || value.length < settings.minLength || value.length > settings.maxLength) {
              stableScanCount = 0;
              return;
            }
            
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            const box = b.boundingBox || {};
            const x = box.x || 0, y = box.y || 0, w = box.width || 0, h = box.height || 0;
            
            const centerX = x + w/2;
            const centerY = y + h/2;
            const inVerticalZone = centerY > vh * 0.3 && centerY < vh * 0.7;
            const inHorizontalZone = Math.abs(centerX - vw/2) < vw * 0.2;
            const minWidth = vw * 0.2;
            
            if (!inVerticalZone || !inHorizontalZone || w < minWidth) {
              stableScanCount = 0;
              return;
            }
            
            if (value === lastScannedValue) {
              stableScanCount++;
            } else {
              lastScannedValue = value;
              stableScanCount = 1;
            }
            
            if (stableScanCount >= 2) {
              clearInterval(scanInterval);
              scanInterval = null;
              stopCamera();
              document.getElementById('searchInput').value = value;
              setTimeout(searchOrAdd, 150);
            }
          } catch (e) {}
        }, 200);
      } catch (err) {
        alert("âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø¯ Ø´Ø¯.");
      }
    }
    
    function stopCamera() {
      const modal = document.getElementById('cameraModal');
      modal.classList.add('hidden');
      if (scanInterval) clearInterval(scanInterval);
      if (videoStream) videoStream.getTracks().forEach(t => t.stop());
      videoStream = null;
      barcodeDetector = null;
      const v = document.getElementById('cameraVideo');
      if (v.srcObject) v.srcObject.getTracks().forEach(t => t.stop());
      v.srcObject = null;
      lastScannedValue = '';
      stableScanCount = 0;
    }
    
    console.log('âœ… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø¨Ø§ Google Apps Script Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª');
  </script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</body>
</html>
