<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Vazir', 'IRANSans', Tahoma, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    body { background: #f9fafb; padding: 12px; }
    .card { background: white; border-radius: 12px; padding: 16px; margin: 12px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    input, select, textarea, button {
      width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ccc;
      border-radius: 8px; font-size: 16px; text-align: right;
    }
    input[readonly] { background-color: #f5f5f5; }
    input[type="number"] { direction: ltr; text-align: right; }
    input[type="url"] { direction: ltr; text-align: left; }
    button { background: #2e7d32; color: white; border: none; font-weight: bold; cursor: pointer; }
    button.scan { background: #1976d2; }
    button.secondary { background: #757575; }
    button.danger { background: #c62828; }
    .hidden { display: none; }
    .discrepancy { font-weight: bold; color: #c62828; }
    h2, h3 { text-align: center; color: #2e7d32; margin-bottom: 12px; }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; }
    .toolbar > * { flex: 1; min-width: 160px; }
    .tabs { display: flex; gap: 6px; margin-bottom: 16px; }
    .tab-btn {
      flex: 1;
      padding: 10px 8px;
      background: #e9ecef;
      border: none;
      border-radius: 8px 8px 0 0;
      font-weight: bold;
      cursor: pointer;
      font-size: 15px;
    }
    .tab-btn.active { background: #2e7d32; color: white; }
    .tab-content { display: none; padding-top: 16px; border-top: 2px solid #2e7d32; }
    .tab-content.active { display: block; }
    .modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 95%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .modal.hidden { display: none; }
    .custom-select-container {
      position: relative;
      width: 100%;
    }
    .custom-select-container input {
      padding-right: 36px;
    }
    .select-arrow {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: auto;
      cursor: pointer;
      color: #757575;
      font-size: 14px;
    }
    .custom-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #aaa;
      border-top: none;
      border-radius: 0 0 8px 8px;
      z-index: 10;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .custom-select-dropdown.hidden { display: none; }
    .custom-select-option {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }
    .custom-select-option:hover { background: #f0f8f0; }
    .custom-select-option:last-child { border-bottom: none; }
    #cameraVideo {
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      background: #000;
      display: block;
    }
    .scanner-frame {
      position: absolute;
      top: 25%;
      left: 10%;
      width: 80%;
      height: 50%;
      border: 3px solid #2196f3;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.6);
      pointer-events: none;
      border-radius: 4px;
    }
    .scan-hint {
      position: absolute;
      top: 8%;
      left: 0;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 16px;
      text-shadow: 0 1px 4px #000;
      padding: 0 20px;
      pointer-events: none;
    }
    .zoom-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 100;
    }
    .zoom-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255,255,255,0.85);
      border: none;
      font-size: 24px;
      font-weight: bold;
      color: #1976d2;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
      cursor: pointer;
    }
    .calc-btn { 
      background: #e0e0e0; 
      color: #333; 
      padding: 16px 0;
      margin: 4px;
      font-size: 22px;
      font-weight: bold;
      border-radius: 12px;
      border: 1px solid #bbb;
      width: 22%;
      height: 56px;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    .calc-display {
      width: 100%;
      padding: 16px;
      margin: 8px 0;
      text-align: left;
      direction: ltr;
      font-size: 22px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .calc-apply {
      background: #2e7d32 !important;
      width: 100% !important;
      padding: 18px !important;
      margin-top: 14px;
      font-size: 20px;
      border-radius: 10px;
    }
    .location-display {
      width: 100%; padding: 12px; background: #f5f5f5; border-radius: 8px;
      font-weight: bold; color: #2e7d32; text-align: center; border: 1px solid #ddd;
    }
    .status-box {
      padding: 10px; margin-top: 8px; border-radius: 6px; text-align: center;
      font-weight: bold;
    }
    .status-ok { background: #e8f5e9; color: #2e7d32; }
    .status-warn { background: #fff8e1; color: #e65100; }
    .status-error { background: #ffebee; color: #c62828; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Ø§Ù†Ø¨Ø§Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³Ù„Ø·Ø§Ù†</h2>
    <div class="tabs" id="tabsContainer">
      <button class="tab-btn active" data-tab="main">Ø¹Ù…Ù„ÛŒØ§Øª</button>
      <button class="tab-btn" data-tab="settings">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </div>
    <div class="tab-content active" id="tab-main">
      <div id="scanButtonContainer" class="toolbar">
        <button onclick="startScan()" class="scan">ğŸ“¸ Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯</button>
        <div>
          <label>ğŸ“ Ù…Ø­Ù„:</label>
          <div class="location-display" id="globalLocationDisplay">Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ</div>
        </div>
      </div>
      <input type="text" id="searchInput" placeholder="Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" autofocus />
      <button onclick="searchOrAdd()">ğŸ” Ø¬Ø³ØªØ¬Ùˆ / Ø§ÙØ²ÙˆØ¯Ù†</button>
    </div>
    <div class="tab-content" id="tab-settings">
      <h3>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</h3>
      <label>ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±:</label>
      <input type="text" id="settingUserName" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§" />
      <label>ğŸ‘¥ Ù†Ø§Ù… ØªÛŒÙ… (Ù¾ÛŒØ´â€ŒÙØ±Ø¶):</label>
      <input type="text" id="settingTeamName" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÛŒÙ… Ø§Ù„Ù" />
      <label>ğŸ“ Ù…Ø­Ù„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª):</label>
      <div class="custom-select-container">
        <input type="text" id="settingDefaultLocation" placeholder="Ù…Ø­Ù„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" autocomplete="off" />
        <div class="custom-select-dropdown hidden" id="settingsLocationDropdown"></div>
        <span class="select-arrow" onclick="toggleLocationDropdown('settings')">â–¼</span>
      </div>
      <label>ğŸ”¢ Ø­Ø¯Ø§Ù‚Ù„ Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="number" id="settingMinLength" min="4" max="50" value="14" />
      <label>ğŸ”¢ Ø­Ø¯Ø§Ú©Ø«Ø± Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="number" id="settingMaxLength" min="4" max="50" value="20" />
      <label class="secondary" style="margin-top:16px;">
        <input type="checkbox" id="searchByTag" /> 
        ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÚ¯ (Ø¨Ù‡â€ŒØ¬Ø§ÛŒ Ø¨Ø§Ø±Ú©Ø¯)
      </label>
      <p style="font-size:13px; color:#555; margin-top:4px;">
        Ø¯Ø± Ø§ÛŒÙ† Ø­Ø§Ù„ØªØŒ ÙÛŒÙ„Ø¯ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ù‡ Â«ØªÚ¯Â» ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø¯Ú©Ù…Ù‡ Ø§Ø³Ú©Ù† Ù¾Ù†Ù‡Ø§Ù† Ù…ÛŒâ€ŒØ´ÙˆØ¯.
      </p>
      <h4 style="margin:20px 0 8px;">ğŸ”— Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª</h4>
      <label>URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§Ø¬Ø±Ø§ (/exec):</label>
      <input type="url" id="settingScriptUrl" placeholder="https://script.google.com/macros/s/.../exec" />
      <button onclick="testScriptConnection()" style="width:100%; margin-top:6px; background:#1976d2;">ğŸ“¡ ØªØ³Øª Ø§Ø±ØªØ¨Ø§Ø·</button>
      <div id="scriptStatus" class="status-box status-warn">ÙˆØ¶Ø¹ÛŒØª: ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡</div>
      <h4 style="margin:20px 0 8px;">ğŸ”„ ØªØºÛŒÛŒØ± Ø±ÙˆØ´ Ø§Ø³Ú©Ù†</h4>
      <button onclick="changeScanner()" class="secondary" style="width:100%;">ğŸ”„ ØªØºÛŒÛŒØ± Ø§Ø³Ú©Ù†Ø±</button>
      <p style="font-size:13px; margin-top:6px; color:#555;">
        âœ… Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: <strong>Gamma Scanner</strong> â€” Ø³Ø±ÛŒØ¹ØŒ Ø¨Ø¯ÙˆÙ† ØªØ¨Ù„ÛŒØºØŒ Batch ScanØŒ ZoomØŒ Flash.
      </p>
      <button onclick="saveSettings()" style="margin-top:20px; width:100%;">âœ… Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </div>
  </div>

  <!-- Modals -->
  <div id="cameraModal" class="modal hidden">
    <div style="position:relative; width:100vw; height:100vh;">
      <video id="cameraVideo" playsinline></video>
      <div class="scanner-frame"></div>
      <div class="scan-hint" id="scanHint">
        ğŸ” Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¯Ø± Ú†Ù‡Ø§Ø±Ú†ÙˆØ¨ Ø¢Ø¨ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.<br>
        <span id="hintZoom">ğŸ” Ø²ÙˆÙ…: Ã—1.0</span>
      </div>
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomOut()">â€“</button>
        <button class="zoom-btn" onclick="resetZoom()">â†º</button>
        <button class="zoom-btn" onclick="zoomIn()">+</button>
      </div>
    </div>
    <div style="padding:16px; text-align:center;">
      <button onclick="stopCamera()" class="danger" style="width:auto; padding:12px 24px; font-size:16px;">â¹ï¸ ØªÙˆÙ‚Ù Ø§Ø³Ú©Ù†</button>
    </div>
  </div>

  <div id="addModal" class="modal hidden">
    <div class="modal-content">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
      <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="text" id="addBarcode" readonly />
      <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
      <input type="text" id="addName" />
      <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
      <input type="number" id="addStock" step="0.01" readonly />
      <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
      <input type="number" id="addCount1" step="0.01" inputmode="numeric" pattern="[0-9.]*" oninput="updateDiscrepancyAdd()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="addDisc1" class="discrepancy">â€”</span></div>
      <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
      <input type="number" id="addCount2" step="0.01" inputmode="numeric" pattern="[0-9.]*" oninput="updateDiscrepancyAdd()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="addDisc2" class="discrepancy">â€”</span></div>
      <label>ØªÚ¯:</label>
      <input type="number" id="addTag" />
      <label>ØªÛŒÙ…:</label>
      <input type="text" id="addTeam" readonly />
      <label>Ù…Ø­Ù„:</label>
      <div class="custom-select-container">
        <input type="text" id="addLocation" autocomplete="off" />
        <div class="custom-select-dropdown hidden" id="addLocationDropdown"></div>
        <span class="select-arrow" onclick="toggleLocationDropdown('add')">â–¼</span>
      </div>
      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea id="addNotes" rows="2"></textarea>
      <div style="display:flex; gap:8px; margin-top:16px;">
        <button onclick="saveAdd()" style="flex:1;">âœ… Ø§ÙØ²ÙˆØ¯Ù†</button>
        <button onclick="closeAddModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
      </div>
    </div>
  </div>

  <div id="editModal" class="modal hidden">
    <div class="modal-content">
      <h3>ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù„Ø§</h3>
      <label>Ø¨Ø§Ø±Ú©Ø¯:</label>
      <input type="text" id="editBarcode" readonly />
      <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§:</label>
      <input type="text" id="editName" />
      <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:</label>
      <input type="number" id="editStock" step="0.01" readonly />
      <label>Ø´Ù…Ø§Ø±Ø´ Û±:</label>
      <input type="number" id="editCount1" step="0.01" inputmode="numeric" pattern="[0-9.]*" oninput="updateDiscrepancyEdit()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ±: <span id="editDisc1" class="discrepancy">â€”</span></div>
      <label>Ø´Ù…Ø§Ø±Ø´ Û²:</label>
      <input type="number" id="editCount2" step="0.01" inputmode="numeric" pattern="[0-9.]*" oninput="updateDiscrepancyEdit()" />
      <div>Ù…ØºØ§ÛŒØ±ØªÛ²: <span id="editDisc2" class="discrepancy">â€”</span></div>
      <label>ØªÚ¯:</label>
      <input type="text" id="editTag" />
      <label>ØªÛŒÙ…:</label>
      <input type="text" id="editTeam" readonly />
      <label>Ù…Ø­Ù„:</label>
      <div class="custom-select-container">
        <input type="text" id="editLocation" autocomplete="off" />
        <div class="custom-select-dropdown hidden" id="editLocationDropdown"></div>
        <span class="select-arrow" onclick="toggleLocationDropdown('edit')">â–¼</span>
      </div>
      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea id="editNotes" rows="2"></textarea>
      <div style="display:flex; gap:8px; margin-top:16px;">
        <button onclick="saveEdit()" style="flex:1;">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
        <button onclick="closeEditModal()" class="secondary" style="flex:1;">âŒ Ù„ØºÙˆ</button>
      </div>
    </div>
  </div>

  <div id="calcModal" class="modal hidden">
    <div class="modal-content">
      <h3>Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨</h3>
      <input type="text" id="calcDisplay" class="calc-display" inputmode="numeric" pattern="[0-9+\-*/().]*" 
             placeholder="12+5*(3-1)" />
      <div style="display:grid; grid-template-columns: repeat(4,1fr); gap:6px; margin-top:10px;">
        <button class="calc-btn" onclick="calcAppend('7')">7</button>
        <button class="calc-btn" onclick="calcAppend('8')">8</button>
        <button class="calc-btn" onclick="calcAppend('9')">9</button>
        <button class="calc-btn" onclick="calcAppend('/')">Ã·</button>
        <button class="calc-btn" onclick="calcAppend('4')">4</button>
        <button class="calc-btn" onclick="calcAppend('5')">5</button>
        <button class="calc-btn" onclick="calcAppend('6')">6</button>
        <button class="calc-btn" onclick="calcAppend('*')">Ã—</button>
        <button class="calc-btn" onclick="calcAppend('1')">1</button>
        <button class="calc-btn" onclick="calcAppend('2')">2</button>
        <button class="calc-btn" onclick="calcAppend('3')">3</button>
        <button class="calc-btn" onclick="calcAppend('-')">âˆ’</button>
        <button class="calc-btn" onclick="calcAppend('0')">0</button>
        <button class="calc-btn" onclick="calcAppend('(')">(</button>
        <button class="calc-btn" onclick="calcAppend(')')">)</button>
        <button class="calc-btn" onclick="calcAppend('+')">+</button>
        <button class="calc-btn" onclick="calcAppend('.')">.</button>
        <button class="calc-btn" style="background:#ffc107;color:#000;" onclick="calcClear()">C</button>
        <button class="calc-btn" style="background:#2196f3;color:white;" onclick="calcApply()">=</button>
        <button class="calc-btn" onclick="calcBackspace()">âŒ«</button>
      </div>
      <button class="calc-btn calc-apply" onclick="calcApply()">âœ… Ø§Ø¹Ù…Ø§Ù„ Ù†ØªÛŒØ¬Ù‡</button>
      <button class="secondary" style="width:100%; margin-top:10px; padding:14px; font-size:18px;" 
              onclick="closeCalcModal()">âŒ Ù„ØºÙˆ</button>
    </div>
  </div>

  <script>
    // âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ø§Ø² localStorage)
    let settings = JSON.parse(localStorage.getItem('appSettings')) || {
      userName: 'Ú©Ø§Ø±Ø¨Ø±',
      teamName: '',
      defaultLocation: '',
      minLength: 14,
      maxLength: 20,
      searchByTag: false,
      scriptUrl: ''
    };

    let items = JSON.parse(localStorage.getItem('items')) || [];
    let currentEditIndex = -1;
    let currentDropdown = null;
    let LAST_SCAN_METHOD = localStorage.getItem('scanner') || 'camera';
    let barcodeDetector = null;
    let videoStream = null;
    let scanInterval = null;
    let lastScannedValue = '';
    let stableScanCount = 0;
    let zoomLevel = 1.0;

    document.addEventListener('DOMContentLoaded', () => {
      // ØªØ¨â€ŒÙ‡Ø§
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
      });

      // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
      if (!settings.defaultLocation) {
        settings.defaultLocation = 'Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ';
      }
      document.getElementById('settingUserName').value = settings.userName;
      document.getElementById('settingTeamName').value = settings.teamName;
      document.getElementById('settingDefaultLocation').value = settings.defaultLocation;
      document.getElementById('settingMinLength').value = settings.minLength;
      document.getElementById('settingMaxLength').value = settings.maxLength;
      document.getElementById('searchByTag').checked = settings.searchByTag;
      document.getElementById('settingScriptUrl').value = settings.scriptUrl;

      document.getElementById('searchByTag').addEventListener('change', function() {
        settings.searchByTag = this.checked;
        updateSearchUI();
      });

      document.getElementById('globalLocationDisplay').textContent = settings.defaultLocation;
      updateSearchUI();
    });

    function updateSearchUI() {
      const searchByTag = settings.searchByTag;
      const input = document.getElementById('searchInput');
      const scanContainer = document.getElementById('scanButtonContainer');
      if (searchByTag) {
        input.placeholder = "ØªÚ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: T-001)";
        scanContainer.style.display = 'none';
      } else {
        input.placeholder = "Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯";
        scanContainer.style.display = 'flex';
      }
    }

    // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    // ğŸ”Œ ØªØ³Øª Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ú¯ÙˆÚ¯Ù„ Ø§Ù¾Ø³ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª (no-cors)
    function testScriptConnection() {
      const url = document.getElementById('settingScriptUrl').value.trim();
      const statusEl = document.getElementById('scriptStatus');

      if (!url) {
        statusEl.textContent = 'âŒ URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
        statusEl.className = 'status-box status-error';
        return;
      }

      if (!url.includes('/exec')) {
        statusEl.textContent = 'âš ï¸ URL Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Â«/execÂ» ØªÙ…Ø§Ù… Ø´ÙˆØ¯.';
        statusEl.className = 'status-box status-warn';
        return;
      }

      statusEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€¦';
      statusEl.className = 'status-box status-warn';

      // ØªØ³Øª GET Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø® (Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ CORS)
      fetch(url + '?test=1&action=test', {
        method: 'GET',
        mode: 'no-cors', // âœ… Ú©Ù„ÛŒØ¯ Ù…ÙˆÙÙ‚ÛŒØª â€” Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        cache: 'no-cache'
      })
      .then(() => {
        // Ø¨Ø§ no-cors ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ù‡Ø±Ú¯Ø² reject Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ â€” Ù¾Ø³ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
        statusEl.textContent = 'âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. Ø§Ú¯Ø± Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯ØŒ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.';
        statusEl.className = 'status-box status-ok';
      })
      .catch(err => {
        statusEl.textContent = 'âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: ' + (err.message || 'Ù†Ø§Ù…Ø´Ø®Øµ');
        statusEl.className = 'status-box status-warn';
      });
    }

    // ğŸ› ï¸ Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
    function saveSettings() {
      const user = document.getElementById('settingUserName').value.trim() || 'Ú©Ø§Ø±Ø¨Ø±';
      const team = document.getElementById('settingTeamName').value.trim();
      let loc = document.getElementById('settingDefaultLocation').value.trim();
      if (!loc) loc = 'Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ';
      const min = parseInt(document.getElementById('settingMinLength').value) || 14;
      const max = parseInt(document.getElementById('settingMaxLength').value) || 20;
      const searchByTag = document.getElementById('searchByTag').checked;
      const scriptUrl = document.getElementById('settingScriptUrl').value.trim();

      if (min > max) return alert('âš ï¸ Ø­Ø¯Ø§Ù‚Ù„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø­Ø¯Ø§Ú©Ø«Ø± Ø¨Ø§Ø´Ø¯.');

      settings = { 
        userName: user, 
        teamName: team, 
        defaultLocation: loc, 
        minLength: min, 
        maxLength: max, 
        searchByTag,
        scriptUrl
      };

      localStorage.setItem('appSettings', JSON.stringify(settings));
      document.getElementById('globalLocationDisplay').textContent = loc;
      updateSearchUI();
      alert('âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
    }

    // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    // ğŸ“¸ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ùˆ Ø§Ø³Ú©Ù† (Ú©Ø¯Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
    async function applyZoom(level) {
      zoomLevel = Math.max(1.0, Math.min(3.0, level));
      document.getElementById('hintZoom').textContent = `ğŸ” Ø²ÙˆÙ…: Ã—${zoomLevel.toFixed(1)}`;
      if (!videoStream) return;
      const track = videoStream.getVideoTracks()[0];
      if (track && track.applyConstraints) {
        try { await track.applyConstraints({ advanced: [{ zoom: zoomLevel }] }); } catch (e) {}
      }
    }
    function zoomIn() { applyZoom(zoomLevel + 0.3); }
    function zoomOut() { applyZoom(zoomLevel - 0.3); }
    function resetZoom() { applyZoom(1.0); }

    const SCANNERS = [
      { id: 'camera', name: 'ğŸ“¸ Ø§Ø³Ú©Ù† Ø¨Ø§ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø§Ø®Ù„ÛŒ' },
      { id: 'gamma', name: 'Gamma Barcode Scanner',
        intent: 'intent://scan/#Intent;scheme=scan;package=com.gamma.scan;end;' },
      { id: 'zxing', name: 'ZXing Barcode Scanner',
        intent: 'intent://scan/#Intent;scheme=zxing;package=com.google.zxing.client.android;end;' }
    ];
    function changeScanner() {
      let msg = 'Ø±ÙˆØ´ Ø§Ø³Ú©Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\n';
      SCANNERS.forEach((s, i) => msg += `${i+1}. ${s.name}\n`);
      msg += '\nØ´Ù…Ø§Ø±Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: 1):';
      const choice = prompt(msg, '1');
      const idx = Math.max(0, parseInt(choice) - 1);
      const sel = SCANNERS[idx] || SCANNERS[0];
      LAST_SCAN_METHOD = sel.id;
      localStorage.setItem('scanner', sel.id);
      alert(`âœ… Ø§Ø³Ú©Ù†Ø±: ${sel.name}`);
    }
    function launchExternalScanner(id) {
      const s = SCANNERS.find(x => x.id === id);
      if (s && s.intent) {
        const w = window.open(s.intent, '_self');
        if (!w) alert(`âŒ Â«${s.name}Â» Ù†ØµØ¨ Ù†ÛŒØ³Øª. Ø§Ø² Ø§Ø³Ú©Ù† Ø¯Ø§Ø®Ù„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.`);
      }
    }
    function startScan() {
      if (settings.searchByTag) {
        alert('âš ï¸ Ø¯Ø± Ø­Ø§Ù„Øª Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÚ¯ØŒ Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª.');
        return;
      }
      if (LAST_SCAN_METHOD === 'camera') {
        startCameraScan();
      } else {
        launchExternalScanner(LAST_SCAN_METHOD);
      }
    }
    async function startCameraScan() {
      if (!("BarcodeDetector" in window)) {
        alert("âŒ Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Ø§Ø³Ú©Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø§Ø² Chrome Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.");
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } }
        });
        videoStream = stream;
        const video = document.getElementById('cameraVideo');
        video.srcObject = stream;
        barcodeDetector = new BarcodeDetector({ formats: ['qr_code','ean_13','code_128','code_39'] });
        document.getElementById('cameraModal').classList.remove('hidden');
        video.play();
        applyZoom(1.0);
        scanInterval = setInterval(async () => {
          if (!barcodeDetector || !video.srcObject || video.paused) return;
          try {
            const barcodes = await barcodeDetector.detect(video);
            if (barcodes.length === 0) {
              stableScanCount = 0;
              return;
            }
            const b = barcodes[0];
            const value = (b.rawValue || '').trim();
            if (!value || value.length < settings.minLength || value.length > settings.maxLength) {
              stableScanCount = 0;
              return;
            }
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            const box = b.boundingBox || {};
            const x = box.x || 0, y = box.y || 0, w = box.width || 0, h = box.height || 0;
            const centerX = x + w/2;
            const centerY = y + h/2;
            const inVerticalZone = centerY > vh * 0.3 && centerY < vh * 0.7;
            const inHorizontalZone = Math.abs(centerX - vw/2) < vw * 0.2;
            const minWidth = vw * 0.2;
            if (!inVerticalZone || !inHorizontalZone || w < minWidth) {
              stableScanCount = 0;
              return;
            }
            if (value === lastScannedValue) {
              stableScanCount++;
            } else {
              lastScannedValue = value;
              stableScanCount = 1;
            }
            if (stableScanCount >= 2) {
              clearInterval(scanInterval);
              scanInterval = null;
              stopCamera();
              document.getElementById('searchInput').value = value;
              setTimeout(searchOrAdd, 150);
            }
          } catch (e) {}
        }, 200);
      } catch (err) {
        alert("âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø¯ Ø´Ø¯.");
      }
    }
    function stopCamera() {
      const modal = document.getElementById('cameraModal');
      modal.classList.add('hidden');
      if (scanInterval) clearInterval(scanInterval);
      if (videoStream) videoStream.getTracks().forEach(t => t.stop());
      videoStream = null;
      barcodeDetector = null;
      const v = document.getElementById('cameraVideo');
      if (v.srcObject) v.srcObject.getTracks().forEach(t => t.stop());
      v.srcObject = null;
      lastScannedValue = '';
      stableScanCount = 0;
    }

    // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    // âœï¸ Ø¹Ù…Ù„ÛŒØ§Øª Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± â€” ÙÙ‚Ø· Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage)
    function searchOrAdd() {
      const query = document.getElementById('searchInput').value.trim();
      const loc = settings.defaultLocation;
      if (!query) return alert('Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
      if (settings.searchByTag) {
        const idx = items.findIndex(r => r[6] === query && r[8] === loc);
        if (idx !== -1) {
          openEditModal(idx);
        } else {
          alert('âš ï¸ Ø¯Ø± Ø­Ø§Ù„Øª Â«Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÚ¯Â»ØŒ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª. Ú©Ø§Ù„Ø§ÛŒÛŒ Ø¨Ø§ Ø§ÛŒÙ† ØªÚ¯ ÛŒØ§ÙØª Ù†Ø´Ø¯.');
          return;
        }
      } else {
        if (query.length < settings.minLength || query.length > settings.maxLength) {
          alert(`âŒ Ø·ÙˆÙ„ Ø¨Ø§Ø±Ú©Ø¯ (${query.length}) Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ (${settings.minLength}â€“${settings.maxLength}) Ø§Ø³Øª.`);
          return;
        }
        const idx = items.findIndex(r => r[0] === query && r[8] === loc);
        if (idx !== -1) openEditModal(idx);
        else openAddModal(query, loc);
      }
    }

    function openAddModal(bc, loc, tag = '') {
      const existing = items.find(r => r[0] === bc);
      const stock = existing ? parseFloat(existing[9]) || 0 : 0;
      document.getElementById('addBarcode').value = bc;
      document.getElementById('addLocation').value = loc;
      document.getElementById('addStock').value = stock;
      document.getElementById('addCount1').value = stock;
      document.getElementById('addCount2').value = '';
      document.getElementById('addTag').value = tag;
      document.getElementById('addTeam').value = settings.teamName;
      document.getElementById('addNotes').value = '';
      updateDiscrepancyAdd();
      document.getElementById('addModal').classList.remove('hidden');
    }

    function saveAdd() {
      const bc = document.getElementById('addBarcode').value.trim();
      const name = document.getElementById('addName').value.trim();
      const stock = parseFloat(document.getElementById('addStock').value) || 0;
      const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
      const c2Raw = document.getElementById('addCount2').value;
      const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;
      const disc1 = (c1 - stock).toFixed(2);
      const disc2 = calculateDiscrepancy2(stock, c2Raw, disc1);
      const newRow = [
        bc, name, c1, disc1, c2, disc2,
        document.getElementById('addTag').value.trim(),
        settings.teamName,
        document.getElementById('addLocation').value.trim(),
        stock,
        document.getElementById('addNotes').value.trim(),
        getNowFa(),
        settings.userName
      ];
      items.push(newRow);
      localStorage.setItem('items', JSON.stringify(items));
      closeAddModal();
      document.getElementById('searchInput').value = '';
      alert('âœ… Ú©Ø§Ù„Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.');
    }

    function openEditModal(idx) {
      currentEditIndex = idx;
      const r = items[idx];
      document.getElementById('editBarcode').value = r[0];
      document.getElementById('editName').value = r[1] || '';
      document.getElementById('editStock').value = r[9] || 0;
      document.getElementById('editCount1').value = r[2] || '';
      document.getElementById('editCount2').value = r[4] != null ? r[4] : '';
      document.getElementById('editTag').value = r[6] || '';
      document.getElementById('editTeam').value = settings.teamName;
      document.getElementById('editLocation').value = r[8] || '';
      document.getElementById('editNotes').value = r[10] || '';
      updateDiscrepancyEdit();
      document.getElementById('editModal').classList.remove('hidden');
    }

    function saveEdit() {
      if (currentEditIndex < 0) return;
      const r = [...items[currentEditIndex]];
      const stock = parseFloat(document.getElementById('editStock').value) || 0;
      const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
      const c2Raw = document.getElementById('editCount2').value;
      const c2 = c2Raw !== '' ? parseFloat(c2Raw) || 0 : 0;
      r[1] = document.getElementById('editName').value.trim();
      r[2] = c1;
      r[4] = c2;
      r[6] = document.getElementById('editTag').value.trim();
      r[7] = settings.teamName;
      r[8] = document.getElementById('editLocation').value.trim();
      r[10] = document.getElementById('editNotes').value.trim();
      r[9] = stock;
      r[11] = getNowFa();
      r[12] = settings.userName;
      r[3] = (c1 - stock).toFixed(2);
      r[5] = calculateDiscrepancy2(stock, c2Raw, r[3]);
      items[currentEditIndex] = r;
      localStorage.setItem('items', JSON.stringify(items));
      closeEditModal();
      document.getElementById('searchInput').value = '';
      alert('âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
    }

    // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    // Ú©Ù…Ú©ÛŒâ€ŒÙ‡Ø§
    function getNowFa() {
      return new Intl.DateTimeFormat('fa-IR', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      }).format(new Date()).replace(/ØŒ/g, ' ');
    }

    function calculateDiscrepancy2(stock, count2Str, discrepancy1) {
      if (parseFloat(discrepancy1) === 0) {
        const c2 = count2Str !== '' ? parseFloat(count2Str) : null;
        if (c2 === null || c2 === 0) return "0.00";
      }
      const c2 = count2Str !== '' ? parseFloat(count2Str) || 0 : 0;
      return (c2 - stock).toFixed(2);
    }

    function updateDiscrepancyAdd() {
      const stock = parseFloat(document.getElementById('addStock').value) || 0;
      const c1 = parseFloat(document.getElementById('addCount1').value) || 0;
      const c2 = document.getElementById('addCount2').value;
      const disc1 = (c1 - stock).toFixed(2);
      document.getElementById('addDisc1').textContent = disc1;
      const disc2 = calculateDiscrepancy2(stock, c2, disc1);
      document.getElementById('addDisc2').textContent = disc2;
    }

    function updateDiscrepancyEdit() {
      const stock = parseFloat(document.getElementById('editStock').value) || 0;
      const c1 = parseFloat(document.getElementById('editCount1').value) || 0;
      const c2 = document.getElementById('editCount2').value;
      const disc1 = (c1 - stock).toFixed(2);
      document.getElementById('editDisc1').textContent = disc1;
      const disc2 = calculateDiscrepancy2(stock, c2, disc1);
      document.getElementById('editDisc2').textContent = disc2;
    }

    // ğŸ§® Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨
    let CURRENT_CALC_TARGET = null;
    function openCalc(id) { 
      CURRENT_CALC_TARGET = id; 
      document.getElementById('calcDisplay').value = ''; 
      document.getElementById('calcModal').classList.remove('hidden'); 
    }
    function calcAppend(c) { document.getElementById('calcDisplay').value += c; }
    function calcBackspace() { const e = document.getElementById('calcDisplay'); e.value = e.value.slice(0, -1); }
    function calcClear() { document.getElementById('calcDisplay').value = ''; }
    function calcApply() {
      const expr = document.getElementById('calcDisplay').value;
      if (!expr.trim()) return alert('Ø¹Ø¨Ø§Ø±ØªÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
      const safe = expr.replace(/[^0-9+\-*/().\sÃ·Ã—]/g, '').replace(/Ã·/g, '/').replace(/Ã—/g, '*');
      try {
        const r = new Function('return (' + safe + ')')();
        if (isNaN(r) || !isFinite(r)) throw '';
        const t = document.getElementById(CURRENT_CALC_TARGET);
        t.value = parseFloat(r).toFixed(2);
        if (CURRENT_CALC_TARGET.startsWith('add')) updateDiscrepancyAdd();
        else if (CURRENT_CALC_TARGET.startsWith('edit')) updateDiscrepancyEdit();
        closeCalcModal();
      } catch (e) { 
        alert('Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.'); 
      }
    }
    function closeCalcModal() { 
      document.getElementById('calcModal').classList.add('hidden'); 
      CURRENT_CALC_TARGET = null; 
    }

    // ğŸ“ Ù…Ø­Ù„â€ŒÙ‡Ø§
    function getLocations() {
      const set = new Set();
      items.forEach(r => { const loc = (r[8] || '').trim(); if (loc) set.add(loc); });
      if (settings.defaultLocation) set.add(settings.defaultLocation);
      return Array.from(set).sort();
    }
    function renderDropdown(id, locations) {
      const el = document.getElementById(id);
      if (!el) return;
      el.innerHTML = locations.length 
        ? locations.map(l => `<div class="custom-select-option" onclick="selectLocation('${l.replace(/'/g,"\\'")}','${id}')">${l}</div>`).join('')
        : '<div class="custom-select-option" style="color:#999;">Ù…Ø­Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
    }
    function toggleLocationDropdown(context) {
      hideAllDropdowns();
      const map = {
        add:  { dropdown: 'addLocationDropdown', input: 'addLocation' },
        edit: { dropdown: 'editLocationDropdown', input: 'editLocation' },
        settings: { dropdown: 'settingsLocationDropdown', input: 'settingDefaultLocation' }
      };
      const conf = map[context];
      if (!conf) return;
      const { dropdown, input } = conf;
      const el = document.getElementById(dropdown);
      const inp = document.getElementById(input);
      if (el && el.classList.contains('hidden')) {
        renderDropdown(dropdown, getLocations());
        el.classList.remove('hidden');
        currentDropdown = context;
        if (inp && !inp.hasBlurListener) {
          inp.addEventListener('blur', function() {
            setTimeout(hideAllDropdowns, 150);
          });
          inp.hasBlurListener = true;
        }
        inp.focus();
      }
    }
    function hideAllDropdowns() {
      ['locationDropdown','addLocationDropdown','editLocationDropdown','settingsLocationDropdown'].forEach(id=>{
        const e=document.getElementById(id); if(e) e.classList.add('hidden');
      });
      currentDropdown = null;
    }
    function selectLocation(loc, dropdownId) {
      const map = {
        'addLocationDropdown': 'addLocation',
        'editLocationDropdown': 'editLocation',
        'settingsLocationDropdown': 'settingDefaultLocation'
      };
      const inputId = map[dropdownId] || dropdownId.replace('Dropdown', '');
      document.getElementById(inputId).value = loc;
      hideAllDropdowns();
    }

    // âœ–ï¸ Ø¨Ø³ØªÙ† Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§
    function closeAddModal() { document.getElementById('addModal').classList.add('hidden'); }
    function closeEditModal() { 
      document.getElementById('editModal').classList.add('hidden');
      currentEditIndex = -1; 
    }

    console.log('âœ… Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ â€” Ø¨Ø¯ÙˆÙ† Ø¬Ø¯ÙˆÙ„ØŒ Ø¨Ø¯ÙˆÙ† Ú¯Ø²Ø§Ø±Ø´Ø§ØªØŒ Ø¨Ø¯ÙˆÙ† import/exportØŒ Ø¨Ø§ ØªØ³Øª Ø§Ø±ØªØ¨Ø§Ø·');
  </script>
</body>
</html>
